<% groups = sidebar_feature_groups %>

<div data-controller="sidebar">
  <%# Mobile hamburger button %>
  <button
    data-action="click->sidebar#toggle"
    class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-[#f4f4f0] border border-black/5 rounded-lg shadow-[inset_1px_1px_0_rgba(255,255,255,1),inset_-1px_-1px_0_rgba(0,0,0,0.05),0_4px_8px_rgba(0,0,0,0.05)]"
    aria-label="Toggle navigation"
  >
    <svg class="size-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>

  <%# Backdrop %>
  <div
    data-sidebar-target="backdrop"
    data-action="click->sidebar#close"
    class="hidden fixed inset-0 bg-black/30 z-30 lg:hidden"
  ></div>

  <%# Sidebar %>
  <aside
    data-sidebar-target="sidebar"
    class="fixed lg:sticky top-0 left-0 z-40 h-screen w-60 bg-[#f4f4f0] border-r border-black/10 flex flex-col -translate-x-full lg:translate-x-0 transition-transform duration-200"
  >
    <%# Logo + shop name %>
    <div class="px-5 py-5 border-b border-black/5">
      <%= link_to admin_dashboard_path, class: "flex items-center gap-2.5" do %>
        <img src="/refrral-app-icon-large.png" alt="Happypages" class="size-8 rounded-lg">
        <span class="text-base font-semibold text-gray-900">happypages</span>
      <% end %>
      <% if Current.shop %>
        <p class="mt-1 text-xs text-gray-400 truncate"><%= Current.shop.name %></p>
      <% end %>
    </div>

    <%# Navigation %>
    <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto" data-controller="sidebar-collapse">
      <%# Home %>
      <%= link_to admin_dashboard_path, class: "flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors #{request.path == '/admin' || request.path == '/admin/' ? 'bg-white border-l-2 border-[#ff584d] text-[#ff584d] shadow-sm' : 'text-gray-600 hover:bg-white/60 hover:text-gray-900'}" do %>
        <svg class="size-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"></path>
        </svg>
        Home
      <% end %>

      <%# Divider before active features %>
      <% if groups[:active].any? %>
        <div class="pt-3 pb-1">
          <div class="border-t border-black/5"></div>
        </div>

        <%# Active features — collapsible groups %>
        <% groups[:active].each do |feature| %>
          <div data-sidebar-collapse-target="group" data-feature="<%= feature[:key] %>">
            <%# Group header with chevron %>
            <button
              data-action="click->sidebar-collapse#toggle"
              class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-xs font-semibold text-gray-400 uppercase tracking-wider hover:text-gray-600 transition-colors"
            >
              <span><%= feature[:label] %></span>
              <svg data-sidebar-collapse-target="chevron" class="size-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
              </svg>
            </button>

            <%# Sub-nav items %>
            <div data-sidebar-collapse-target="content" class="space-y-0.5">
              <% feature[:items]&.each do |item| %>
                <% item_path = send(item[:path]) %>
                <% active = request.path == item_path || request.path.start_with?(item_path.chomp('/')) %>
                <%= link_to item_path, class: "flex items-center gap-3 pl-6 pr-3 py-1.5 rounded-lg text-sm font-medium transition-colors #{active ? 'bg-white border-l-2 border-[#ff584d] text-[#ff584d] shadow-sm' : 'text-gray-600 hover:bg-white/60 hover:text-gray-900'}" do %>
                  <%= item[:label] %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>

      <%# Divider before locked features %>
      <% if groups[:locked].any? %>
        <div class="pt-3 pb-1">
          <div class="border-t border-black/5"></div>
        </div>

        <%# Locked features — single line with lock icon %>
        <% groups[:locked].each do |feature| %>
          <%= link_to admin_feature_path(feature[:key]), class: "flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-gray-400 opacity-60 hover:opacity-80 transition-opacity" do %>
            <svg class="size-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"></path>
            </svg>
            <%= feature[:label] %>
          <% end %>
        <% end %>
      <% end %>

      <%# Divider before settings %>
      <div class="pt-3 pb-1">
        <div class="border-t border-black/5"></div>
      </div>

      <%# Integrations %>
      <%= link_to edit_admin_integrations_path, class: "flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors #{request.path.start_with?('/admin/integrations') ? 'bg-white border-l-2 border-[#ff584d] text-[#ff584d] shadow-sm' : 'text-gray-600 hover:bg-white/60 hover:text-gray-900'}" do %>
        <svg class="size-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 01-.657.643 48.39 48.39 0 01-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 01-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 00-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 01-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 00.657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 01-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.4.604-.4.959v0c0 .333.277.599.61.58a48.1 48.1 0 005.427-.63 48.05 48.05 0 00.582-4.717.532.532 0 00-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.96.401v0a.656.656 0 00.658-.663 48.422 48.422 0 00-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 01-.61-.58v0z"></path>
        </svg>
        Integrations
      <% end %>

      <%# Settings %>
      <%= link_to edit_admin_settings_path, class: "flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors #{request.path.start_with?('/admin/settings') ? 'bg-white border-l-2 border-[#ff584d] text-[#ff584d] shadow-sm' : 'text-gray-600 hover:bg-white/60 hover:text-gray-900'}" do %>
        <svg class="size-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        Settings
      <% end %>
    </nav>

    <%# Footer: notifications + domain + logout %>
    <% if defined?(current_user) && current_user %>
      <div class="px-4 py-4 border-t border-black/5" data-controller="notification-bell" data-notification-bell-url-value="<%= admin_notifications_path(format: :json) %>">
        <div class="flex items-center justify-between mb-2">
          <p class="text-xs text-gray-500 truncate"><%= Current.shop&.domain || current_user.email %></p>
          <%= link_to admin_notifications_path, class: "relative p-1 text-gray-400 hover:text-gray-600 transition-colors" do %>
            <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"></path>
            </svg>
            <span data-notification-bell-target="badge" class="hidden absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-[10px] font-bold leading-none text-white bg-[#ff584d] rounded-full"></span>
          <% end %>
        </div>
        <%= button_to "Logout", logout_path, method: :delete, class: "text-xs text-gray-400 hover:text-gray-600 transition-colors cursor-pointer" %>
      </div>
    <% end %>
  </aside>
</div>
