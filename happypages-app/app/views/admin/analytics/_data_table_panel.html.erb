<%# Locals: title, columns (array of {label, key, align}), rows (array of hashes), filter_key (string), show_bar (bool) %>
<% show_bar ||= false %>
<% max_value = rows.present? ? rows.map { |r| r[columns.first[:key]&.to_sym] || r[columns.last[:key]&.to_sym] || 0 }.max : 0 %>

<div class="bg-white rounded-xl shadow-sm overflow-hidden">
  <div class="px-4 py-3 border-b border-gray-100">
    <h3 class="text-sm font-semibold text-gray-900"><%= title %></h3>
  </div>

  <% if rows.blank? %>
    <div class="px-4 py-8 text-center text-sm text-gray-400">No data for this period</div>
  <% else %>
    <div class="overflow-x-auto">
      <table class="w-full text-sm" style="font-family: Inter, system-ui, sans-serif">
        <thead>
          <tr class="border-b border-gray-50">
            <% columns.each do |col| %>
              <th class="px-4 py-2 text-xs font-medium text-gray-400 uppercase tracking-wide <%= col[:align] == 'right' ? 'text-right' : 'text-left' %>">
                <%= col[:label] %>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% rows.each do |row| %>
            <tr
              class="border-b border-gray-50 last:border-0 hover:bg-gray-50/50 transition-colors <%= filter_key ? 'cursor-pointer' : '' %>"
              <% if filter_key %>
                data-action="click->analytics-filter#addFilter"
                data-filter-key="<%= filter_key %>"
                data-filter-value="<%= row[columns.first[:key]&.to_sym] %>"
              <% end %>
            >
              <% columns.each_with_index do |col, i| %>
                <td class="px-4 py-2 tabular-nums <%= col[:align] == 'right' ? 'text-right' : '' %> <%= i == 0 ? 'font-medium text-gray-900' : 'text-gray-600' %>">
                  <% val = row[col[:key]&.to_sym] %>
                  <% if col[:format] == "currency" %>
                    <%= format_analytics_currency(val || 0) %>
                  <% elsif col[:format] == "percent" %>
                    <%= val %>%
                  <% elsif col[:format] == "number" %>
                    <%= number_with_delimiter(val) %>
                  <% else %>
                    <%= val %>
                  <% end %>

                  <% if show_bar && i == columns.size - 1 && max_value > 0 %>
                    <div class="mt-1 h-0.5 rounded-full bg-[#0072B2]/20" style="width: <%= [(val.to_f / max_value * 100).round, 100].min %>%"></div>
                  <% end %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</div>
