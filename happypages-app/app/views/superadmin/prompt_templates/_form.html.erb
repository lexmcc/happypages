<%= form_with(model: [:superadmin, prompt_template], class: "space-y-6") do |f| %>
  <% if prompt_template.errors.any? %>
    <div class="px-4 py-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
      <ul class="list-disc pl-4 space-y-1">
        <% prompt_template.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <%# Main form %>
    <div class="lg:col-span-2 space-y-5">
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-5">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Key</label>
          <%= f.text_field :key, placeholder: "food_referral_banner",
              class: "block w-full rounded-lg border-gray-300 shadow-sm text-sm font-mono focus:border-slate-500 focus:ring-slate-500" %>
          <p class="text-xs text-gray-400 mt-1">Unique identifier — e.g. <code>food_referral_banner</code>, <code>default_quality_review</code></p>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Surface</label>
            <%= f.select :surface, PromptTemplate::SURFACES.map { |s| [s.humanize, s] },
                { prompt: "Select surface" },
                class: "block w-full rounded-lg border-gray-300 shadow-sm text-sm focus:border-slate-500 focus:ring-slate-500" %>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <%= f.select :category, SceneAsset::CATEGORIES.map { |c| [c.capitalize, c] },
                { include_blank: "Universal (all categories)" },
                class: "block w-full rounded-lg border-gray-300 shadow-sm text-sm focus:border-slate-500 focus:ring-slate-500" %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Template Text</label>
          <%= f.text_area :template_text, rows: 16,
              class: "block w-full rounded-lg border-gray-300 shadow-sm text-sm font-mono focus:border-slate-500 focus:ring-slate-500" %>
        </div>

        <div class="flex items-center gap-2">
          <%= f.check_box :active, class: "rounded border-gray-300 text-slate-900 focus:ring-slate-500" %>
          <%= f.label :active, "Active", class: "text-sm text-gray-700" %>
        </div>
      </div>
    </div>

    <%# Sidebar — variable reference %>
    <div class="space-y-5">
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Available Variables</h3>
        <p class="text-xs text-gray-500 mb-3">Use <code class="bg-gray-100 px-1 rounded">{variable}</code> syntax in template text</p>
        <div class="space-y-1.5">
          <% PromptTemplate::VARIABLES.each do |var| %>
            <div class="flex items-center gap-2">
              <code class="text-xs bg-gray-50 text-gray-700 px-1.5 py-0.5 rounded border border-gray-100 font-mono">{<%= var %>}</code>
            </div>
          <% end %>
        </div>
      </div>

      <% if prompt_template.persisted? %>
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5" data-controller="prompt-test">
          <h3 class="text-sm font-semibold text-gray-900 mb-3">Test Playground</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">Test against shop</label>
              <select data-prompt-test-target="shopSelect" class="block w-full rounded-lg border-gray-300 shadow-sm text-sm focus:border-slate-500 focus:ring-slate-500">
                <option value="">Select a shop...</option>
                <% Shop.active.where.not(brand_profile: {}).order(:name).each do |shop| %>
                  <option value="<%= shop.id %>"><%= shop.name %> (<%= shop.brand_category || "unknown" %>)</option>
                <% end %>
              </select>
            </div>
            <button
              data-action="click->prompt-test#run"
              data-prompt-test-target="runBtn"
              data-url="<%= test_generate_superadmin_prompt_template_path(prompt_template) %>"
              class="w-full px-3 py-2 bg-slate-900 text-white rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors disabled:opacity-50"
            >
              Test Generate
            </button>
            <div data-prompt-test-target="result" class="hidden">
              <div data-prompt-test-target="loading" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-slate-900 border-t-transparent"></div>
                <p class="text-sm text-gray-500 mt-2">Generating...</p>
              </div>
              <div data-prompt-test-target="output" class="space-y-3"></div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="flex items-center gap-3">
    <%= f.submit prompt_template.persisted? ? "Update template" : "Create template",
        class: "px-4 py-2 bg-slate-900 text-white rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors cursor-pointer" %>
    <%= link_to "Cancel", superadmin_prompt_templates_path,
        class: "px-4 py-2 text-gray-600 text-sm font-medium hover:text-gray-800" %>
  </div>
<% end %>
