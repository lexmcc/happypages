<%= render "admin/analytics/control_bar", show_site_picker: true, sites: @sites %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 py-6 space-y-6" data-controller="analytics-filter">

  <%# KPI cards %>
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
    <%= render "admin/analytics/kpi_card",
      label: "Visitors",
      value: @data[:kpis][:visitors][:value],
      format: :number,
      change_pct: @data[:kpis][:visitors][:change_pct],
      metric_key: "visitors",
      sparkline_data: @data[:sparklines][:visitors],
      color: "#0072B2",
      active: @metric == "visitors" %>

    <%= render "admin/analytics/kpi_card",
      label: "Pageviews",
      value: @data[:kpis][:pageviews][:value],
      format: :number,
      change_pct: @data[:kpis][:pageviews][:change_pct],
      metric_key: "pageviews",
      sparkline_data: @data[:sparklines][:pageviews],
      color: "#E69F00",
      active: @metric == "pageviews" %>

    <%= render "admin/analytics/kpi_card",
      label: "Bounce Rate",
      value: @data[:kpis][:bounce_rate][:value],
      format: :percent,
      change_pct: @data[:kpis][:bounce_rate][:change_pct],
      metric_key: "visitors",
      sparkline_data: nil,
      color: "#6b7280" %>

    <%= render "admin/analytics/kpi_card",
      label: "Revenue",
      value: @data[:kpis][:revenue][:value],
      format: :currency,
      change_pct: @data[:kpis][:revenue][:change_pct],
      metric_key: "revenue",
      sparkline_data: @data[:sparklines][:revenue],
      color: "#009E73",
      active: @metric == "revenue" %>
  </div>

  <%# Time series chart %>
  <%= render "admin/analytics/time_series_chart" %>

  <%# Two-column data panels %>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <%= render "admin/analytics/data_table_panel",
      title: "Top Pages",
      columns: [
        { label: "Page", key: "pathname" },
        { label: "Visitors", key: "visitors", align: "right", format: "number" },
        { label: "Pageviews", key: "pageviews", align: "right", format: "number" }
      ],
      rows: @data[:top_pages],
      filter_key: "pathname",
      show_bar: true %>

    <%= render "admin/analytics/data_table_panel",
      title: "Referrers",
      columns: [
        { label: "Source", key: "domain" },
        { label: "Visitors", key: "visitors", align: "right", format: "number" }
      ],
      rows: @data[:referrers],
      filter_key: nil,
      show_bar: true %>

    <%= render "admin/analytics/data_table_panel",
      title: "Campaigns",
      columns: [
        { label: "Campaign", key: "campaign" },
        { label: "Source", key: "source" },
        { label: "Visitors", key: "visitors", align: "right", format: "number" }
      ],
      rows: @data[:utm_campaigns],
      filter_key: "utm_campaign" %>

    <%# Geography %>
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-100">
        <h3 class="text-sm font-semibold text-gray-900">Countries</h3>
      </div>
      <% if @data[:geography].blank? %>
        <div class="px-4 py-8 text-center text-sm text-gray-400">No data for this period</div>
      <% else %>
        <div class="overflow-x-auto">
          <table class="w-full text-sm" style="font-family: Inter, system-ui, sans-serif">
            <thead>
              <tr class="border-b border-gray-50">
                <th class="px-4 py-2 text-xs font-medium text-gray-400 uppercase tracking-wide text-left">Country</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-400 uppercase tracking-wide text-right">Visitors</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-400 uppercase tracking-wide text-right">%</th>
              </tr>
            </thead>
            <tbody>
              <% @data[:geography].each do |row| %>
                <tr
                  class="border-b border-gray-50 last:border-0 hover:bg-gray-50/50 transition-colors cursor-pointer"
                  data-action="click->analytics-filter#addFilter"
                  data-filter-key="country_code"
                  data-filter-value="<%= row[:country_code] %>"
                >
                  <td class="px-4 py-2 font-medium text-gray-900">
                    <%= country_flag(row[:country_code]) %> <%= country_name(row[:country_code]) %>
                  </td>
                  <td class="px-4 py-2 text-gray-600 text-right tabular-nums"><%= number_with_delimiter(row[:visitors]) %></td>
                  <td class="px-4 py-2 text-gray-600 text-right tabular-nums"><%= row[:pct] %>%</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>

    <%# Devices %>
    <div class="bg-white rounded-xl shadow-sm overflow-hidden" data-controller="tabs">
      <div class="px-4 py-3 border-b border-gray-100 flex items-center gap-4">
        <h3 class="text-sm font-semibold text-gray-900">Devices</h3>
        <div class="flex gap-1 ml-auto">
          <% ["Browsers", "OS", "Device Type"].each_with_index do |tab_label, i| %>
            <button
              data-action="click->tabs#switch"
              data-index="<%= i %>"
              class="px-2 py-0.5 text-xs font-medium rounded transition-colors"
              data-tabs-target="tab"
            >
              <%= tab_label %>
            </button>
          <% end %>
        </div>
      </div>

      <% [:browsers, :os, :device_types].each_with_index do |key, i| %>
        <div data-tabs-target="panel" class="<%= i == 0 ? '' : 'hidden' %>">
          <% rows = @data[:devices][key] || [] %>
          <% if rows.blank? %>
            <div class="px-4 py-8 text-center text-sm text-gray-400">No data for this period</div>
          <% else %>
            <table class="w-full text-sm" style="font-family: Inter, system-ui, sans-serif">
              <tbody>
                <% filter_key_for_device = { browsers: "browser", os: "os", device_types: "device_type" }[key] %>
                <% max_val = rows.map { |r| r[:visitors] }.max %>
                <% rows.each do |row| %>
                  <tr
                    class="border-b border-gray-50 last:border-0 hover:bg-gray-50/50 transition-colors cursor-pointer"
                    data-action="click->analytics-filter#addFilter"
                    data-filter-key="<%= filter_key_for_device %>"
                    data-filter-value="<%= row[:name] %>"
                  >
                    <td class="px-4 py-2 font-medium text-gray-900"><%= row[:name] %></td>
                    <td class="px-4 py-2 text-gray-600 text-right tabular-nums w-24">
                      <%= number_with_delimiter(row[:visitors]) %>
                      <div class="mt-1 h-0.5 rounded-full bg-[#0072B2]/20 ml-auto" style="width: <%= max_val > 0 ? [(row[:visitors].to_f / max_val * 100).round, 100].min : 0 %>%"></div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% end %>
        </div>
      <% end %>
    </div>

    <% if @data[:goals].present? %>
      <%= render "admin/analytics/data_table_panel",
        title: "Goals",
        columns: [
          { label: "Event", key: "event_name" },
          { label: "Triggers", key: "triggers", align: "right", format: "number" },
          { label: "Uniques", key: "unique_visitors", align: "right", format: "number" },
          { label: "Conv.", key: "conversion_rate", align: "right", format: "percent" }
        ],
        rows: @data[:goals],
        filter_key: nil %>
    <% end %>
  </div>

  <%# Full-width panels %>
  <%= render "admin/analytics/revenue_table" %>
  <%= render "admin/analytics/referral_performance" %>

</div>
