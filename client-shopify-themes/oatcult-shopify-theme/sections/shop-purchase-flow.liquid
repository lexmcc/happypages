{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
SHOP PURCHASE FLOW
----------------------------------------------------------------------------------------------------------------------

CRO-optimized product purchase page with:
- Flavor-first selection (IKEA/endowment effect)
- Adaptive size options based on flavor count
- Subscription-first design with 20% savings
- Direct-to-checkout (no cart)

{%- endcomment -%}

{%- comment -%} Collect all product data from the breakfast collection {%- endcomment -%}
{%- assign products_data = '' -%}
{%- assign mixed_box_product = nil -%}
{%- assign individual_products = '' -%}

{%- for product in collections['breakfast'].products limit: 4 -%}
  {%- if product.title contains 'Mixed' -%}
    {%- assign mixed_box_product = product -%}
  {%- else -%}
    {%- if individual_products != '' -%}
      {%- assign individual_products = individual_products | append: ',' -%}
    {%- endif -%}
    {%- assign individual_products = individual_products | append: product.id -%}
  {%- endif -%}
{%- endfor -%}

<style>
  .shop-purchase-flow {
    /* Local variables - map to theme variables for consistency */
    --spf-text-color: rgb(var(--text-primary));
    --spf-text-muted: rgb(var(--text-primary) / 0.6);
    --spf-text-subtle: rgb(var(--text-primary) / 0.4);
    --spf-background: rgb(var(--background-primary));
    --spf-border-color: rgb(var(--text-primary) / 0.12);
    --spf-accent: rgb(var(--accent));
    --spf-success: rgb(var(--success-text));
    --spf-star-color: rgb(var(--star-color));
    /* Semantic colors for badges/CTA - keep brand-specific */
    --spf-cta-background: #93c5fd;
    --spf-cta-hover: #60a5fa;
    --spf-badge-popular: #fbbf24;
    --spf-badge-success: #22c55e;
    --spf-badge-hot: #ff6b35;
    --spf-badge-featured: #ec4899;
    /* Selector box styling */
    --spf-selector-bg: #F0E9DE;
    --spf-selector-border: #E3E1E1;
    --spf-selector-selected-bg: {{ section.settings.selected_background | default: '#D8F7FF' }};
    --spf-selector-selected-border: {{ section.settings.selected_border | default: '#6CDFFF' }};
    --spf-selector-selected-text: {{ section.settings.selected_text | default: '#000000' }};
    --spf-selector-radius: 8px;
    --spf-subscribe-selected: #fef3c7;
    --spf-subscribe-border: #f59e0b;
    --spf-savings-color: #E576A1;
    --transition-fast: 0.1s ease;
    --transition-normal: 0.15s ease;
    padding: var(--spacing-8) var(--spacing-5);
    font-family: var(--text-font-family);
  }

  .shop-purchase-flow__container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-8);
  }

  @media screen and (min-width: 1000px) {
    .shop-purchase-flow__container {
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-12);
      align-items: start;
    }
  }

  /* ============================================
     GALLERY COLUMN
     ============================================ */
  .shop-gallery {
    position: relative;
  }

  .shop-gallery__main {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 12px;
    overflow: hidden;
    background: #f5f5f5;
  }

  .shop-gallery__main-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
  }

  .shop-gallery__nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .shop-gallery__main:hover .shop-gallery__nav {
    opacity: 1;
  }

  .shop-gallery__nav--prev { left: 12px; }
  .shop-gallery__nav--next { right: 12px; }

  .shop-gallery__nav:hover {
    background: white;
  }

  .shop-gallery__thumbs {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding-bottom: 4px;
  }

  .shop-gallery__thumbs::-webkit-scrollbar {
    display: none;
  }

  .shop-gallery__thumb {
    flex-shrink: 0;
    width: 72px;
    height: 72px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    scroll-snap-align: start;
    transition: border-color 0.15s ease;
  }

  .shop-gallery__thumb--active {
    border-color: var(--spf-text-color);
  }

  .shop-gallery__thumb:hover:not(.shop-gallery__thumb--active) {
    border-color: #ccc;
  }

  .shop-gallery__thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Mobile dots */
  .shop-gallery__dots {
    display: none;
    justify-content: center;
    gap: 8px;
    padding: 12px 0;
  }

  .shop-gallery__dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ccc;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: background 0.15s ease;
  }

  .shop-gallery__dot--active {
    background: var(--spf-text-color);
  }

  @media screen and (max-width: 767px) {
    .shop-gallery {
      min-width: 0;
      overflow: hidden;
    }

    .shop-gallery__main {
      border-radius: 8px;
      margin: 0;
      width: 100%;
    }

    .shop-gallery__nav {
      display: none;
    }

    .shop-gallery__thumbs {
      max-width: 100%;
    }
  }

  /* Benefits badges */
  .shop-gallery__benefits {
    margin-top: 24px;
    padding: 16px;
    background: #f9f9f9;
    border-radius: 12px;
  }

  .shop-gallery__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-2) 0;
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .shop-gallery__benefit-icon {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shop-gallery__benefit-icon img {
    width: 24px;
    height: 24px;
    object-fit: contain;
  }

  .shop-gallery__benefit-icon--emoji {
    font-size: 1.25rem;
    line-height: 1;
  }

  /* Mobile benefits in purchase column */
  .shop-purchase__benefits {
    display: none;
  }

  @media screen and (max-width: 767px) {
    .shop-gallery__benefits {
      display: none;
    }

    .shop-purchase__benefits {
      display: block;
      margin-top: var(--spacing-4);
      padding: 16px;
      background: #F0E9DE;
      border-radius: 12px;
    }

    .shop-purchase__benefits .shop-gallery__benefit {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      padding: var(--spacing-2) 0;
      font-size: var(--text-sm);
      color: var(--spf-text-color);
    }
  }

  /* ============================================
     PURCHASE COLUMN
     ============================================ */
  .shop-purchase {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
  }

  .shop-purchase__header {
    text-align: left;
  }

  .shop-purchase__title {
    font-size: var(--text-h2);
    font-weight: 700;
    margin: 0 0 var(--spacing-2) 0;
    color: var(--spf-text-color);
    font-family: var(--heading-font-family);
    letter-spacing: var(--heading-letter-spacing);
  }

  .shop-purchase__subtitle {
    font-size: var(--text-base);
    color: var(--spf-text-color);
    margin: 0 0 var(--spacing-3) 0;
  }

  .shop-purchase__rating {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .shop-purchase__stars {
    color: var(--spf-star-color);
    letter-spacing: 2px;
  }

  .shop-purchase__stars-image {
    height: 20px;
    width: auto;
  }

  .shop-purchase__divider {
    height: 1px;
    background: var(--spf-border-color);
    margin: 0;
  }

  .shop-purchase__section-title {
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--spf-text-muted);
    margin: 0 0 var(--spacing-3) 0;
  }

  /* ============================================
     FLAVOR SELECTION
     ============================================ */
  .flavor-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .flavor-option {
    padding: var(--spacing-4) var(--spacing-5);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .flavor-option:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .flavor-option--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .flavor-option--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-option--selected .flavor-option__name,
  .flavor-option--selected .flavor-option__description,
  .flavor-option--selected .flavor-option__flavor-list {
    color: var(--spf-text-color);
  }

  .flavor-option--selected .flavor-option__toggle {
    border-color: var(--spf-selector-border);
    color: var(--spf-text-color);
  }

  /* Featured badge styling */
  .flavor-option__badge--featured {
    position: absolute;
    top: -10px;
    right: 16px;
    background: var(--spf-badge-featured);
    color: white;
  }

  .flavor-option--has-badge {
    position: relative;
  }

  /* Dropdown variant for Pick Your Own */
  .flavor-option--dropdown {
    padding: 0;
    overflow: hidden;
  }

  .flavor-option--dropdown .flavor-option__header {
    padding: var(--spacing-4) var(--spacing-5);
    cursor: pointer;
  }

  .flavor-option__toggle {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-2) var(--spacing-3);
    border: 1px solid var(--spf-border-color);
    border-radius: var(--rounded);
    background: transparent;
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
    color: var(--spf-text-color);
  }

  .flavor-option__toggle:hover {
    background: rgb(var(--text-primary) / 0.05);
  }

  .flavor-option__arrow {
    transition: transform 0.2s ease;
    width: 16px;
    height: 16px;
  }

  .flavor-option--expanded .flavor-option__arrow {
    transform: rotate(180deg);
  }

  .flavor-option__content {
    background: white;
    border-top: 1px solid var(--spf-border-color);
    overflow: hidden;
  }

  .flavor-option__content-inner {
    padding: var(--spacing-4);
  }

  /* Flavor list text for Mixed Box */
  .flavor-option__flavor-list {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: var(--spacing-1);
    margin-bottom: 0;
  }

  /* Mixed Box with image variant */
  .flavor-option--mixed {
    display: flex;
    align-items: stretch;
    padding: 0;
    overflow: hidden;
  }

  .flavor-option__image {
    flex-shrink: 0;
    width: 80px;
    background: #f5f5f5;
  }

  .flavor-option__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .flavor-option__text {
    flex: 1;
    padding: var(--spacing-4) var(--spacing-5);
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* When no image, keep normal padding */
  .flavor-option--mixed:not(:has(.flavor-option__image)) {
    padding: var(--spacing-4) var(--spacing-5);
  }

  .flavor-option__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .flavor-option__left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .flavor-option__radio {
    display: none;
  }

  .flavor-option__emoji {
    font-size: 1.25rem;
  }

  .flavor-option__name {
    font-weight: 600;
    font-size: var(--text-base);
    color: var(--spf-text-color);
  }

  .flavor-option__badge {
    font-size: var(--text-xs);
    padding: 2px var(--spacing-2);
    border-radius: var(--rounded-xs);
    background: var(--spf-badge-popular);
    color: var(--spf-text-color);
    font-weight: 600;
  }

  .flavor-option__description {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: var(--spacing-2);
    padding-left: 32px;
  }

  /* Pick Your Own nested options */
  .flavor-option__nested {
    margin-top: var(--spacing-4);
    padding: var(--spacing-3);
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded);
    opacity: 0.5;
    pointer-events: none;
    transition: opacity var(--transition-normal);
  }

  .flavor-option--selected .flavor-option__nested {
    opacity: 1;
    pointer-events: auto;
  }

  .flavor-checkbox {
    display: flex;
    align-items: center;
    padding: var(--spacing-3);
    border-bottom: 1px solid var(--spf-border-color);
    cursor: pointer;
    transition: background var(--transition-normal);
    border-radius: var(--rounded);
  }

  .flavor-checkbox:last-child {
    border-bottom: none;
  }

  .flavor-checkbox:hover {
    background: rgb(var(--text-primary) / 0.03);
  }

  .flavor-checkbox--checked {
    background: rgb(var(--accent) / 0.05);
  }

  .flavor-checkbox__box {
    width: 20px;
    height: 20px;
    border-radius: var(--rounded-xs);
    border: 2px solid rgb(var(--text-primary) / 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-right: var(--spacing-3);
    transition: all var(--transition-normal);
  }

  .flavor-checkbox--checked .flavor-checkbox__box {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .flavor-checkbox__check {
    color: rgb(var(--background-primary));
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .flavor-checkbox--checked .flavor-checkbox__check {
    opacity: 1;
  }

  .flavor-checkbox__emoji {
    font-size: 1.25rem;
    margin-right: var(--spacing-3);
  }

  .flavor-checkbox__info {
    flex: 1;
  }

  .flavor-checkbox__name {
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .flavor-checkbox__desc {
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
    margin-top: 2px;
  }

  .flavor-checkbox__badge {
    font-size: var(--text-xs);
    padding: 2px 6px;
    border-radius: var(--rounded-xs);
    background: var(--spf-badge-hot);
    color: white;
    font-weight: 600;
    margin-left: auto;
  }

  .flavor-checkbox--disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  /* ============================================
     FLAVOR CARDS (Card-based selectors)
     ============================================ */
  .flavor-cards {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .flavor-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    padding: var(--spacing-3) var(--spacing-4);
    border: 2px solid var(--spf-selector-border);
    border-radius: var(--spf-selector-radius);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .flavor-card:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .flavor-card--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .flavor-card--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-card--disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  .flavor-card__image {
    width: 60px;
    height: 60px;
    border-radius: var(--rounded);
    overflow: hidden;
    flex-shrink: 0;
    background: #f5f5f5;
  }

  .flavor-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .flavor-card__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--spf-selector-selected-border) 0%, color-mix(in srgb, var(--spf-selector-selected-border) 70%, white) 100%);
    color: white;
    font-size: 1.5rem;
  }

  .flavor-card__name {
    flex: 1;
    font-weight: 700;
    font-size: var(--text-base);
    text-transform: uppercase;
    color: var(--spf-text-color);
  }

  .flavor-card__action {
    padding: var(--spacing-2) var(--spacing-4);
    border: 1px solid var(--spf-border-color);
    border-radius: var(--rounded);
    background: transparent;
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
    color: var(--spf-text-color);
  }

  .flavor-card__action:hover {
    background: rgb(var(--text-primary) / 0.05);
  }

  .flavor-card--selected .flavor-card__action {
    background: var(--spf-selector-selected-border);
    border-color: var(--spf-selector-selected-border);
    color: white;
  }

  .flavor-card--selected .flavor-card__action:hover {
    background: color-mix(in srgb, var(--spf-selector-selected-border) 85%, black);
  }

  /* Info text below flavor cards */
  .flavor-option__info {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    margin-top: var(--spacing-3);
    padding: var(--spacing-2) var(--spacing-3);
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded);
  }

  .flavor-option__info svg {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    opacity: 0.6;
  }

  /* ============================================
     SIZE CARDS
     ============================================ */
  .size-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-3);
  }

  .size-card {
    position: relative;
    padding: var(--spacing-4) var(--spacing-3);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .size-card:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .size-card--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .size-card--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .size-card:active {
    transform: scale(0.98);
  }

  .size-card__badge {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    padding: 2px var(--spacing-2);
    border-radius: var(--rounded-xs);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .size-card__badge--popular {
    background: var(--spf-badge-popular);
    color: var(--spf-text-color);
  }

  .size-card__badge--free-ship {
    background: var(--spf-badge-success);
    color: white;
  }

  .size-card__label {
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--spf-text-muted);
    margin-bottom: var(--spacing-2);
  }

  .size-card__packs {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .size-card__duration {
    font-size: var(--text-xs);
    color: var(--spf-text-subtle);
    margin-bottom: var(--spacing-3);
  }

  .size-card__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .size-card__per-pack {
    font-size: var(--text-xs);
    color: var(--spf-text-subtle);
    margin-top: 4px;
  }

  /* Size cards mobile overrides */
  @media screen and (max-width: 767px) {
    .size-card {
      padding: var(--spacing-3) var(--spacing-2);
    }

    .size-card__label {
      font-size: 10px;
    }

    .size-card__packs {
      font-size: var(--text-base);
    }

    .size-card__price {
      font-size: 1rem;
    }

    .size-card__per-pack {
      font-size: 10px;
    }
  }

  /* ============================================
     SUBSCRIPTION TOGGLE
     ============================================ */
  .sub-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .sub-option {
    padding: var(--spacing-4) var(--spacing-5);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .sub-option:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .sub-option--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .sub-option--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  /* Subscribe option styling when selected */
  .sub-option--subscribe.sub-option--selected .sub-option__radio {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .sub-option__per-pack {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__per-pack-label {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    font-weight: 400;
  }

  .sub-option__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sub-option__left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .sub-option__radio {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid rgb(var(--text-primary) / 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--transition-normal);
  }

  .sub-option--selected .sub-option__radio {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .sub-option__radio::after {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgb(var(--background-primary));
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .sub-option--selected .sub-option__radio::after {
    opacity: 1;
  }

  .sub-option__title {
    font-weight: 600;
    font-size: var(--text-base);
    color: var(--spf-text-color);
  }

  .sub-option__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__benefits {
    margin-top: var(--spacing-3);
    padding-left: 32px;
  }

  .sub-option__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .sub-option__benefit-icon {
    color: var(--spf-success);
    flex-shrink: 0;
  }

  .sub-option__savings {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--spf-savings-color);
    margin-top: auto;
  }

  .sub-option__nudge {
    margin-top: var(--spacing-3);
    padding: var(--spacing-3);
    background: rgb(var(--warning-background));
    border-radius: var(--rounded);
    font-size: var(--text-sm);
    color: rgb(var(--warning-text));
    margin-left: 32px;
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  /* Subscribe section redesign - two column layout */
  .sub-option__layout {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-4);
  }

  .sub-option__left-col {
    flex: 1;
  }

  .sub-option__right-col {
    text-align: right;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }

  .sub-option__title-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    margin-bottom: var(--spacing-2);
  }

  .sub-option__per-pack {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__per-box {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: 2px;
  }

  .sub-option__benefits {
    margin-top: var(--spacing-2);
    padding-left: 0;
  }

  .sub-option__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .sub-option__benefit img {
    width: 16px;
    height: 16px;
    object-fit: contain;
  }

  /* Subscribe cards mobile overrides */
  @media screen and (max-width: 767px) {
    .sub-option {
      padding: var(--spacing-3) var(--spacing-4);
    }

    .sub-option__title {
      font-size: var(--text-sm);
    }

    .sub-option__benefit {
      font-size: var(--text-xs);
    }

    .sub-option__per-pack {
      font-size: 1.1rem;
    }

    .sub-option__per-box,
    .sub-option__savings {
      font-size: var(--text-xs);
    }
  }

  /* ============================================
     CTA BUTTON
     ============================================ */
  .cta-button {
    width: 100%;
    padding: var(--spacing-5) var(--spacing-6);
    border-radius: 8px;
    background: #FED700;
    color: var(--spf-text-color);
    font-size: var(--text-base);
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
    border: 1px solid #E0C426;
    text-transform: uppercase;
  }

  .cta-button:hover {
    background: #E8C300;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(254, 215, 0, 0.4);
  }

  .cta-button:active {
    transform: translateY(0);
  }

  .cta-button:disabled {
    background: rgb(var(--text-primary) / 0.2);
    color: var(--spf-text-muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .cta-button__summary {
    font-size: var(--text-sm);
    font-weight: 400;
    opacity: 0.8;
    margin-top: 4px;
    text-transform: none;
  }

  /* ============================================
     TRUST BADGES
     ============================================ */
  .trust-badges {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: var(--spacing-4);
    padding: var(--spacing-4) 0;
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
  }

  .trust-badge {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .trust-badge__icon {
    font-size: var(--text-sm);
  }

  /* ============================================
     TESTIMONIAL
     ============================================ */
  .testimonial {
    padding: var(--spacing-4);
    text-align: center;
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded-lg);
  }

  .testimonial__quote {
    font-size: var(--text-sm);
    font-style: italic;
    color: var(--spf-text-color);
    margin: 0 0 var(--spacing-2) 0;
  }

  .testimonial__author {
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
    margin: 0;
  }

  .testimonial__verified {
    color: var(--spf-success);
  }

  /* ============================================
     MOBILE STICKY CTA
     ============================================ */
  .sticky-cta {
    display: none;
  }

  @media screen and (max-width: 999px) {
    .sticky-cta {
      display: block;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--spacing-3) var(--spacing-4);
      padding-bottom: calc(var(--spacing-3) + env(safe-area-inset-bottom));
      background: rgb(var(--background-primary));
      border-top: 1px solid var(--spf-border-color);
      box-shadow: 0 -4px 12px rgb(var(--text-primary) / 0.08);
      z-index: 100;
    }

    .sticky-cta .cta-button {
      padding: var(--spacing-4);
    }

    /* Add padding to bottom of purchase column to prevent content being hidden by sticky CTA */
    .shop-purchase {
      padding-bottom: 100px;
    }
  }

  /* ============================================
     ERROR STATE
     ============================================ */
  .flavor-error {
    color: rgb(var(--error-text));
    font-size: var(--text-sm);
    padding: var(--spacing-2) var(--spacing-3);
    background: rgb(var(--error-background));
    border-radius: var(--rounded);
    margin-top: var(--spacing-2);
  }
</style>

<div
  class="shop-purchase-flow"
  x-data="shopPurchaseFlow()"
  x-init="init()"
>
  <div class="shop-purchase-flow__container">
    <!-- GALLERY COLUMN -->
    <div class="shop-gallery">
      <!-- Main Image -->
      <div class="shop-gallery__main" @touchstart="touchStart($event)" @touchend="touchEnd($event)">
        <template x-for="(image, index) in currentImages" :key="image.id">
          <img
            :src="image.src"
            :alt="image.alt"
            class="shop-gallery__main-image"
            x-show="currentImageIndex === index"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            style="position: absolute; top: 0; left: 0;"
          >
        </template>

        <button
          class="shop-gallery__nav shop-gallery__nav--prev"
          @click="prevImage()"
          x-show="currentImages.length > 1"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button
          class="shop-gallery__nav shop-gallery__nav--next"
          @click="nextImage()"
          x-show="currentImages.length > 1"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>

      <!-- Thumbnail Strip (Desktop) -->
      <div class="shop-gallery__thumbs">
        <template x-for="(image, index) in currentImages" :key="image.id">
          <button
            class="shop-gallery__thumb"
            :class="{ 'shop-gallery__thumb--active': currentImageIndex === index }"
            @click="selectImage(index)"
          >
            <img :src="image.thumb" :alt="image.alt">
          </button>
        </template>
      </div>

      <!-- Dot Indicators (Mobile) -->
      <div class="shop-gallery__dots">
        <template x-for="(image, index) in currentImages" :key="'dot-' + image.id">
          <button
            class="shop-gallery__dot"
            :class="{ 'shop-gallery__dot--active': currentImageIndex === index }"
            @click="selectImage(index)"
          ></button>
        </template>
      </div>

      <!-- Benefit Badges -->
      <div class="shop-gallery__benefits">
        <div class="shop-gallery__benefit">
          <span class="shop-gallery__benefit-icon{% unless section.settings.benefit_1_icon != blank %} shop-gallery__benefit-icon--emoji{% endunless %}">
            {%- if section.settings.benefit_1_icon != blank -%}
              <img src="{{ section.settings.benefit_1_icon | image_url: width: 48 }}" alt="" width="24" height="24">
            {%- else -%}
              {{ section.settings.benefit_1_emoji }}
            {%- endif -%}
          </span>
          <span>{{ section.settings.benefit_1 }}</span>
        </div>
        <div class="shop-gallery__benefit">
          <span class="shop-gallery__benefit-icon{% unless section.settings.benefit_2_icon != blank %} shop-gallery__benefit-icon--emoji{% endunless %}">
            {%- if section.settings.benefit_2_icon != blank -%}
              <img src="{{ section.settings.benefit_2_icon | image_url: width: 48 }}" alt="" width="24" height="24">
            {%- else -%}
              {{ section.settings.benefit_2_emoji }}
            {%- endif -%}
          </span>
          <span>{{ section.settings.benefit_2 }}</span>
        </div>
        <div class="shop-gallery__benefit">
          <span class="shop-gallery__benefit-icon{% unless section.settings.benefit_3_icon != blank %} shop-gallery__benefit-icon--emoji{% endunless %}">
            {%- if section.settings.benefit_3_icon != blank -%}
              <img src="{{ section.settings.benefit_3_icon | image_url: width: 48 }}" alt="" width="24" height="24">
            {%- else -%}
              {{ section.settings.benefit_3_emoji }}
            {%- endif -%}
          </span>
          <span>{{ section.settings.benefit_3 }}</span>
        </div>
      </div>
    </div>

    <!-- PURCHASE COLUMN -->
    <div class="shop-purchase">
      <!-- Header -->
      <div class="shop-purchase__header">
        <h1 class="shop-purchase__title">{{ section.settings.title }}</h1>
        <p class="shop-purchase__subtitle">{{ section.settings.subtitle }}</p>
        <div class="shop-purchase__rating">
          {%- if section.settings.rating_image != blank -%}
            <img class="shop-purchase__stars-image" src="{{ section.settings.rating_image | image_url: width: 200 }}" alt="5 star rating" height="20">
          {%- else -%}
            <span class="shop-purchase__stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
          {%- endif -%}
          <span>{{ section.settings.reviews_text }}</span>
        </div>

        <!-- Benefits (Mobile only - duplicated for layout) -->
        <div class="shop-purchase__benefits">
          <div class="shop-gallery__benefit">
            <span class="shop-gallery__benefit-icon{% unless section.settings.benefit_1_icon != blank %} shop-gallery__benefit-icon--emoji{% endunless %}">
              {%- if section.settings.benefit_1_icon != blank -%}
                <img src="{{ section.settings.benefit_1_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              {%- else -%}
                {{ section.settings.benefit_1_emoji }}
              {%- endif -%}
            </span>
            <span>{{ section.settings.benefit_1 }}</span>
          </div>
          <div class="shop-gallery__benefit">
            <span class="shop-gallery__benefit-icon{% unless section.settings.benefit_2_icon != blank %} shop-gallery__benefit-icon--emoji{% endunless %}">
              {%- if section.settings.benefit_2_icon != blank -%}
                <img src="{{ section.settings.benefit_2_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              {%- else -%}
                {{ section.settings.benefit_2_emoji }}
              {%- endif -%}
            </span>
            <span>{{ section.settings.benefit_2 }}</span>
          </div>
          <div class="shop-gallery__benefit">
            <span class="shop-gallery__benefit-icon{% unless section.settings.benefit_3_icon != blank %} shop-gallery__benefit-icon--emoji{% endunless %}">
              {%- if section.settings.benefit_3_icon != blank -%}
                <img src="{{ section.settings.benefit_3_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              {%- else -%}
                {{ section.settings.benefit_3_emoji }}
              {%- endif -%}
            </span>
            <span>{{ section.settings.benefit_3 }}</span>
          </div>
        </div>
      </div>

      <hr class="shop-purchase__divider">

      <!-- Flavor Selection -->
      <div>
        <p class="shop-purchase__section-title">{{ section.settings.flavors_title }}</p>
        <div class="flavor-options">
          <!-- Mixed Box Option -->
          <div
            class="flavor-option flavor-option--mixed{% if section.settings.mixed_box_badge != blank %} flavor-option--has-badge{% endif %}"
            :class="{ 'flavor-option--selected': flavorMode === 'mixed' }"
            @click="selectMixedBox()"
          >
            {%- if section.settings.mixed_box_badge != blank -%}
              <span class="flavor-option__badge flavor-option__badge--featured">{{ section.settings.mixed_box_badge }}</span>
            {%- endif -%}
            {%- if section.settings.mixed_box_image != blank -%}
              <div class="flavor-option__image">
                <img src="{{ section.settings.mixed_box_image | image_url: width: 200 }}" alt="{{ section.settings.mixed_box_name }}">
              </div>
            {%- endif -%}
            <div class="flavor-option__text">
              <span class="flavor-option__name">{{ section.settings.mixed_box_name | upcase }}</span>
              {%- if section.settings.mixed_box_flavor_list != blank -%}
                <p class="flavor-option__flavor-list">{{ section.settings.mixed_box_flavor_list }}</p>
              {%- endif -%}
            </div>
          </div>

          <!-- Pick Your Own Option -->
          <div
            class="flavor-option flavor-option--dropdown"
            :class="{
              'flavor-option--selected': flavorMode === 'pick',
              'flavor-option--expanded': flavorMode === 'pick' || pickOwnExpanded
            }"
          >
            <div class="flavor-option__header" @click="selectPickMode()">
              <div class="flavor-option__left">
                <div class="flavor-option__radio"></div>
                <span class="flavor-option__name">{{ section.settings.pick_own_name | upcase }}</span>
              </div>
              <button class="flavor-option__toggle" @click.stop="pickOwnExpanded = !pickOwnExpanded; if(!pickOwnExpanded && flavorMode !== 'pick') { /* keep closed */ } else if(pickOwnExpanded) { flavorMode = 'pick'; }">
                <span x-text="selectedFlavors.length > 0 ? selectedFlavors.length + ' selected' : 'Pick'"></span>
                <svg class="flavor-option__arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
            </div>

            <!-- Collapsible Flavor Cards -->
            <div class="flavor-option__content" x-show="flavorMode === 'pick' || pickOwnExpanded" x-collapse>
              <div class="flavor-option__content-inner">
                <div class="flavor-cards">
                  {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor' -%}
                  {%- if flavor_blocks.size > 0 -%}
                    {%- comment -%} Use flavor blocks from Theme Customizer {%- endcomment -%}
                    {%- for block in flavor_blocks -%}
                      {%- assign flavor_product = block.settings.product -%}
                      {%- if flavor_product != blank -%}
                        {%- assign flavor_name = block.settings.name_override | default: flavor_product.title | remove: 'Overnight Gut Oats |' | strip | upcase -%}
                        <div
                          class="flavor-card"
                          :class="{
                            'flavor-card--selected': selectedFlavors.includes({{ flavor_product.id }}),
                            'flavor-card--disabled': !selectedFlavors.includes({{ flavor_product.id }}) && selectedFlavors.length >= 3
                          }"
                          @click="toggleFlavor({{ flavor_product.id }})"
                          {{ block.shopify_attributes }}
                        >
                          <div class="flavor-card__image">
                            {%- if block.settings.image != blank -%}
                              <img src="{{ block.settings.image | image_url: width: 120 }}" alt="{{ flavor_name }}" loading="lazy">
                            {%- else -%}
                              <div class="flavor-card__placeholder">
                                <span>{{ block.settings.emoji | default: 'ü•£' }}</span>
                              </div>
                            {%- endif -%}
                          </div>
                          <div class="flavor-card__name">{{ flavor_name }}</div>
                          <button
                            class="flavor-card__action"
                            @click.stop="toggleFlavor({{ flavor_product.id }})"
                            x-text="selectedFlavors.includes({{ flavor_product.id }}) ? 'Un-select' : 'Select'"
                          ></button>
                        </div>
                      {%- endif -%}
                    {%- endfor -%}
                  {%- else -%}
                    {%- comment -%} Fallback: auto-generate from collection {%- endcomment -%}
                    {%- for product in collections['breakfast'].products limit: 4 -%}
                      {%- unless product.title contains 'Mixed' -%}
                        {%- assign flavor_name = product.title | remove: 'Overnight Gut Oats |' | strip | upcase -%}
                        {%- assign flavor_emoji = 'ü•£' -%}
                        {%- if flavor_name contains 'CACAO' -%}
                          {%- assign flavor_emoji = 'üü´' -%}
                        {%- elsif flavor_name contains 'STRAWBERRY' -%}
                          {%- assign flavor_emoji = 'üçì' -%}
                        {%- elsif flavor_name contains 'CINNAMON' -%}
                          {%- assign flavor_emoji = 'üü§' -%}
                        {%- endif -%}
                        <div
                          class="flavor-card"
                          :class="{
                            'flavor-card--selected': selectedFlavors.includes({{ product.id }}),
                            'flavor-card--disabled': !selectedFlavors.includes({{ product.id }}) && selectedFlavors.length >= 3
                          }"
                          @click="toggleFlavor({{ product.id }})"
                        >
                          <div class="flavor-card__image">
                            {%- if product.featured_image != blank -%}
                              <img src="{{ product.featured_image | image_url: width: 120 }}" alt="{{ flavor_name }}" loading="lazy">
                            {%- else -%}
                              <div class="flavor-card__placeholder">
                                <span>{{ flavor_emoji }}</span>
                              </div>
                            {%- endif -%}
                          </div>
                          <div class="flavor-card__name">{{ flavor_name }}</div>
                          <button
                            class="flavor-card__action"
                            @click.stop="toggleFlavor({{ product.id }})"
                            x-text="selectedFlavors.includes({{ product.id }}) ? 'Un-select' : 'Select'"
                          ></button>
                        </div>
                      {%- endunless -%}
                    {%- endfor -%}
                  {%- endif -%}
                </div>

                <!-- Info text -->
                <p class="flavor-option__info">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                  </svg>
                  <span>There is a minimum of 9 packs per flavour.</span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Error message -->
        <div class="flavor-error" x-show="flavorMode === 'pick' && selectedFlavors.length === 0" x-cloak>
          Please select at least one flavor
        </div>
      </div>

      <hr class="shop-purchase__divider">

      <!-- Size Selection -->
      <div>
        <p class="shop-purchase__section-title">{{ section.settings.size_title }}</p>
        <div class="size-cards">
          <template x-for="size in availableSizes" :key="size.id">
            <div
              class="size-card"
              :class="{ 'size-card--selected': selectedSize === size.id }"
              @click="selectedSize = size.id"
            >
              <div class="size-card__label" x-text="size.label"></div>
              <div class="size-card__packs" x-text="size.packsLabel"></div>
              <div class="size-card__price" x-text="formatPrice(getSizePrice(size.id))"></div>
              <div class="size-card__per-pack" x-text="formatPrice(getSizePrice(size.id) / size.id) + '/pack'"></div>
            </div>
          </template>
        </div>
      </div>

      <hr class="shop-purchase__divider">

      <!-- Subscribe / One-time Toggle -->
      <div class="sub-options">
        <!-- Subscribe Option -->
        <div
          class="sub-option sub-option--subscribe"
          :class="{ 'sub-option--selected': subscribe }"
          @click="subscribe = true"
        >
          <div class="sub-option__layout">
            <!-- Left column: Title + Benefits -->
            <div class="sub-option__left-col">
              <div class="sub-option__title-row">
                <span class="sub-option__title">SUB & SAVE <span x-text="discountPercent + '%'"></span></span>
              </div>
              <div class="sub-option__benefits">
                <div class="sub-option__benefit">
                  {%- if section.settings.sub_tick_icon != blank -%}
                    <img src="{{ section.settings.sub_tick_icon | image_url: width: 32 }}" alt="" width="16" height="16">
                  {%- else -%}
                    <svg class="sub-option__benefit-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  {%- endif -%}
                  <span>{{ section.settings.sub_benefit_1 | default: 'Pause or cancel anytime' }}</span>
                </div>
                <div class="sub-option__benefit">
                  {%- if section.settings.sub_tick_icon != blank -%}
                    <img src="{{ section.settings.sub_tick_icon | image_url: width: 32 }}" alt="" width="16" height="16">
                  {%- else -%}
                    <svg class="sub-option__benefit-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  {%- endif -%}
                  <span>{{ section.settings.sub_benefit_2 | default: 'Monthly, straight to your door' }}</span>
                </div>
                <div class="sub-option__benefit">
                  {%- if section.settings.sub_tick_icon != blank -%}
                    <img src="{{ section.settings.sub_tick_icon | image_url: width: 32 }}" alt="" width="16" height="16">
                  {%- else -%}
                    <svg class="sub-option__benefit-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  {%- endif -%}
                  <span>{{ section.settings.sub_benefit_3 | default: 'Commit to Cult & save 20%' }}</span>
                </div>
              </div>
            </div>
            <!-- Right column: Pricing -->
            <div class="sub-option__right-col">
              <div class="sub-option__per-pack" x-text="getPerPackPrice(true) + '/pack'"></div>
              <div class="sub-option__per-box" x-text="formatPrice(getTotalPrice(true)) + '/box'"></div>
              <div class="sub-option__savings">Save <span x-text="formatPrice(getSavings())"></span></div>
            </div>
          </div>
          <div class="sub-option__nudge" x-show="subscribe && showFreeShippingNudge" x-collapse>
            üí° <span x-text="freeShippingNudgeText"></span>
          </div>
        </div>

        <!-- One-time Option -->
        <div
          class="sub-option"
          :class="{ 'sub-option--selected': !subscribe }"
          @click="subscribe = false"
        >
          <div class="sub-option__header">
            <div class="sub-option__left">
              <span class="sub-option__title">One-time purchase</span>
            </div>
            <span class="sub-option__price" x-text="formatPrice(getTotalPrice(false)) + '/box'"></span>
          </div>
        </div>
      </div>

      <!-- CTA Button (Desktop) -->
      <div class="desktop-cta">
        <button
          class="cta-button"
          @click="checkout()"
          :disabled="!canCheckout"
        >
          {{ section.settings.cta_button_text | default: 'Checkout' }} ¬∑ <span x-text="formatPrice(getTotalPrice(subscribe))"></span>
        </button>
      </div>

      <!-- Trust Badges -->
      <div class="trust-badges">
        <span class="trust-badge">
          <span class="trust-badge__icon">üîí</span>
          <span>Secure checkout</span>
        </span>
      </div>

      <!-- Testimonial -->
      <div class="testimonial">
        <p class="testimonial__quote">"{{ section.settings.testimonial_quote }}"</p>
        <p class="testimonial__author">‚Äî {{ section.settings.testimonial_author }} <span class="testimonial__verified">‚úì Verified subscriber</span></p>
      </div>
    </div>
  </div>

  <!-- Mobile Sticky CTA -->
  <div class="sticky-cta">
    <button
      class="cta-button"
      @click="checkout()"
      :disabled="!canCheckout"
    >
      {{ section.settings.cta_button_text | default: 'Checkout' }} ¬∑ <span x-text="formatPrice(getTotalPrice(subscribe))"></span>
    </button>
  </div>
</div>

<script>
  function shopPurchaseFlow() {
    return {
      // Product data (populated from Liquid)
      // Merge products from collection and flavor blocks
      products: {
        {%- assign included_product_ids = '' -%}
        {%- comment -%} First, add products from collection {%- endcomment -%}
        {%- for product in collections['breakfast'].products limit: 4 -%}
          {%- unless included_product_ids contains product.id -%}
            {%- if included_product_ids != '' -%}{%- assign included_product_ids = included_product_ids | append: ',' -%}{%- endif -%}
            {%- assign included_product_ids = included_product_ids | append: product.id -%}
            {{ product.id }}: {
              id: {{ product.id }},
              title: {{ product.title | json }},
              handle: {{ product.handle | json }},
              isMixed: {% if product.title contains 'Mixed' %}true{% else %}false{% endif %},
              images: [
                {%- for image in product.images -%}
                  {
                    id: {{ image.id }},
                    src: {{ image.src | image_url: width: 800 | json }},
                    thumb: {{ image.src | image_url: width: 150 | json }},
                    alt: {{ image.alt | default: product.title | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              variants: {
                {%- for variant in product.variants -%}
                  {{ variant.id }}: {
                    id: {{ variant.id }},
                    title: {{ variant.title | json }},
                    price: {{ variant.price }},
                    packs: {{ variant.title | remove: 'Pack' | remove: ' ' | times: 1 }},
                    sellingPlanId: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.selling_plan.id }}{% else %}null{% endif %},
                    discountPercent: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.price_adjustments.first.value | default: 0 }}{% else %}0{% endif %}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              }
            },
          {%- endunless -%}
        {%- endfor -%}
        {%- comment -%} Add products from flavor blocks that aren't already included {%- endcomment -%}
        {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor' -%}
        {%- for block in flavor_blocks -%}
          {%- assign flavor_product = block.settings.product -%}
          {%- if flavor_product != blank -%}
            {%- unless included_product_ids contains flavor_product.id -%}
              {%- if included_product_ids != '' -%}{%- assign included_product_ids = included_product_ids | append: ',' -%}{%- endif -%}
              {%- assign included_product_ids = included_product_ids | append: flavor_product.id -%}
              {{ flavor_product.id }}: {
                id: {{ flavor_product.id }},
                title: {{ flavor_product.title | json }},
                handle: {{ flavor_product.handle | json }},
                isMixed: {% if flavor_product.title contains 'Mixed' %}true{% else %}false{% endif %},
                images: [
                  {%- for image in flavor_product.images -%}
                    {
                      id: {{ image.id }},
                      src: {{ image.src | image_url: width: 800 | json }},
                      thumb: {{ image.src | image_url: width: 150 | json }},
                      alt: {{ image.alt | default: flavor_product.title | json }}
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                ],
                variants: {
                  {%- for variant in flavor_product.variants -%}
                    {{ variant.id }}: {
                      id: {{ variant.id }},
                      title: {{ variant.title | json }},
                      price: {{ variant.price }},
                      packs: {{ variant.title | remove: 'Pack' | remove: ' ' | times: 1 }},
                      sellingPlanId: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.selling_plan.id }}{% else %}null{% endif %},
                      discountPercent: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.price_adjustments.first.value | default: 0 }}{% else %}0{% endif %}
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                }
              },
            {%- endunless -%}
          {%- endif -%}
        {%- endfor -%}
      },

      // State
      flavorMode: 'mixed', // 'mixed' or 'pick'
      selectedFlavors: [], // Array of product IDs when in 'pick' mode
      selectedSize: 18, // 9, 18, or 27 packs
      subscribe: true,
      currentImageIndex: 0,
      discountPercent: 20, // Default, will be set from first variant with selling plan
      pickOwnExpanded: false, // Manual toggle for Pick Your Own dropdown

      // Gallery images from section blocks (populated from Liquid)
      galleryImages: [
        {%- assign gallery_blocks = section.blocks | where: 'type', 'gallery_image' -%}
        {%- for block in gallery_blocks -%}
          {%- if block.settings.image != blank -%}
            {
              id: 'gallery-{{ block.id }}',
              src: {{ block.settings.image | image_url: width: 800 | json }},
              thumb: {{ block.settings.image | image_url: width: 150 | json }},
              alt: {{ block.settings.alt | default: 'Product image' | json }}
            }{% unless forloop.last %},{% endunless %}
          {%- endif -%}
        {%- endfor -%}
      ],

      // Touch tracking for swipe
      touchStartX: 0,
      touchEndX: 0,

      // Computed
      get mixedBoxProduct() {
        return Object.values(this.products).find(p => p.isMixed);
      },

      get individualProducts() {
        return Object.values(this.products).filter(p => !p.isMixed);
      },

      get currentImages() {
        return this.galleryImages;
      },

      get effectiveFlavorCount() {
        if (this.flavorMode === 'mixed') return 1;
        return Math.max(1, this.selectedFlavors.length);
      },

      get availableSizes() {
        const count = this.effectiveFlavorCount;

        if (count === 1) {
          return [
            { id: 9, label: 'Starter', packsLabel: '9 packs', duration: '~1 week', perPack: '2.00', badge: '', badgeClass: '' },
            { id: 18, label: 'Popular', packsLabel: '18 packs', duration: '~2 weeks', perPack: '2.00', badge: '‚≠ê POPULAR', badgeClass: 'size-card__badge--popular' },
            { id: 27, label: 'Best Value', packsLabel: '27 packs', duration: '~3 weeks', perPack: '2.00', badge: 'üöö FREE SHIP', badgeClass: 'size-card__badge--free-ship' }
          ];
        } else if (count === 2) {
          return [
            { id: 9, label: '9 Each', packsLabel: '18 total', duration: '9 per flavor', perPack: '2.00', badge: '', badgeClass: '' },
            { id: 18, label: '18 Each', packsLabel: '36 total', duration: '18 per flavor', perPack: '2.00', badge: 'üöö FREE SHIP', badgeClass: 'size-card__badge--free-ship' }
          ];
        } else {
          // 3 flavors
          return [
            { id: 9, label: '9 Each', packsLabel: '27 total', duration: '9 per flavor', perPack: '2.00', badge: '', badgeClass: '' },
            { id: 18, label: '18 Each', packsLabel: '54 total', duration: '18 per flavor', perPack: '2.00', badge: 'üöö FREE SHIP', badgeClass: 'size-card__badge--free-ship' }
          ];
        }
      },

      get canCheckout() {
        if (this.flavorMode === 'mixed') return true;
        return this.selectedFlavors.length > 0;
      },

      get showFreeShippingNudge() {
        const total = this.getTotalPrice(true);
        const totalPence = total;
        return totalPence < 4000 && this.flavorMode === 'pick' && this.selectedFlavors.length < 3;
      },

      get freeShippingNudgeText() {
        const total = this.getTotalPrice(true);
        const gap = 4000 - total;
        if (this.selectedFlavors.length < 3 && gap > 0) {
          return 'Add another flavor for FREE shipping';
        }
        return 'Upgrade to 27-pack for FREE shipping';
      },

      // Methods
      init() {
        // Get discount percent from first variant with a selling plan
        for (const product of Object.values(this.products)) {
          for (const variant of Object.values(product.variants)) {
            if (variant.discountPercent > 0) {
              this.discountPercent = variant.discountPercent;
              break;
            }
          }
          if (this.discountPercent !== 20) break;
        }

        // Ensure selected size is valid for current flavor count
        this.$watch('effectiveFlavorCount', (count) => {
          const validSizes = this.availableSizes.map(s => s.id);
          if (!validSizes.includes(this.selectedSize)) {
            this.selectedSize = validSizes[0];
          }
        });
      },

      selectMixedBox() {
        this.flavorMode = 'mixed';
        this.selectedFlavors = [];
        this.currentImageIndex = 0;
        this.pickOwnExpanded = false; // Collapse Pick Your Own dropdown
      },

      selectPickMode() {
        this.flavorMode = 'pick';
      },

      toggleFlavor(productId) {
        if (this.flavorMode !== 'pick') {
          this.flavorMode = 'pick';
        }

        const index = this.selectedFlavors.indexOf(productId);
        if (index > -1) {
          this.selectedFlavors.splice(index, 1);
        } else if (this.selectedFlavors.length < 3) {
          this.selectedFlavors.push(productId);
        }
        this.currentImageIndex = 0;
      },

      getVariantForSize(productId, packSize) {
        const product = this.products[productId];
        if (!product) return null;
        return Object.values(product.variants).find(v => v.packs === packSize);
      },

      getPrice(packSize) {
        // Returns total price in pence for the given pack size
        // For multi-flavor selections, returns sum of all selected flavors
        if (this.flavorMode === 'mixed') {
          const variant = this.getVariantForSize(this.mixedBoxProduct.id, packSize);
          return variant ? variant.price : 0;
        }

        // Sum up price for each selected flavor (or use one product for calculation if none selected)
        const count = this.effectiveFlavorCount;
        if (this.selectedFlavors.length === 0) {
          const product = this.individualProducts[0];
          const variant = this.getVariantForSize(product.id, packSize);
          return variant ? variant.price : 0;
        }

        let total = 0;
        for (const productId of this.selectedFlavors) {
          const variant = this.getVariantForSize(productId, packSize);
          if (variant) {
            total += variant.price;
          }
        }
        return total;
      },

      getSizePrice(packSize) {
        // Returns price for size card display, applying subscription discount if active
        const basePrice = this.getPrice(packSize);
        if (this.subscribe) {
          return Math.round(basePrice * (1 - this.discountPercent / 100));
        }
        return basePrice;
      },

      getTotalPrice(withSubscription) {
        const packSize = this.selectedSize;
        let total = this.getPrice(packSize);

        if (withSubscription) {
          total = Math.round(total * (1 - this.discountPercent / 100));
        }

        return total;
      },

      getSavings() {
        return this.getTotalPrice(false) - this.getTotalPrice(true);
      },

      getPerPackPrice(withSubscription) {
        const packSize = this.selectedSize;
        const flavorCount = this.flavorMode === 'mixed' ? 1 : Math.max(1, this.selectedFlavors.length);
        const totalPacks = packSize * flavorCount;
        const totalPrice = this.getTotalPrice(withSubscription);
        const perPack = totalPrice / totalPacks;
        return '¬£' + (perPack / 100).toFixed(2);
      },

      formatPrice(pence) {
        return '¬£' + (pence / 100).toFixed(2);
      },

      getOrderSummary() {
        const packSize = this.selectedSize;

        if (this.flavorMode === 'mixed') {
          return `1√ó Mixed Box (${packSize} packs)`;
        } else if (this.selectedFlavors.length === 0) {
          return 'Select a flavor';
        } else if (this.selectedFlavors.length === 1) {
          const product = this.products[this.selectedFlavors[0]];
          const name = product.title.replace('Overnight Gut Oats |', '').trim();
          return `1√ó ${name} (${packSize} packs)`;
        } else {
          const names = this.selectedFlavors.map(id => {
            const product = this.products[id];
            return product.title.replace('Overnight Gut Oats |', '').trim().split(' ')[0];
          }).join(', ');
          return `${this.selectedFlavors.length}√ó ${packSize}-pack (${names})`;
        }
      },

      checkout() {
        if (!this.canCheckout) return;

        const packSize = this.selectedSize;
        let lineItems = [];

        if (this.flavorMode === 'mixed') {
          const variant = this.getVariantForSize(this.mixedBoxProduct.id, packSize);
          if (variant) {
            lineItems.push({
              variantId: variant.id,
              quantity: 1,
              sellingPlanId: this.subscribe ? variant.sellingPlanId : null
            });
          }
        } else {
          for (const productId of this.selectedFlavors) {
            const variant = this.getVariantForSize(productId, packSize);
            if (variant) {
              lineItems.push({
                variantId: variant.id,
                quantity: 1,
                sellingPlanId: this.subscribe ? variant.sellingPlanId : null
              });
            }
          }
        }

        // Build direct checkout URL
        const params = lineItems.map(item => {
          let param = `line_items[][variant_id]=${item.variantId}&line_items[][quantity]=${item.quantity}`;
          if (item.sellingPlanId) {
            param += `&line_items[][selling_plan]=${item.sellingPlanId}`;
          }
          return param;
        }).join('&');

        window.location.href = `/checkout?${params}`;
      },

      // Image gallery
      nextImage() {
        this.currentImageIndex = (this.currentImageIndex + 1) % this.currentImages.length;
      },

      prevImage() {
        this.currentImageIndex = (this.currentImageIndex - 1 + this.currentImages.length) % this.currentImages.length;
      },

      selectImage(index) {
        this.currentImageIndex = index;
      },

      touchStart(event) {
        this.touchStartX = event.changedTouches[0].screenX;
      },

      touchEnd(event) {
        this.touchEndX = event.changedTouches[0].screenX;
        this.handleSwipe();
      },

      handleSwipe() {
        const diff = this.touchStartX - this.touchEndX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            this.nextImage();
          } else {
            this.prevImage();
          }
        }
      }
    };
  }
</script>

{% schema %}
{
  "name": "Shop Purchase Flow",
  "tag": "section",
  "class": "shopify-section--shop-purchase-flow",
  "settings": [
    {
      "type": "header",
      "content": "Header Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Overnight Gut Oats"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Delicious overnight oats. Just add milk."
    },
    {
      "type": "text",
      "id": "reviews_text",
      "label": "Reviews text",
      "default": "5.0 from 200+ reviews"
    },
    {
      "type": "image_picker",
      "id": "rating_image",
      "label": "Rating stars image",
      "info": "Upload a custom stars image (e.g., pink stars)"
    },
    {
      "type": "header",
      "content": "Section Titles"
    },
    {
      "type": "text",
      "id": "flavors_title",
      "label": "Flavors section title",
      "default": "Pick your flavors"
    },
    {
      "type": "text",
      "id": "size_title",
      "label": "Size section title",
      "default": "Choose your size"
    },
    {
      "type": "header",
      "content": "Mixed Box Option"
    },
    {
      "type": "text",
      "id": "mixed_box_name",
      "label": "Mixed box name",
      "default": "Mixed Box"
    },
    {
      "type": "text",
      "id": "mixed_box_emoji",
      "label": "Mixed box emoji",
      "default": "üé®"
    },
    {
      "type": "text",
      "id": "mixed_box_badge",
      "label": "Mixed box badge",
      "default": "‚≠ê Popular"
    },
    {
      "type": "image_picker",
      "id": "mixed_box_image",
      "label": "Mixed box image",
      "info": "Image displayed on the left side of the Mixed Box option"
    },
    {
      "type": "text",
      "id": "mixed_box_description",
      "label": "Mixed box description",
      "default": "All 3 flavors in one box ‚Äî can't decide? This is the one for you."
    },
    {
      "type": "header",
      "content": "Pick Your Own Option"
    },
    {
      "type": "text",
      "id": "pick_own_name",
      "label": "Pick your own name",
      "default": "Pick your own"
    },
    {
      "type": "text",
      "id": "pick_own_description",
      "label": "Pick your own description",
      "default": "Select 1-3 individual flavors"
    },
    {
      "type": "header",
      "content": "Product Gallery"
    },
    {
      "type": "text",
      "id": "benefit_1_emoji",
      "label": "Benefit 1 emoji",
      "default": "ü¶†"
    },
    {
      "type": "text",
      "id": "benefit_1",
      "label": "Benefit 1",
      "default": "1+ billion probiotics per serving"
    },
    {
      "type": "text",
      "id": "benefit_2_emoji",
      "label": "Benefit 2 emoji",
      "default": "üö´"
    },
    {
      "type": "text",
      "id": "benefit_2",
      "label": "Benefit 2",
      "default": "No artificial ingredients or added sugars"
    },
    {
      "type": "text",
      "id": "benefit_3_emoji",
      "label": "Benefit 3 emoji",
      "default": "üí™"
    },
    {
      "type": "text",
      "id": "benefit_3",
      "label": "Benefit 3",
      "default": "Supports healthy digestion"
    },
    {
      "type": "header",
      "content": "Testimonial"
    },
    {
      "type": "text",
      "id": "testimonial_quote",
      "label": "Quote",
      "default": "Finally healthy oats that taste amazing!"
    },
    {
      "type": "text",
      "id": "testimonial_author",
      "label": "Author",
      "default": "Sarah T."
    },
    {
      "type": "header",
      "content": "Selected Option Styling"
    },
    {
      "type": "color",
      "id": "selected_background",
      "label": "Selected background",
      "default": "#D8F7FF"
    },
    {
      "type": "color",
      "id": "selected_border",
      "label": "Selected border",
      "default": "#6CDFFF"
    },
    {
      "type": "color",
      "id": "selected_text",
      "label": "Selected text color",
      "default": "#000000",
      "info": "Text color for selected options"
    },
    {
      "type": "text",
      "id": "mixed_box_flavor_list",
      "label": "Mixed box flavor list",
      "default": "All 3: Cacao, Strawberry Goji, Cinnamon"
    },
    {
      "type": "header",
      "content": "Benefit Icons"
    },
    {
      "type": "image_picker",
      "id": "benefit_1_icon",
      "label": "Benefit 1 icon"
    },
    {
      "type": "image_picker",
      "id": "benefit_2_icon",
      "label": "Benefit 2 icon"
    },
    {
      "type": "image_picker",
      "id": "benefit_3_icon",
      "label": "Benefit 3 icon"
    },
    {
      "type": "header",
      "content": "Subscription Benefits"
    },
    {
      "type": "image_picker",
      "id": "sub_tick_icon",
      "label": "Tick icon",
      "info": "Custom checkmark icon for benefit list"
    },
    {
      "type": "text",
      "id": "sub_benefit_1",
      "label": "Benefit 1",
      "default": "Pause or cancel anytime"
    },
    {
      "type": "text",
      "id": "sub_benefit_2",
      "label": "Benefit 2",
      "default": "Monthly, straight to your door"
    },
    {
      "type": "text",
      "id": "sub_benefit_3",
      "label": "Benefit 3",
      "default": "Commit to Cult & save 20%"
    },
    {
      "type": "header",
      "content": "CTA Button"
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "Checkout button text",
      "default": "Checkout"
    }
  ],
  "blocks": [
    {
      "type": "gallery_image",
      "name": "Gallery Image",
      "limit": 12,
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt",
          "label": "Alt text",
          "default": "Product image"
        }
      ]
    },
    {
      "type": "flavor",
      "name": "Flavor Option",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Flavor image"
        },
        {
          "type": "text",
          "id": "name_override",
          "label": "Display name (optional)",
          "info": "Overrides the product title"
        },
        {
          "type": "text",
          "id": "emoji",
          "label": "Emoji (fallback)",
          "default": "üü§",
          "info": "Used if no image is set"
        },
        {
          "type": "text",
          "id": "badge",
          "label": "Badge text (optional)",
          "info": "e.g., 'POPULAR'"
        },
        {
          "type": "text",
          "id": "description",
          "label": "Description",
          "default": "Delicious & nutritious"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shop Purchase Flow"
    }
  ]
}
{% endschema %}
