{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
SHOP PURCHASE FLOW
----------------------------------------------------------------------------------------------------------------------

CRO-optimized product purchase page with:
- Flavor-first selection (IKEA/endowment effect)
- Adaptive size options based on flavor count
- Subscription-first design with 20% savings
- Direct-to-checkout (no cart)

{%- endcomment -%}

<style>
  [x-cloak] { display: none !important; }

  .shop-purchase-flow {
    /* Local variables - map to theme variables for consistency */
    --spf-text-color: rgb(var(--text-primary));
    --spf-text-muted: rgb(var(--text-primary) / 0.6);
    --spf-text-subtle: rgb(var(--text-primary) / 0.4);
    --spf-background: rgb(var(--background-primary));
    --spf-border-color: rgb(var(--text-primary) / 0.12);
    --spf-accent: rgb(var(--accent));
    --spf-success: rgb(var(--success-text));
    --spf-star-color: rgb(var(--star-color));

    /* === NEW DESIGN TOKENS === */
    /* Pink palette */
    --color-pink-dark: #F05E87;
    --color-pink-light: #FFBED6;
    --color-pink-border: #B45B7E;
    /* Neutral palette */
    --color-cream: #F0E9DE;
    --color-border-light: #CDCDCD;
    --color-chevron: #361A05;
    --color-locked-overlay: rgba(54, 26, 5, 0.9);
    --color-locked-border: #361A05;
    /* CTA */
    --color-cta-yellow: #FFE500;
    --color-cta-yellow-hover: #E8C300;

    /* Card gradients */
    --gradient-unselected: linear-gradient(to bottom, #FFFFFF 0%, #F0E9DE 100%);
    --gradient-selected: linear-gradient(to bottom, #F05E87 0%, #FFBED6 100%);
    --gradient-sub-section: linear-gradient(to bottom right, #FFBED6 0%, #F05E87 100%);

    /* Z-index scale */
    --z-base: 1;
    --z-card-hover: 5;
    --z-dropdown: 10;
    --z-sticky: 100;

    /* Semantic colors for badges/CTA - keep brand-specific */
    --spf-cta-background: #93c5fd;
    --spf-cta-hover: #60a5fa;
    --spf-badge-popular: #fbbf24;
    --spf-badge-success: #22c55e;
    --spf-badge-hot: #ff6b35;
    --spf-badge-featured: #ec4899;

    /* Selector box styling - using new gradient system */
    --spf-selector-bg: var(--color-cream);
    --spf-selector-border: var(--color-border-light);
    --spf-selector-selected-bg: {{ section.settings.selected_background | default: '#FFBED6' }};
    --spf-selector-selected-border: {{ section.settings.selected_border | default: '#B45B7E' }};
    --spf-selector-selected-text: {{ section.settings.selected_text | default: '#000000' }};
    --spf-selector-radius: 8px;

    --spf-subscribe-selected: #fef3c7;
    --spf-subscribe-border: #f59e0b;
    --spf-savings-color: var(--color-pink-dark);

    /* Transitions (respecting reduced motion) */
    --transition-fast: 0.1s ease;
    --transition-normal: 0.15s ease-out;

    padding: var(--spacing-8) var(--spacing-5);
    font-family: var(--text-font-family);
  }

  /* Reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .shop-purchase-flow {
      --transition-fast: 0s;
      --transition-normal: 0s;
    }

    .shop-purchase-flow *,
    .shop-purchase-flow *::before,
    .shop-purchase-flow *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Tabular numbers for prices */
  .shop-purchase-flow [class*="price"],
  .shop-purchase-flow [class*="savings"],
  .shop-purchase-flow [class*="per-pack"] {
    font-variant-numeric: tabular-nums;
  }

  /* Focus ring styles for accessibility */
  .shop-purchase-flow :focus-visible {
    outline: 2px solid var(--color-pink-dark);
    outline-offset: 2px;
  }

  /* Remove outline on mouse focus */
  .shop-purchase-flow :focus:not(:focus-visible) {
    outline: none;
  }

  .shop-purchase-flow__container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-8);
  }

  @media screen and (min-width: 1000px) {
    .shop-purchase-flow__container {
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-12);
      align-items: start;
    }
  }

  /* ============================================
     GALLERY COLUMN
     ============================================ */
  .shop-gallery {
    position: relative;
  }

  @media screen and (min-width: 1000px) {
    .shop-gallery {
      position: sticky;
      top: var(--header-height, 100px);
      min-width: 0;  /* Force grid item to respect column width */
    }
  }

  .shop-gallery__main {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 12px;
    overflow: hidden;
    background: #f5f5f5;
  }

  .shop-gallery__main-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
  }

  .shop-gallery__nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .shop-gallery__main:hover .shop-gallery__nav {
    opacity: 1;
  }

  .shop-gallery__nav--prev { left: 12px; }
  .shop-gallery__nav--next { right: 12px; }

  .shop-gallery__nav:hover {
    background: white;
  }

  .shop-gallery__thumbs {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding-bottom: 4px;
  }

  .shop-gallery__thumbs::-webkit-scrollbar {
    display: none;
  }

  .shop-gallery__thumb {
    flex-shrink: 0;
    width: 72px;
    height: 72px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    scroll-snap-align: start;
    transition: border-color 0.15s ease;
  }

  .shop-gallery__thumb--active {
    border-color: var(--spf-text-color);
  }

  .shop-gallery__thumb:hover:not(.shop-gallery__thumb--active) {
    border-color: #ccc;
  }

  .shop-gallery__thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Mobile dots */
  .shop-gallery__dots {
    display: none;
    justify-content: center;
    gap: 8px;
    padding: 12px 0;
  }

  .shop-gallery__dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ccc;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: background 0.15s ease;
  }

  .shop-gallery__dot--active {
    background: var(--spf-text-color);
  }

  @media screen and (max-width: 767px) {
    .shop-gallery {
      min-width: 0;
      overflow: hidden;
    }

    .shop-gallery__main {
      border-radius: 8px;
      margin: 0;
      width: 100%;
    }

    .shop-gallery__nav {
      display: none;
    }

    .shop-gallery__thumbs {
      max-width: 100%;
    }
  }

  /* Benefits badges */
  .shop-gallery__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-2) 0;
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .shop-gallery__benefit-icon {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shop-gallery__benefit-icon img {
    width: 24px;
    height: 24px;
    object-fit: contain;
  }

  /* Benefits in purchase column (shown on both desktop and mobile) */
  .shop-purchase__benefits {
    display: block;
    margin-top: var(--spacing-4);
    padding: 16px;
  }

  /* ============================================
     PURCHASE COLUMN
     ============================================ */
  .shop-purchase {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
  }

  .shop-purchase__header {
    text-align: left;
  }

  .shop-purchase__title {
    font-size: var(--text-h2);
    font-weight: 700;
    margin: 0 0 var(--spacing-2) 0;
    color: var(--spf-text-color);
    font-family: var(--heading-font-family);
    letter-spacing: var(--heading-letter-spacing);
  }

  .shop-purchase__subtitle {
    font-size: var(--text-base);
    color: var(--spf-text-color);
    margin: 0 0 var(--spacing-3) 0;
  }

  .shop-purchase__rating {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .shop-purchase__stars {
    color: var(--spf-star-color);
    letter-spacing: 2px;
  }

  .shop-purchase__stars-image {
    height: 20px;
    width: auto;
  }

  .shop-purchase__divider {
    display: none;
  }

  .shop-purchase__section-title {
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--spf-text-muted);
    margin: 0 0 var(--spacing-3) 0;
  }

  /* ============================================
     FLAVOR SELECTION
     ============================================ */
  .flavor-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .flavor-option {
    padding: var(--spacing-4) var(--spacing-5);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .flavor-option:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .flavor-option--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .flavor-option--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-option--selected .flavor-option__name,
  .flavor-option--selected .flavor-option__description,
  .flavor-option--selected .flavor-option__flavor-list {
    color: var(--spf-text-color);
  }

  .flavor-option--selected .flavor-option__toggle {
    border-color: var(--spf-selector-border);
    color: var(--spf-text-color);
  }

  /* Featured badge styling */
  .flavor-option__badge--featured {
    position: absolute;
    top: -10px;
    right: 16px;
    background: var(--spf-badge-featured);
    color: white;
  }

  .flavor-option--has-badge {
    position: relative;
  }

  /* Dropdown variant for Pick Your Own */
  .flavor-option--dropdown {
    padding: 0;
    overflow: hidden;
  }

  .flavor-option--dropdown .flavor-option__header {
    padding: var(--spacing-4) var(--spacing-5);
    cursor: pointer;
  }

  .flavor-option__toggle {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-2) var(--spacing-3);
    border: 1px solid var(--spf-border-color);
    border-radius: var(--rounded);
    background: transparent;
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
    color: var(--spf-text-color);
  }

  .flavor-option__toggle:hover {
    background: rgb(var(--text-primary) / 0.05);
  }

  .flavor-option__arrow {
    transition: transform 0.2s ease;
    width: 16px;
    height: 16px;
  }

  .flavor-option--expanded .flavor-option__arrow {
    transform: rotate(180deg);
  }

  .flavor-option__content {
    background: white;
    border-top: 1px solid var(--spf-border-color);
    overflow: hidden;
  }

  .flavor-option__content-inner {
    padding: var(--spacing-4);
  }

  /* Flavor list text for Mixed Box */
  .flavor-option__flavor-list {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: var(--spacing-1);
    margin-bottom: 0;
  }

  /* Mixed Box with image variant */
  .flavor-option--mixed {
    display: flex;
    align-items: center;
    padding: 0;
    overflow: hidden;
  }

  .flavor-option__image {
    flex-shrink: 0;
    width: 70px;
    height: 70px;
    margin: 8px;
  }

  .flavor-option__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  .flavor-option__text {
    flex: 1;
    padding: var(--spacing-4) var(--spacing-5);
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* When no image, keep normal padding */
  .flavor-option--mixed:not(:has(.flavor-option__image)) {
    padding: var(--spacing-4) var(--spacing-5);
  }

  .flavor-option__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .flavor-option__left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .flavor-option__radio {
    display: none;
  }

  .flavor-option__emoji {
    font-size: 1.25rem;
  }

  .flavor-option__name {
    font-weight: 600;
    font-size: var(--text-base);
    color: var(--spf-text-color);
  }

  .flavor-option__badge {
    font-size: var(--text-xs);
    padding: 2px var(--spacing-2);
    border-radius: var(--rounded-xs);
    background: var(--spf-badge-popular);
    color: var(--spf-text-color);
    font-weight: 600;
  }

  .flavor-option__description {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: var(--spacing-2);
    padding-left: 32px;
  }

  /* Pick Your Own nested options */
  .flavor-option__nested {
    margin-top: var(--spacing-4);
    padding: var(--spacing-3);
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded);
    opacity: 0.5;
    pointer-events: none;
    transition: opacity var(--transition-normal);
  }

  .flavor-option--selected .flavor-option__nested {
    opacity: 1;
    pointer-events: auto;
  }

  .flavor-checkbox {
    display: flex;
    align-items: center;
    padding: var(--spacing-3);
    border-bottom: 1px solid var(--spf-border-color);
    cursor: pointer;
    transition: background var(--transition-normal);
    border-radius: var(--rounded);
  }

  .flavor-checkbox:last-child {
    border-bottom: none;
  }

  .flavor-checkbox:hover {
    background: rgb(var(--text-primary) / 0.03);
  }

  .flavor-checkbox--checked {
    background: rgb(var(--accent) / 0.05);
  }

  .flavor-checkbox__box {
    width: 20px;
    height: 20px;
    border-radius: var(--rounded-xs);
    border: 2px solid rgb(var(--text-primary) / 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-right: var(--spacing-3);
    transition: all var(--transition-normal);
  }

  .flavor-checkbox--checked .flavor-checkbox__box {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .flavor-checkbox__check {
    color: rgb(var(--background-primary));
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .flavor-checkbox--checked .flavor-checkbox__check {
    opacity: 1;
  }

  .flavor-checkbox__emoji {
    font-size: 1.25rem;
    margin-right: var(--spacing-3);
  }

  .flavor-checkbox__info {
    flex: 1;
  }

  .flavor-checkbox__name {
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .flavor-checkbox__desc {
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
    margin-top: 2px;
  }

  .flavor-checkbox__badge {
    font-size: var(--text-xs);
    padding: 2px 6px;
    border-radius: var(--rounded-xs);
    background: var(--spf-badge-hot);
    color: white;
    font-weight: 600;
    margin-left: auto;
  }

  .flavor-checkbox--disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  /* ============================================
     FLAVOR CARDS (Card-based selectors)
     ============================================ */
  .flavor-cards {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .flavor-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    padding: 0;
    border: 2px solid var(--spf-selector-border);
    border-radius: var(--spf-selector-radius);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .flavor-card:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .flavor-card--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .flavor-card--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-card--disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  .flavor-card__image {
    width: 70px;
    height: 70px;
    margin: 8px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .flavor-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  .flavor-card__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--spf-selector-selected-border) 0%, color-mix(in srgb, var(--spf-selector-selected-border) 70%, white) 100%);
    color: white;
    font-size: 1.5rem;
  }

  .flavor-card__name {
    flex: 1;
    font-weight: 700;
    font-size: var(--text-base);
    text-transform: uppercase;
    color: var(--spf-text-color);
  }

  .flavor-card__checkbox {
    width: 24px;
    height: 24px;
    margin-right: 16px;
    border-radius: 6px;
    border: 2px solid var(--spf-selector-border);
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--transition-normal);
  }

  .flavor-card__checkbox svg {
    width: 14px;
    height: 14px;
    stroke: white;
    stroke-width: 3;
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .flavor-card--selected .flavor-card__checkbox {
    background: var(--spf-selector-selected-border);
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-card--selected .flavor-card__checkbox svg {
    opacity: 1;
  }

  .flavor-card:hover:not(.flavor-card--selected) .flavor-card__checkbox {
    border-color: rgb(var(--text-primary) / 0.3);
  }

  /* Info text below flavor cards */
  .flavor-option__info {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    margin-top: var(--spacing-3);
    padding: var(--spacing-2) var(--spacing-3);
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded);
  }

  .flavor-option__info svg {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    opacity: 0.6;
  }

  /* ============================================
     SIZE CARDS
     ============================================ */
  .size-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-3);
  }

  .size-card {
    position: relative;
    padding: var(--spacing-4) var(--spacing-3);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .size-card:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .size-card--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .size-card--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .size-card:active {
    transform: scale(0.98);
  }

  .size-card__badge {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    padding: 2px var(--spacing-2);
    border-radius: var(--rounded-xs);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .size-card__badge--popular {
    background: var(--spf-badge-popular);
    color: var(--spf-text-color);
  }

  .size-card__badge--free-ship {
    background: var(--spf-badge-success);
    color: white;
  }

  .size-card__label {
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--spf-text-muted);
    margin-bottom: var(--spacing-2);
  }

  .size-card__packs {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .size-card__duration {
    font-size: var(--text-xs);
    color: var(--spf-text-subtle);
    margin-bottom: var(--spacing-3);
  }

  .size-card__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .size-card__per-pack {
    font-size: var(--text-xs);
    color: var(--spf-text-subtle);
    margin-top: 4px;
  }

  /* Size cards mobile overrides */
  @media screen and (max-width: 767px) {
    .size-card {
      padding: var(--spacing-3) var(--spacing-2);
    }

    .size-card__label {
      font-size: 10px;
    }

    .size-card__packs {
      font-size: var(--text-base);
    }

    .size-card__price {
      font-size: 1rem;
    }

    .size-card__per-pack {
      font-size: 10px;
    }
  }

  /* ============================================
     SUBSCRIPTION TOGGLE
     ============================================ */
  .sub-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .sub-option {
    padding: var(--spacing-4) var(--spacing-5);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .sub-option:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .sub-option--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .sub-option--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  /* Subscribe option styling when selected */
  .sub-option--subscribe.sub-option--selected .sub-option__radio {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .sub-option__per-pack {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__per-pack-label {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    font-weight: 400;
  }

  .sub-option__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sub-option__left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .sub-option__radio {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid rgb(var(--text-primary) / 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--transition-normal);
  }

  .sub-option--selected .sub-option__radio {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .sub-option__radio::after {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgb(var(--background-primary));
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .sub-option--selected .sub-option__radio::after {
    opacity: 1;
  }

  .sub-option__title {
    font-weight: 600;
    font-size: var(--text-base);
    color: var(--spf-text-color);
  }

  .sub-option__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__benefits {
    margin-top: var(--spacing-3);
    padding-left: 32px;
  }

  .sub-option__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .sub-option__benefit-icon {
    color: var(--spf-success);
    flex-shrink: 0;
  }

  .sub-option__savings {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--spf-savings-color);
    margin-top: auto;
  }

  /* Subscribe section redesign - two column layout */
  .sub-option__layout {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-4);
  }

  .sub-option__left-col {
    flex: 1;
  }

  .sub-option__right-col {
    text-align: right;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }

  .sub-option__title-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    margin-bottom: var(--spacing-2);
  }

  .sub-option__per-pack {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__per-box {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: 2px;
  }

  .sub-option__benefits {
    margin-top: var(--spacing-2);
    padding-left: 0;
  }

  .sub-option__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .sub-option__benefit img {
    width: 16px;
    height: 16px;
    object-fit: contain;
  }

  /* Subscribe cards mobile overrides */
  @media screen and (max-width: 767px) {
    .sub-option {
      padding: var(--spacing-3) var(--spacing-4);
    }

    .sub-option__title {
      font-size: var(--text-sm);
    }

    .sub-option__benefit {
      font-size: var(--text-xs);
    }

    .sub-option__per-pack {
      font-size: 1.1rem;
    }

    .sub-option__per-box,
    .sub-option__savings {
      font-size: var(--text-xs);
    }
  }

  /* ============================================
     CTA BUTTON
     ============================================ */
  .cta-button {
    width: 100%;
    padding: var(--spacing-5) var(--spacing-6);
    border-radius: 60px;
    background: #FED700;
    color: var(--spf-text-color);
    font-size: var(--text-base);
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
    border: 1px solid #E0C426;
    text-transform: uppercase;
  }

  .cta-button:hover {
    background: #E8C300;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(254, 215, 0, 0.4);
  }

  .cta-button:active {
    transform: translateY(0);
  }

  .cta-button:disabled {
    background: rgb(var(--text-primary) / 0.2);
    color: var(--spf-text-muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .cta-button__summary {
    font-size: var(--text-sm);
    font-weight: 400;
    opacity: 0.8;
    margin-top: 4px;
    text-transform: none;
  }

  /* ============================================
     TRUST BADGES
     ============================================ */
  .trust-badges {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: var(--spacing-4);
    padding: var(--spacing-4) 0;
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
  }

  .trust-badge {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .trust-badge__icon {
    font-size: var(--text-sm);
  }

  /* ============================================
     TESTIMONIAL
     ============================================ */
  .testimonial {
    padding: var(--spacing-4);
    text-align: center;
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded-lg);
  }

  .testimonial__quote {
    font-size: var(--text-sm);
    font-style: italic;
    color: var(--spf-text-color);
    margin: 0 0 var(--spacing-2) 0;
  }

  .testimonial__author {
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
    margin: 0;
  }

  .testimonial__verified {
    color: var(--spf-success);
  }

  /* ============================================
     MOBILE STICKY CTA
     ============================================ */
  .sticky-cta {
    display: none;
  }

  @media screen and (max-width: 999px) {
    .sticky-cta {
      display: block;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--spacing-3) var(--spacing-4);
      padding-bottom: calc(var(--spacing-3) + env(safe-area-inset-bottom));
      background: rgb(var(--background-primary));
      border-top: 1px solid var(--spf-border-color);
      box-shadow: 0 -4px 12px rgb(var(--text-primary) / 0.08);
      z-index: 100;
    }

    .sticky-cta .cta-button {
      padding: var(--spacing-4);
    }

    /* Add padding to bottom of purchase column to prevent content being hidden by sticky CTA */
    .shop-purchase {
      padding-bottom: 100px;
    }
  }

  /* ============================================
     ERROR STATE
     ============================================ */
  .flavor-error {
    color: rgb(var(--error-text));
    font-size: var(--text-sm);
    padding: var(--spacing-2) var(--spacing-3);
    background: rgb(var(--error-background));
    border-radius: var(--rounded);
    margin-top: var(--spacing-2);
  }

  /* ============================================
     FLAVOR TABS (New Design)
     ============================================ */
  .flavor-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: var(--spacing-4);
    overflow-x: auto;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2px;
  }

  .flavor-tabs::-webkit-scrollbar {
    display: none;
  }

  .flavor-tab {
    flex-shrink: 0;
    padding: 10px 20px;
    border-radius: 9999px;
    font-size: var(--text-sm);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: all var(--transition-normal);
    border: 1px solid var(--color-border-light);
    background: white;
    color: var(--spf-text-color);
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .flavor-tab:hover {
    border-color: var(--spf-text-color);
  }

  .flavor-tab--active {
    background: #3C1B04;
    color: #FFFFFF;
    border-color: #3C1B04;
  }

  .flavor-tab--active:hover {
    background: #3C1B04;
  }

  /* ============================================
     FLAVOR DESCRIPTION BLOCK (New Design)
     ============================================ */
  .flavor-description {
    margin-bottom: var(--spacing-6);
  }

  .flavor-description__text {
    font-size: var(--text-base);
    line-height: 1.6;
    color: var(--spf-text-color);
    margin: 0 0 var(--spacing-4) 0;
  }

  .flavor-quote {
    /* Container only - white box styling moved to __text */
  }

  .flavor-quote__text {
    background: white;
    padding: var(--spacing-4);
    border-radius: var(--spf-selector-radius);
    font-size: var(--text-sm);
    font-style: italic;
    color: var(--spf-text-color);
    margin: 0;
    line-height: 1.5;
  }

  .flavor-quote__text::before {
    content: '"';
  }

  .flavor-quote__text::after {
    content: '"';
  }

  .flavor-quote__footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: var(--spacing-2);
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
    padding-top: var(--spacing-2);
  }

  .flavor-quote__stars {
    color: var(--spf-star-color);
    letter-spacing: 1px;
  }

  .flavor-quote__stars-image {
    height: 14px;
    width: auto;
  }

  /* ============================================
     FLAVOR CAROUSEL (New Design)
     ============================================ */
  .flavor-carousel {
    position: relative;
    margin-bottom: var(--spacing-2);
  }

  .flavor-carousel__wrapper {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    padding: 4px;
    margin: -4px;
  }

  .flavor-carousel__wrapper::-webkit-scrollbar {
    display: none;
  }

  .flavor-carousel__card {
    flex-shrink: 0;
    width: calc(33.333% - 8px); /* Match size cards: 3 per row */
    aspect-ratio: 3 / 4;
    border-radius: var(--spf-selector-radius);
    border: 1px solid var(--color-border-light);
    background: var(--gradient-unselected);
    cursor: pointer;
    transition: transform var(--transition-normal), border-color var(--transition-normal);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    scroll-snap-align: start;
    background-image: var(--card-bg-image, none), var(--gradient-unselected);
    background-size: cover, auto;
    background-position: center, center;
    background-repeat: no-repeat, no-repeat;
  }

  .flavor-carousel__card:hover {
    z-index: var(--z-card-hover);
  }

  .flavor-carousel__card--selected {
    background-image: var(--card-bg-image, none), var(--gradient-selected);
    border-color: var(--color-pink-border);
  }

  .flavor-carousel__card--selected:hover {
    border-color: var(--color-pink-border);
  }

  .flavor-carousel__badge {
    position: absolute;
    top: 8px;
    right: 8px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    background: var(--badge-bg, #fbbf24);
    color: var(--badge-text, #000000);
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .flavor-carousel__badge-icon {
    width: 12px;
    height: 12px;
    object-fit: contain;
  }

  /* Image wrapper - hidden when using background image */
  .flavor-carousel__image {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-3);
  }

  .flavor-carousel__image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  /* When card has background image, hide the image wrapper */
  .flavor-carousel__card--has-bg .flavor-carousel__image {
    display: none;
  }

  .flavor-carousel__card--has-bg {
    justify-content: flex-end;
  }

  .flavor-carousel__footer {
    padding: var(--spacing-2) var(--spacing-3);
    text-align: center;
  }

  .flavor-carousel__name {
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--spf-text-color);
    margin-bottom: 2px;
  }

  .flavor-carousel__card--selected .flavor-carousel__name {
    color: var(--spf-text-color); /* Stay dark */
  }

  .flavor-carousel__label {
    font-size: 10px;
    color: var(--spf-text-muted);
    text-transform: uppercase;
  }

  .flavor-carousel__card--selected .flavor-carousel__label {
    color: #BD376B; /* Pink selected label */
  }

  /* Carousel navigation - below carousel, right-aligned */
  .flavor-carousel__nav {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: var(--spacing-3);
  }

  .flavor-carousel__arrow {
    position: static;
    transform: none;
    width: 40px;
    height: 40px;
    min-width: 44px;
    min-height: 44px;
    border-radius: 8px;
    background: var(--gradient-unselected);
    border: 1px solid var(--color-border-light);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity var(--transition-normal);
  }

  .flavor-carousel__arrow:hover {
    opacity: 0.9;
  }

  .flavor-carousel__arrow svg {
    width: 20px;
    height: 20px;
    color: var(--color-chevron);
  }

  /* Mobile: hide arrows (users swipe instead) */
  @media screen and (max-width: 999px) {
    .flavor-carousel__nav {
      display: none;
    }

    .flavor-carousel__card {
      width: calc(33.333% - 8px);
      min-width: 120px;
    }
  }

  /* Desktop: extend carousel past container to viewport edge */
  @media screen and (min-width: 1000px) {
    .flavor-carousel {
      margin-right: calc(-1 * (100vw - 1200px) / 2);
    }

    .flavor-carousel__wrapper {
      padding-right: calc((100vw - 1200px) / 2);
    }

    .flavor-carousel__nav {
      margin-right: calc((100vw - 1200px) / 2);
    }
  }

  /* ============================================
     BOX SIZE CARDS (New Design)
     ============================================ */
  .size-cards--redesign {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .size-card--redesign {
    position: relative;
    padding: var(--spacing-3);
    border-radius: var(--spf-selector-radius);
    border: 1px solid var(--color-border-light);
    background: var(--gradient-unselected);
    text-align: center;
    cursor: pointer;
    transition: transform var(--transition-normal), border-color var(--transition-normal);
    min-height: 44px;
  }

  .size-card--redesign:hover {
    transform: scale(1.02);
    z-index: var(--z-card-hover);
  }

  .size-card--redesign.size-card--selected {
    background: var(--gradient-selected);
    border-color: var(--color-pink-border);
  }

  .size-card--redesign.size-card--selected .size-card__packs,
  .size-card--redesign.size-card--selected .size-card__price,
  .size-card--redesign.size-card--selected .size-card__per-pack {
    color: white;
  }

  .size-card--redesign .size-card__badge {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .size-card--redesign .size-card__image {
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--spacing-2);
  }

  .size-card--redesign .size-card__image img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
  }

  @media screen and (max-width: 999px) {
    .size-cards--redesign {
      gap: 8px;
    }

    .size-card--redesign {
      padding: var(--spacing-2);
    }

    .size-card--redesign .size-card__image {
      height: 60px;
    }

    .size-card--redesign .size-card__packs {
      font-size: var(--text-sm);
    }

    .size-card--redesign .size-card__price {
      font-size: 1rem;
    }
  }

  /* ============================================
     SUB & SAVE SECTION (New Design)
     ============================================ */
  .sub-section {
    border-radius: var(--spf-selector-radius);
    border: 1px solid var(--color-border-light);
    overflow: hidden;
    transition: opacity var(--transition-normal), filter var(--transition-normal);
  }

  .sub-section--active {
    background: var(--gradient-sub-section);
    border-color: var(--color-pink-border);
  }

  .sub-section--inactive {
    opacity: 0.5;
    filter: grayscale(0.5);
  }

  .sub-section__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-4);
    cursor: pointer;
  }

  .sub-section__title-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
  }

  .sub-section__title {
    font-size: var(--text-base);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--spf-text-color);
  }

  .sub-section--active .sub-section__title {
    color: white;
  }

  .sub-section__subtitle {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
  }

  .sub-section--active .sub-section__subtitle {
    color: white;
    opacity: 0.9;
  }

  .sub-section__pricing {
    text-align: right;
  }

  .sub-section__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-section--active .sub-section__price {
    color: white;
  }

  .sub-section__per-pack {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
  }

  .sub-section--active .sub-section__per-pack {
    color: white;
    opacity: 0.9;
  }

  /* iOS-style toggle */
  .sub-toggle {
    position: relative;
    width: 52px;
    height: 32px;
    background: var(--color-border-light);
    border-radius: 16px;
    cursor: pointer;
    transition: background var(--transition-normal);
    flex-shrink: 0;
  }

  .sub-toggle--active {
    background: var(--color-pink-dark);
  }

  .sub-toggle__circle {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 28px;
    height: 28px;
    background: white;
    border-radius: 50%;
    transition: transform var(--transition-normal);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .sub-toggle--active .sub-toggle__circle {
    transform: translateX(20px);
  }

  /* Benefit cards */
  .sub-section__benefits {
    display: flex;
    gap: 12px;
    padding: 0 var(--spacing-4) var(--spacing-4);
  }

  .sub-benefit-card {
    flex: 1;
    aspect-ratio: 1;
    border-radius: var(--spf-selector-radius);
    overflow: hidden;
    position: relative;
  }

  .sub-benefit-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .sub-benefit-card--locked {
    position: relative;
  }

  .sub-benefit-card--locked::after {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--color-locked-overlay);
    border: 1px solid var(--color-locked-border);
    border-radius: var(--spf-selector-radius);
  }

  .sub-benefit-card__lock-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
  }

  /* Benefit list */
  .sub-section__list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2) var(--spacing-4);
    padding: 0 var(--spacing-4) var(--spacing-4);
  }

  .sub-section__list-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .sub-section--active .sub-section__list-item {
    color: white;
  }

  .sub-section__list-item img {
    width: 16px;
    height: 16px;
    object-fit: contain;
  }

  /* Frequency dropdown */
  .sub-section__frequency {
    padding: 0 var(--spacing-4) var(--spacing-4);
  }

  .frequency-dropdown {
    width: 100%;
    padding: var(--spacing-3) var(--spacing-4);
    border: 1px solid var(--color-border-light);
    border-radius: var(--spf-selector-radius);
    background: white;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--spf-text-color);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23361A05' stroke-width='2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
    min-height: 44px;
  }

  /* Savings callout */
  .sub-section__savings {
    padding: var(--spacing-3) var(--spacing-4);
    text-align: center;
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-pink-dark);
    background: rgba(255, 255, 255, 0.3);
  }

  .sub-section--active .sub-section__savings {
    color: white;
  }

  /* ============================================
     ONE-TIME PURCHASE OPTION
     ============================================ */
  .onetime-option {
    padding: var(--spacing-4);
    border-radius: var(--spf-selector-radius);
    border: 1px solid var(--color-border-light);
    background: var(--gradient-unselected);
    cursor: pointer;
    transition: border-color var(--transition-normal);
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 44px;
  }

  .onetime-option:hover {
    border-color: var(--spf-text-color);
  }

  .onetime-option--selected {
    background: var(--gradient-selected);
    border-color: var(--color-pink-border);
  }

  .onetime-option__title {
    font-weight: 600;
    color: var(--spf-text-color);
  }

  .onetime-option--selected .onetime-option__title {
    color: white;
  }

  .onetime-option__price {
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .onetime-option--selected .onetime-option__price {
    color: white;
  }

  /* ============================================
     CTA BUTTON (Updated Yellow)
     ============================================ */
  .cta-button--yellow {
    background: var(--color-cta-yellow);
    border-color: var(--color-cta-yellow-hover);
  }

  .cta-button--yellow:hover {
    background: var(--color-cta-yellow-hover);
    box-shadow: 0 4px 12px rgba(255, 229, 0, 0.4);
  }
</style>

<div
  class="shop-purchase-flow"
  x-data="shopPurchaseFlow()"
  x-init="init()"
>
  <div class="shop-purchase-flow__container">
    <!-- GALLERY COLUMN -->
    <div class="shop-gallery">
      <!-- Main Image -->
      <div class="shop-gallery__main" @touchstart="touchStart($event)" @touchend="touchEnd($event)">
        <template x-for="(image, index) in currentImages" :key="image.id">
          <img
            :src="image.src"
            :alt="image.alt"
            class="shop-gallery__main-image"
            x-show="currentImageIndex === index"
            x-transition.opacity.duration.300ms
            style="position: absolute; top: 0; left: 0;"
          >
        </template>

        <button
          class="shop-gallery__nav shop-gallery__nav--prev"
          @click="prevImage()"
          x-show="currentImages.length > 1"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button
          class="shop-gallery__nav shop-gallery__nav--next"
          @click="nextImage()"
          x-show="currentImages.length > 1"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>

      <!-- Thumbnail Strip (Desktop) -->
      <div class="shop-gallery__thumbs" x-ref="galleryThumbs">
        <template x-for="(image, index) in currentImages" :key="image.id">
          <button
            class="shop-gallery__thumb"
            :class="{ 'shop-gallery__thumb--active': currentImageIndex === index }"
            @click="selectImage(index)"
          >
            <img :src="image.thumb" :alt="image.alt">
          </button>
        </template>
      </div>

      <!-- Dot Indicators (Mobile) -->
      <div class="shop-gallery__dots">
        <template x-for="(image, index) in currentImages" :key="'dot-' + image.id">
          <button
            class="shop-gallery__dot"
            :class="{ 'shop-gallery__dot--active': currentImageIndex === index }"
            @click="selectImage(index)"
          ></button>
        </template>
      </div>

    </div>

    <!-- PURCHASE COLUMN -->
    <div class="shop-purchase">
      <!-- Header -->
      <div class="shop-purchase__header">
        <h1 class="shop-purchase__title">{{ section.settings.title }}</h1>
        <p class="shop-purchase__subtitle">{{ section.settings.subtitle }}</p>
        <div class="shop-purchase__rating">
          {%- if section.settings.rating_image != blank -%}
            <img class="shop-purchase__stars-image" src="{{ section.settings.rating_image | image_url: width: 200 }}" alt="5 star rating" height="20">
          {%- else -%}
            <span class="shop-purchase__stars">★★★★★</span>
          {%- endif -%}
          <span>{{ section.settings.reviews_text }}</span>
        </div>

        <!-- Benefits -->
        <div class="shop-purchase__benefits">
          <div class="shop-gallery__benefit">
            {%- if section.settings.benefit_1_icon != blank -%}
              <span class="shop-gallery__benefit-icon">
                <img src="{{ section.settings.benefit_1_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              </span>
            {%- endif -%}
            <span>{{ section.settings.benefit_1 }}</span>
          </div>
          <div class="shop-gallery__benefit">
            {%- if section.settings.benefit_2_icon != blank -%}
              <span class="shop-gallery__benefit-icon">
                <img src="{{ section.settings.benefit_2_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              </span>
            {%- endif -%}
            <span>{{ section.settings.benefit_2 }}</span>
          </div>
          <div class="shop-gallery__benefit">
            {%- if section.settings.benefit_3_icon != blank -%}
              <span class="shop-gallery__benefit-icon">
                <img src="{{ section.settings.benefit_3_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              </span>
            {%- endif -%}
            <span>{{ section.settings.benefit_3 }}</span>
          </div>
        </div>
      </div>

      <hr class="shop-purchase__divider">

      <!-- FLAVOR TABS (New Design) -->
      <div>
        <div class="flavor-tabs" role="tablist">
          {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
          {%- if flavor_blocks.size > 0 -%}
            {%- comment -%} Only render tabs for non-bundle flavors (individual flavors) {%- endcomment -%}
            {%- for block in flavor_blocks -%}
              {%- unless block.settings.is_bundle -%}
                {%- assign flavor_product = block.settings.product -%}
                {%- if flavor_product != blank -%}
                  {%- assign flavor_name = block.settings.name_override | default: flavor_product.title | remove: 'Overnight Gut Oats |' | strip | upcase -%}
                  <button
                    class="flavor-tab"
                    :class="{ 'flavor-tab--active': activeFlavorTab === {{ flavor_product.id }} }"
                    :style="activeFlavorTab === {{ flavor_product.id }} ? 'background: {{ block.settings.pill_selected_bg | default: '#3C1B04' }}; color: {{ block.settings.pill_selected_text | default: '#FFFFFF' }}; border-color: {{ block.settings.pill_selected_border | default: '#3C1B04' }};' : ''"
                    @click="setFlavorTab({{ flavor_product.id }})"
                    role="tab"
                    :aria-selected="activeFlavorTab === {{ flavor_product.id }}"
                    {{ block.shopify_attributes }}
                  >
                    {{ flavor_name }}
                  </button>
                {%- endif -%}
              {%- endunless -%}
            {%- endfor -%}
          {%- else -%}
            {%- comment -%} Fallback: render tabs from collection {%- endcomment -%}
            {%- for product in collections['breakfast'].products limit: 4 -%}
              {%- unless product.title contains 'Mixed' -%}
                {%- assign flavor_name = product.title | remove: 'Overnight Gut Oats |' | strip | upcase -%}
                <button
                  class="flavor-tab"
                  :class="{ 'flavor-tab--active': activeFlavorTab === {{ product.id }} }"
                  @click="setFlavorTab({{ product.id }})"
                  role="tab"
                  :aria-selected="activeFlavorTab === {{ product.id }}"
                >
                  {{ flavor_name }}
                </button>
              {%- endunless -%}
            {%- endfor -%}
          {%- endif -%}
        </div>

        <!-- Flavor Description Block -->
        <div class="flavor-description">
          <p class="flavor-description__text" x-text="getFlavorDescription(activeFlavorTab)"></p>
          <div class="flavor-quote" x-show="getFlavorTestimonial(activeFlavorTab).quote">
            <p class="flavor-quote__text" x-text="getFlavorTestimonial(activeFlavorTab).quote"></p>
            <div class="flavor-quote__footer">
              {%- if section.settings.rating_image != blank -%}
                <img class="flavor-quote__stars-image" src="{{ section.settings.rating_image | image_url: width: 100 }}" alt="5 stars" height="14">
              {%- else -%}
                <span class="flavor-quote__stars">★★★★★</span>
              {%- endif -%}
              <span x-text="getFlavorTestimonial(activeFlavorTab).author + ', verified buyer'"></span>
            </div>
          </div>
        </div>
      </div>

      <hr class="shop-purchase__divider">

      <!-- FLAVOR CAROUSEL (New Design) -->
      <div>
        <p class="shop-purchase__section-title">{{ section.settings.flavors_title | default: 'Choose your flavours' }}</p>
        <div class="flavor-carousel">
          <div class="flavor-carousel__wrapper" x-ref="flavorCarousel">
            {%- comment -%} Render all flavor_option blocks uniformly {%- endcomment -%}
            {%- if flavor_blocks.size > 0 -%}
              {%- for block in flavor_blocks -%}
                {%- assign block_product = block.settings.product -%}
                {%- if block_product != blank -%}
                  {%- assign display_name = block.settings.name_override | default: block_product.title | remove: 'Overnight Gut Oats |' | strip | upcase -%}
                  {%- assign card_bg = block.settings.card_background -%}
                  {%- assign card_image = block.settings.card_image -%}
                  {%- assign is_bundle = block.settings.is_bundle -%}
                  {%- assign subtitle = block.settings.subtitle -%}
                  <div
                    class="flavor-carousel__card{% if card_bg != blank %} flavor-carousel__card--has-bg{% endif %}"
                    :class="{
                      'flavor-carousel__card--selected': {% if is_bundle %}selectedBundle === {{ block_product.id }}{% else %}selectedFlavors.includes({{ block_product.id }}){% endif %}
                    }"
                    @click="selectOption({{ block_product.id }}, {{ is_bundle }})"
                    @keydown.enter="selectOption({{ block_product.id }}, {{ is_bundle }})"
                    @keydown.space.prevent="selectOption({{ block_product.id }}, {{ is_bundle }})"
                    tabindex="0"
                    role="option"
                    :aria-selected="{% if is_bundle %}selectedBundle === {{ block_product.id }}{% else %}selectedFlavors.includes({{ block_product.id }}){% endif %}"
                    {{ block.shopify_attributes }}
                    {%- if card_bg != blank %}
                    style="--card-bg-image: url('{{ card_bg | image_url: width: 600 }}')"
                    {%- endif %}
                  >
                    {%- if block.settings.show_badge and section.settings.bestseller_badge_text != blank -%}
                      <span
                        class="flavor-carousel__badge"
                        style="--badge-bg: {{ section.settings.bestseller_badge_bg | default: '#fbbf24' }}; --badge-text: {{ section.settings.bestseller_badge_text_color | default: '#000000' }};"
                      >
                        {%- if section.settings.bestseller_badge_icon != blank -%}
                          <img
                            class="flavor-carousel__badge-icon"
                            src="{{ section.settings.bestseller_badge_icon | image_url: width: 24 }}"
                            alt=""
                          >
                        {%- endif -%}
                        {{ section.settings.bestseller_badge_text }}
                      </span>
                    {%- endif -%}
                    <div class="flavor-carousel__image">
                      {%- if card_image != blank -%}
                        <img src="{{ card_image | image_url: width: 300 }}" alt="{{ display_name }}" loading="lazy">
                      {%- elsif block_product.featured_image != blank -%}
                        <img src="{{ block_product.featured_image | image_url: width: 300 }}" alt="{{ display_name }}" loading="lazy">
                      {%- endif -%}
                    </div>
                    <div class="flavor-carousel__footer">
                      <div class="flavor-carousel__name">{{ display_name }}</div>
                      {%- if is_bundle -%}
                        <div class="flavor-carousel__label" x-text="selectedBundle === {{ block_product.id }} ? 'Selected' : '{{ subtitle | default: '' }}'"></div>
                      {%- else -%}
                        <div class="flavor-carousel__label" x-text="selectedFlavors.includes({{ block_product.id }}) ? 'Selected' : '{{ subtitle | default: '' }}'"></div>
                      {%- endif -%}
                    </div>
                  </div>
                {%- endif -%}
              {%- endfor -%}
            {%- else -%}
              {%- comment -%} Fallback: render from collection if no blocks configured {%- endcomment -%}
              {%- for product in collections['breakfast'].products limit: 4 -%}
                {%- assign flavor_name = product.title | remove: 'Overnight Gut Oats |' | strip | upcase -%}
                {%- assign is_mixed = false -%}
                {%- if product.title contains 'Mixed' -%}
                  {%- assign is_mixed = true -%}
                {%- endif -%}
                <div
                  class="flavor-carousel__card"
                  :class="{
                    'flavor-carousel__card--selected': {% if is_mixed %}selectedBundle === {{ product.id }}{% else %}selectedFlavors.includes({{ product.id }}){% endif %}
                  }"
                  @click="selectOption({{ product.id }}, {{ is_mixed }})"
                  @keydown.enter="selectOption({{ product.id }}, {{ is_mixed }})"
                  @keydown.space.prevent="selectOption({{ product.id }}, {{ is_mixed }})"
                  tabindex="0"
                  role="option"
                  :aria-selected="{% if is_mixed %}selectedBundle === {{ product.id }}{% else %}selectedFlavors.includes({{ product.id }}){% endif %}"
                >
                  <div class="flavor-carousel__image">
                    {%- if product.featured_image != blank -%}
                      <img src="{{ product.featured_image | image_url: width: 300 }}" alt="{{ flavor_name }}" loading="lazy">
                    {%- endif -%}
                  </div>
                  <div class="flavor-carousel__footer">
                    <div class="flavor-carousel__name">{{ flavor_name }}</div>
                    {%- if is_mixed -%}
                      <div class="flavor-carousel__label" x-text="selectedBundle === {{ product.id }} ? 'Selected' : 'All 3'"></div>
                    {%- else -%}
                      <div class="flavor-carousel__label" x-text="selectedFlavors.includes({{ product.id }}) ? 'Selected' : ''"></div>
                    {%- endif -%}
                  </div>
                </div>
              {%- endfor -%}
            {%- endif -%}
          </div>

          <div class="flavor-carousel__nav">
            <button
              class="flavor-carousel__arrow"
              @click="scrollCarousel('prev')"
              aria-label="Previous flavor"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <button
              class="flavor-carousel__arrow"
              @click="scrollCarousel('next')"
              aria-label="Next flavor"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </div>
        </div>

        <!-- Error message -->
        <div class="flavor-error" x-show="selectedBundle === null && selectedFlavors.length === 0" x-cloak>
          Please select at least one flavor
        </div>
      </div>

      <hr class="shop-purchase__divider">

      <!-- SIZE CARDS (New Design) -->
      <div>
        <p class="shop-purchase__section-title">{{ section.settings.size_title | default: 'Choose your box size' }}</p>
        <div class="size-cards size-cards--redesign">
          <template x-for="size in availableSizes" :key="size.id">
            <div
              class="size-card size-card--redesign"
              :class="{ 'size-card--selected': selectedSize === size.id }"
              @click="selectedSize = size.id"
              @keydown.enter="selectedSize = size.id"
              @keydown.space.prevent="selectedSize = size.id"
              tabindex="0"
              role="option"
              :aria-selected="selectedSize === size.id"
            >
              <template x-if="size.badge">
                <div class="size-card__badge" :class="size.badgeClass" x-text="size.badge"></div>
              </template>
              <div class="size-card__image">
                <template x-if="size.id === 9">
                  <div>
                    {%- if section.settings.size_card_image_9 != blank -%}
                      <img src="{{ section.settings.size_card_image_9 | image_url: width: 200 }}" alt="9 pack" loading="lazy">
                    {%- endif -%}
                  </div>
                </template>
                <template x-if="size.id === 18">
                  <div>
                    {%- if section.settings.size_card_image_18 != blank -%}
                      <img src="{{ section.settings.size_card_image_18 | image_url: width: 200 }}" alt="18 pack" loading="lazy">
                    {%- endif -%}
                  </div>
                </template>
                <template x-if="size.id === 27">
                  <div>
                    {%- if section.settings.size_card_image_27 != blank -%}
                      <img src="{{ section.settings.size_card_image_27 | image_url: width: 200 }}" alt="27 pack" loading="lazy">
                    {%- endif -%}
                  </div>
                </template>
              </div>
              <div class="size-card__packs" x-text="size.packsLabel"></div>
              <div class="size-card__price" x-text="formatPrice(getSizePrice(size.id))"></div>
              <div class="size-card__per-pack" x-text="formatPrice(getSizePrice(size.id) / (size.id * effectiveFlavorCount)) + '/pack'"></div>
            </div>
          </template>
        </div>
      </div>

      <hr class="shop-purchase__divider">

      <!-- SUB & SAVE SECTION (New Design) -->
      <div class="sub-section-wrapper" style="display: flex; flex-direction: column; gap: var(--spacing-3);">
        <!-- Sub & Save Section with Toggle -->
        <div
          class="sub-section"
          :class="{
            'sub-section--active': subscribe,
            'sub-section--inactive': !subscribe
          }"
        >
          <div class="sub-section__header" @click="subscribe = !subscribe">
            <div class="sub-section__title-row">
              <div
                class="sub-toggle"
                :class="{ 'sub-toggle--active': subscribe }"
                role="switch"
                :aria-checked="subscribe"
                tabindex="0"
                @keydown.enter="subscribe = !subscribe"
                @keydown.space.prevent="subscribe = !subscribe"
              >
                <div class="sub-toggle__circle"></div>
              </div>
              <div>
                <div class="sub-section__title">SUB & SAVE</div>
                <div class="sub-section__subtitle">Join the Cult and get rewarded for life</div>
              </div>
            </div>
            <div class="sub-section__pricing">
              <div class="sub-section__price" x-text="formatPrice(getTotalPrice(true))"></div>
              <div class="sub-section__per-pack" x-text="getPerPackPrice(true) + '/pack'"></div>
            </div>
          </div>

          <!-- Benefit Cards -->
          <div class="sub-section__benefits" x-show="subscribe" x-collapse>
            <!-- 20% OFF Always Card -->
            <div class="sub-benefit-card">
              {%- if section.settings.sub_benefit_card_1 != blank -%}
                <img src="{{ section.settings.sub_benefit_card_1 | image_url: width: 400 }}" alt="20% OFF ALWAYS" loading="lazy">
              {%- else -%}
                <div style="background: var(--gradient-selected); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; text-align: center; padding: var(--spacing-2);">
                  <div>
                    <div style="font-size: 1.5rem;">20% OFF</div>
                    <div style="font-size: var(--text-xs);">ALWAYS</div>
                  </div>
                </div>
              {%- endif -%}
            </div>

            <!-- Free Delivery Card (Locked/Unlocked) -->
            <div
              class="sub-benefit-card"
              :class="{ 'sub-benefit-card--locked': !isFreeShippingUnlocked() }"
            >
              <!-- Unlocked State -->
              <template x-if="isFreeShippingUnlocked()">
                {%- if section.settings.sub_benefit_card_2_unlocked != blank -%}
                  <img src="{{ section.settings.sub_benefit_card_2_unlocked | image_url: width: 400 }}" alt="FREE DELIVERY UNLOCKED" loading="lazy">
                {%- else -%}
                  <div style="background: white; border: 1px solid var(--color-pink-border); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: var(--spacing-2); border-radius: var(--spf-selector-radius);">
                    <div>
                      <div style="font-size: var(--text-xs); color: var(--spf-text-muted);">27 PACK UNLOCKS</div>
                      <div style="font-size: 1rem; font-weight: 700;">FREE DELIVERY</div>
                    </div>
                  </div>
                {%- endif -%}
              </template>

              <!-- Locked State -->
              <template x-if="!isFreeShippingUnlocked()">
                {%- if section.settings.sub_benefit_card_2_locked != blank -%}
                  <img src="{{ section.settings.sub_benefit_card_2_locked | image_url: width: 400 }}" alt="FREE DELIVERY - LOCKED" loading="lazy">
                {%- else -%}
                  <div style="background: var(--color-locked-overlay); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: var(--spacing-2); border-radius: var(--spf-selector-radius); border: 1px solid var(--color-locked-border);">
                    <div style="color: white; opacity: 0.7;">
                      <div style="font-size: 1.5rem;">🔒</div>
                      <div style="font-size: var(--text-xs);">FREE DELIVERY</div>
                    </div>
                  </div>
                {%- endif -%}
              </template>
            </div>
          </div>

          <!-- Benefit List -->
          <div class="sub-section__list" x-show="subscribe" x-collapse>
            <div class="sub-section__list-item">
              {%- if section.settings.sub_tick_icon != blank -%}
                <img src="{{ section.settings.sub_tick_icon | image_url: width: 32 }}" alt="" width="16" height="16">
              {%- else -%}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              {%- endif -%}
              <span>{{ section.settings.sub_benefit_1 | default: 'Pause or cancel anytime' }}</span>
            </div>
            <div class="sub-section__list-item">
              {%- if section.settings.sub_tick_icon != blank -%}
                <img src="{{ section.settings.sub_tick_icon | image_url: width: 32 }}" alt="" width="16" height="16">
              {%- else -%}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              {%- endif -%}
              <span>{{ section.settings.sub_benefit_2 | default: 'Change your flavours' }}</span>
            </div>
            <div class="sub-section__list-item">
              {%- if section.settings.sub_tick_icon != blank -%}
                <img src="{{ section.settings.sub_tick_icon | image_url: width: 32 }}" alt="" width="16" height="16">
              {%- else -%}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              {%- endif -%}
              <span>{{ section.settings.sub_benefit_3 | default: 'Save 20% on future orders' }}</span>
            </div>
          </div>

          <!-- Frequency Dropdown -->
          <div class="sub-section__frequency" x-show="subscribe" x-collapse>
            <select
              class="frequency-dropdown"
              x-model="selectedFrequency"
              aria-label="Delivery frequency"
            >
              <template x-for="plan in sellingPlans" :key="plan.id">
                <option :value="plan.id" x-text="plan.name"></option>
              </template>
            </select>
          </div>

          <!-- Savings Callout -->
          <div class="sub-section__savings" x-show="subscribe" x-collapse>
            YOU'RE SAVING <span x-text="formatPrice(getSavings())"></span>
          </div>
        </div>

        <!-- One-time Purchase Option -->
        <div
          class="onetime-option"
          :class="{ 'onetime-option--selected': !subscribe }"
          @click="subscribe = false"
          @keydown.enter="subscribe = false"
          @keydown.space.prevent="subscribe = false"
          tabindex="0"
          role="option"
          :aria-selected="!subscribe"
        >
          <span class="onetime-option__title">One-time purchase</span>
          <span class="onetime-option__price" x-text="formatPrice(getTotalPrice(false))"></span>
        </div>
      </div>

      <!-- CTA Button (Desktop) -->
      <div class="desktop-cta">
        <button
          class="cta-button cta-button--yellow"
          @click="checkout()"
          :disabled="!canCheckout"
        >
          {{ section.settings.cta_button_text | default: 'BUY NOW' }} - <span x-text="formatPrice(getTotalPrice(subscribe))"></span>
        </button>
      </div>

      <!-- Trust Badges -->
      <div class="trust-badges">
        <span class="trust-badge">
          <span class="trust-badge__icon">🔒</span>
          <span>Secure checkout</span>
        </span>
      </div>

      <!-- Testimonial -->
      <div class="testimonial">
        <p class="testimonial__quote">"{{ section.settings.testimonial_quote }}"</p>
        <p class="testimonial__author">— {{ section.settings.testimonial_author }} <span class="testimonial__verified">✓ Verified subscriber</span></p>
      </div>
    </div>
  </div>

  <!-- Mobile Sticky CTA -->
  <div class="sticky-cta">
    <button
      class="cta-button cta-button--yellow"
      @click="checkout()"
      :disabled="!canCheckout"
    >
      {{ section.settings.cta_button_text | default: 'BUY NOW' }} - <span x-text="formatPrice(getTotalPrice(subscribe))"></span>
    </button>
  </div>
</div>

<script>
  function shopPurchaseFlow() {
    return {
      // Product data (populated from Liquid)
      // Merge products from collection and flavor blocks
      products: {
        {%- assign products_first = true -%}
        {%- assign included_product_ids = '' -%}
        {%- comment -%} First, add products from collection {%- endcomment -%}
        {%- for product in collections['breakfast'].products limit: 4 -%}
          {%- unless included_product_ids contains product.id -%}
            {%- unless products_first -%},{%- endunless -%}
            {%- assign products_first = false -%}
            {%- if included_product_ids != '' -%}{%- assign included_product_ids = included_product_ids | append: ',' -%}{%- endif -%}
            {%- assign included_product_ids = included_product_ids | append: product.id -%}
            {{ product.id }}: {
              id: {{ product.id }},
              title: {{ product.title | json }},
              handle: {{ product.handle | json }},
              isMixed: {% if product.title contains 'Mixed' %}true{% else %}false{% endif %},
              images: [
                {%- for image in product.images -%}
                  {
                    id: {{ image.id }},
                    src: {{ image.src | image_url: width: 800 | json }},
                    thumb: {{ image.src | image_url: width: 150 | json }},
                    alt: {{ image.alt | default: product.title | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              variants: {
                {%- for variant in product.variants -%}
                  {{ variant.id }}: {
                    id: {{ variant.id }},
                    title: {{ variant.title | json }},
                    price: {{ variant.price }},
                    packs: {{ variant.title | remove: 'Pack' | remove: ' ' | times: 1 }},
                    sellingPlanId: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.selling_plan.id }}{% else %}null{% endif %},
                    discountPercent: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.price_adjustments.first.value | default: 0 }}{% else %}0{% endif %}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              }
            }
          {%- endunless -%}
        {%- endfor -%}
        {%- comment -%} Add products from flavor blocks that aren't already included {%- endcomment -%}
        {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
        {%- for block in flavor_blocks -%}
          {%- assign flavor_product = block.settings.product -%}
          {%- if flavor_product != blank -%}
            {%- unless included_product_ids contains flavor_product.id -%}
              {%- unless products_first -%},{%- endunless -%}
              {%- assign products_first = false -%}
              {%- if included_product_ids != '' -%}{%- assign included_product_ids = included_product_ids | append: ',' -%}{%- endif -%}
              {%- assign included_product_ids = included_product_ids | append: flavor_product.id -%}
              {{ flavor_product.id }}: {
                id: {{ flavor_product.id }},
                title: {{ flavor_product.title | json }},
                handle: {{ flavor_product.handle | json }},
                isMixed: {% if flavor_product.title contains 'Mixed' %}true{% else %}false{% endif %},
                images: [
                  {%- for image in flavor_product.images -%}
                    {
                      id: {{ image.id }},
                      src: {{ image.src | image_url: width: 800 | json }},
                      thumb: {{ image.src | image_url: width: 150 | json }},
                      alt: {{ image.alt | default: flavor_product.title | json }}
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                ],
                variants: {
                  {%- for variant in flavor_product.variants -%}
                    {{ variant.id }}: {
                      id: {{ variant.id }},
                      title: {{ variant.title | json }},
                      price: {{ variant.price }},
                      packs: {{ variant.title | remove: 'Pack' | remove: ' ' | times: 1 }},
                      sellingPlanId: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.selling_plan.id }}{% else %}null{% endif %},
                      discountPercent: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.price_adjustments.first.value | default: 0 }}{% else %}0{% endif %}
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                }
              }
            {%- endunless -%}
          {%- endif -%}
        {%- endfor -%}
      },

      // State
      selectedBundle: null, // Product ID of selected bundle, or null
      selectedFlavors: [], // Array of selected individual flavor IDs
      bundleProductIds: [
        {%- assign bundle_ids_first = true -%}
        {%- for block in flavor_blocks -%}
          {%- if block.settings.is_bundle and block.settings.product != blank -%}
            {%- unless bundle_ids_first -%},{%- endunless -%}
            {%- assign bundle_ids_first = false -%}
            {{ block.settings.product.id }}
          {%- endif -%}
        {%- endfor -%}
        {%- comment -%}Fallback: include mixed box from collection if no bundle blocks{%- endcomment -%}
        {%- if bundle_ids_first -%}
          {%- for product in collections['breakfast'].products limit: 4 -%}
            {%- if product.title contains 'Mixed' -%}
              {{ product.id }}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      ],
      firstFlavorId: {%- for block in flavor_blocks -%}{%- unless block.settings.is_bundle -%}{%- if block.settings.product != blank -%}{{ block.settings.product.id }}{%- break -%}{%- endif -%}{%- endunless -%}{%- endfor -%},
      selectedSize: 18, // 9, 18, or 27 packs
      subscribe: true,
      currentImageIndex: 0,
      discountPercent: 20, // Default, will be set from first variant with selling plan
      pickOwnExpanded: false, // Manual toggle for Pick Your Own dropdown

      // NEW STATE for redesign
      activeFlavorTab: null, // Product ID of active tab (for preview/description)
      selectedFrequency: null, // Selling plan ID (default to 4-week plan)

      // Flavor data with descriptions and testimonials (from Liquid)
      flavorData: {
        {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
        {%- assign flavor_data_first = true -%}
        {%- for block in flavor_blocks -%}
          {%- assign flavor_product = block.settings.product -%}
          {%- if flavor_product != blank -%}
            {%- unless flavor_data_first -%},{%- endunless -%}
            {%- assign flavor_data_first = false -%}
            {{ flavor_product.id }}: {
              description: {{ block.settings.description | default: flavor_product.description | strip_html | truncate: 300 | json }},
              testimonialQuote: {{ block.settings.testimonial_quote | default: '' | json }},
              testimonialAuthor: {{ block.settings.testimonial_author | default: 'Customer' | json }}
            }
          {%- endif -%}
        {%- endfor -%}
        {%- if flavor_blocks.size == 0 -%}
          {%- assign fallback_first = true -%}
          {%- for product in collections['breakfast'].products limit: 4 -%}
            {%- unless product.title contains 'Mixed' -%}
              {%- unless fallback_first -%},{%- endunless -%}
              {%- assign fallback_first = false -%}
              {{ product.id }}: {
                description: {{ product.description | strip_html | truncate: 300 | json }},
                testimonialQuote: "",
                testimonialAuthor: "Customer"
              }
            {%- endunless -%}
          {%- endfor -%}
        {%- endif -%}
      },

      // Selling plans (from Liquid)
      sellingPlans: [
        {%- for product in collections['breakfast'].products limit: 1 -%}
          {%- for variant in product.variants limit: 1 -%}
            {%- for allocation in variant.selling_plan_allocations -%}
              {
                id: {{ allocation.selling_plan.id }},
                name: {{ allocation.selling_plan.name | json }}
              }{% unless forloop.last %},{% endunless %}
            {%- endfor -%}
          {%- endfor -%}
        {%- endfor -%}
      ],

      // Gallery images from all individual flavor products (not bundles)
      galleryImages: [
        {%- assign gallery_first = true -%}
        {%- for block in section.blocks -%}
          {%- if block.type == 'flavor_option' and block.settings.is_bundle != true -%}
            {%- assign flavor_product = block.settings.product -%}
            {%- if flavor_product != blank -%}
              {%- for image in flavor_product.images -%}
                {%- unless gallery_first -%},{%- endunless -%}
                {%- assign gallery_first = false -%}
                {
                  id: 'gallery-{{ flavor_product.id }}-{{ forloop.index }}',
                  src: {{ image | image_url: width: 800 | json }},
                  thumb: {{ image | image_url: width: 150 | json }},
                  alt: {{ image.alt | default: flavor_product.title | json }},
                  flavorId: {{ flavor_product.id }}
                }
              {%- endfor -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      ],

      // Touch tracking for swipe
      touchStartX: 0,
      touchEndX: 0,

      // Computed
      get mixedBoxProduct() {
        return Object.values(this.products).find(p => p.isMixed);
      },

      get individualProducts() {
        return Object.values(this.products).filter(p => !p.isMixed);
      },

      get currentImages() {
        return this.galleryImages;
      },

      get effectiveFlavorCount() {
        if (this.selectedBundle !== null) return 1;
        return Math.max(1, this.selectedFlavors.length);
      },

      get availableSizes() {
        const count = this.effectiveFlavorCount;

        if (count === 1) {
          return [
            { id: 9, label: 'Starter', packsLabel: '9 packs', duration: '~1 week', perPack: '2.00', badge: '', badgeClass: '' },
            { id: 18, label: 'Popular', packsLabel: '18 packs', duration: '~2 weeks', perPack: '2.00', badge: '⭐ POPULAR', badgeClass: 'size-card__badge--popular' },
            { id: 27, label: 'Best Value', packsLabel: '27 packs', duration: '~3 weeks', perPack: '2.00', badge: '🚚 FREE SHIP', badgeClass: 'size-card__badge--free-ship' }
          ];
        } else if (count === 2) {
          return [
            { id: 9, label: '9 Each', packsLabel: '18 total', duration: '9 per flavor', perPack: '2.00', badge: '', badgeClass: '' },
            { id: 18, label: '18 Each', packsLabel: '36 total', duration: '18 per flavor', perPack: '2.00', badge: '🚚 FREE SHIP', badgeClass: 'size-card__badge--free-ship' }
          ];
        } else {
          // 3 flavors
          return [
            { id: 9, label: '9 Each', packsLabel: '27 total', duration: '9 per flavor', perPack: '2.00', badge: '', badgeClass: '' },
            { id: 18, label: '18 Each', packsLabel: '54 total', duration: '18 per flavor', perPack: '2.00', badge: '🚚 FREE SHIP', badgeClass: 'size-card__badge--free-ship' }
          ];
        }
      },

      get canCheckout() {
        if (this.selectedBundle !== null) return true;
        return this.selectedFlavors.length > 0;
      },

      // Methods
      init() {
        // Get discount percent from first variant with a selling plan
        for (const product of Object.values(this.products)) {
          for (const variant of Object.values(product.variants)) {
            if (variant.discountPercent > 0) {
              this.discountPercent = variant.discountPercent;
              break;
            }
          }
          if (this.discountPercent !== 20) break;
        }

        // Set default active flavor tab (first non-bundle block in visual order)
        if (this.firstFlavorId) {
          this.activeFlavorTab = this.firstFlavorId;
        } else if (this.individualProducts[0]) {
          this.activeFlavorTab = this.individualProducts[0].id;
        }

        // Set default frequency (prefer 4 weeks, or first available)
        if (this.sellingPlans.length > 0) {
          // Look for a 4-week plan
          const fourWeekPlan = this.sellingPlans.find(p =>
            p.name.toLowerCase().includes('4 week') ||
            p.name.toLowerCase().includes('every 4')
          );
          this.selectedFrequency = fourWeekPlan ? fourWeekPlan.id : this.sellingPlans[0].id;
        }

        // Ensure selected size is valid for current flavor count
        this.$watch('effectiveFlavorCount', (count) => {
          const validSizes = this.availableSizes.map(s => s.id);
          if (!validSizes.includes(this.selectedSize)) {
            this.selectedSize = validSizes[0];
          }
        });

        // Auto-select first bundle if no flavors selected (prevent empty state)
        this.$watch('selectedFlavors', (flavors) => {
          if (this.selectedBundle === null && flavors.length === 0) {
            // Small delay to allow for intentional deselection
            setTimeout(() => {
              if (this.selectedBundle === null && this.selectedFlavors.length === 0) {
                // Select first bundle
                if (this.bundleProductIds.length > 0) {
                  this.selectedBundle = this.bundleProductIds[0];
                }
              }
            }, 100);
          }
        });

        // Set default selection to first bundle
        if (this.bundleProductIds.length > 0) {
          this.selectedBundle = this.bundleProductIds[0];
        }
      },

      // Set active flavor tab (for preview/description, doesn't affect selection)
      // Also scrolls gallery to that flavor's first image
      setFlavorTab(productId) {
        this.activeFlavorTab = productId;
        // Scroll gallery to this flavor's first image
        const index = this.getFlavorImageIndex(productId);
        if (index >= 0) {
          this.scrollToImage(index);
        }
      },

      // Find the index of the first gallery image belonging to a flavor
      getFlavorImageIndex(flavorId) {
        return this.galleryImages.findIndex(img => img.flavorId === flavorId);
      },

      // Scroll gallery to a specific image index with smooth scroll
      scrollToImage(index) {
        this.currentImageIndex = index;

        // Also scroll thumbnail strip to show this image
        this.$nextTick(() => {
          const thumbs = this.$refs.galleryThumbs;
          const activeThumb = thumbs?.children[index];
          if (activeThumb) {
            activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
          }
        });
      },

      // Get flavor description from data (with fallback)
      getFlavorDescription(productId) {
        if (!productId) return '';
        const data = this.flavorData[productId];
        if (data && data.description) {
          return data.description;
        }
        // Fallback to product description
        const product = this.products[productId];
        return product ? product.title.replace('Overnight Gut Oats |', '').trim() + ' - delicious and nutritious.' : '';
      },

      // Get testimonial data for flavor
      getFlavorTestimonial(productId) {
        if (!productId) return { quote: '', author: '' };
        const data = this.flavorData[productId];
        if (data) {
          return {
            quote: data.testimonialQuote || '',
            author: data.testimonialAuthor || 'Customer'
          };
        }
        return { quote: '', author: 'Customer' };
      },

      // Check if free shipping is unlocked (£40 threshold)
      isFreeShippingUnlocked() {
        return this.getTotalPrice(this.subscribe) >= 4000; // £40 in pence
      },

      // Scroll the flavor carousel
      scrollCarousel(direction) {
        const carousel = this.$refs.flavorCarousel;
        if (!carousel) return;

        const cardWidth = carousel.querySelector('.flavor-carousel__card')?.offsetWidth || 150;
        const gap = 12;
        const scrollAmount = cardWidth + gap;

        if (direction === 'next') {
          carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        } else {
          carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        }
      },

      // Select a flavor option (handles both bundles and individual flavors)
      selectOption(productId, isBundle) {
        if (isBundle) {
          // Selecting a bundle clears individual selections
          this.selectedBundle = (this.selectedBundle === productId) ? null : productId;
          this.selectedFlavors = [];
        } else {
          // Selecting an individual flavor clears bundle selection
          this.selectedBundle = null;
          this.toggleFlavor(productId);
        }
        this.pickOwnExpanded = false;
      },

      // Legacy method for backwards compatibility
      selectMixedBox() {
        if (this.bundleProductIds.length > 0) {
          this.selectOption(this.bundleProductIds[0], true);
        }
      },

      selectPickMode() {
        this.selectedBundle = null;
      },

      toggleFlavor(productId) {
        // Clear bundle selection when toggling individual flavors
        if (this.selectedBundle !== null) {
          this.selectedBundle = null;
          this.selectedFlavors = [productId];
        } else {
          // Toggle the flavor in the array
          const index = this.selectedFlavors.indexOf(productId);
          if (index > -1) {
            this.selectedFlavors.splice(index, 1);
          } else if (this.selectedFlavors.length < 3) {
            this.selectedFlavors.push(productId);
          }
        }
      },

      getVariantForSize(productId, packSize) {
        const product = this.products[productId];
        if (!product) return null;
        return Object.values(product.variants).find(v => v.packs === packSize);
      },

      getPrice(packSize) {
        // Returns total price in pence for the given pack size
        // For bundle selections, returns bundle price
        // For multi-flavor selections, returns sum of all selected flavors
        if (this.selectedBundle !== null) {
          const variant = this.getVariantForSize(this.selectedBundle, packSize);
          return variant ? variant.price : 0;
        }

        // Sum up price for each selected flavor (or use one product for calculation if none selected)
        if (this.selectedFlavors.length === 0) {
          const product = this.individualProducts[0];
          const variant = this.getVariantForSize(product?.id, packSize);
          return variant ? variant.price : 0;
        }

        let total = 0;
        for (const productId of this.selectedFlavors) {
          const variant = this.getVariantForSize(productId, packSize);
          if (variant) {
            total += variant.price;
          }
        }
        return total;
      },

      getSizePrice(packSize) {
        // Returns price for size card display, applying subscription discount if active
        const basePrice = this.getPrice(packSize);
        if (this.subscribe) {
          return Math.round(basePrice * (1 - this.discountPercent / 100));
        }
        return basePrice;
      },

      getTotalPrice(withSubscription) {
        const packSize = this.selectedSize;
        let total = this.getPrice(packSize);

        if (withSubscription) {
          total = Math.round(total * (1 - this.discountPercent / 100));
        }

        return total;
      },

      getSavings() {
        return this.getTotalPrice(false) - this.getTotalPrice(true);
      },

      getPerPackPrice(withSubscription) {
        const packSize = this.selectedSize;
        const flavorCount = this.selectedBundle !== null ? 1 : Math.max(1, this.selectedFlavors.length);
        const totalPacks = packSize * flavorCount;
        const totalPrice = this.getTotalPrice(withSubscription);
        const perPack = totalPrice / totalPacks;
        return '£' + (perPack / 100).toFixed(2);
      },

      formatPrice(pence) {
        return '£' + (pence / 100).toFixed(2);
      },

      getOrderSummary() {
        const packSize = this.selectedSize;

        if (this.selectedBundle !== null) {
          const product = this.products[this.selectedBundle];
          const name = product ? product.title.replace('Overnight Gut Oats |', '').trim() : 'Bundle';
          return `1× ${name} (${packSize} packs)`;
        } else if (this.selectedFlavors.length === 0) {
          return 'Select a flavor';
        } else if (this.selectedFlavors.length === 1) {
          const product = this.products[this.selectedFlavors[0]];
          const name = product.title.replace('Overnight Gut Oats |', '').trim();
          return `1× ${name} (${packSize} packs)`;
        } else {
          const names = this.selectedFlavors.map(id => {
            const product = this.products[id];
            return product.title.replace('Overnight Gut Oats |', '').trim().split(' ')[0];
          }).join(', ');
          return `${this.selectedFlavors.length}× ${packSize}-pack (${names})`;
        }
      },

      async checkout() {
        if (!this.canCheckout) return;

        const packSize = this.selectedSize;
        let items = [];

        // Use selected frequency or default selling plan
        const getSellingPlanForVariant = (variant) => {
          if (!this.subscribe) return null;
          // If a frequency is selected and matches an allocation, use it
          if (this.selectedFrequency) {
            return this.selectedFrequency;
          }
          // Fall back to default selling plan from variant
          return variant.sellingPlanId;
        };

        if (this.selectedBundle !== null) {
          const variant = this.getVariantForSize(this.selectedBundle, packSize);
          if (variant) {
            const item = {
              id: variant.id,
              quantity: 1
            };
            const sellingPlan = getSellingPlanForVariant(variant);
            if (sellingPlan) {
              item.selling_plan = sellingPlan;
            }
            items.push(item);
          }
        } else {
          for (const productId of this.selectedFlavors) {
            const variant = this.getVariantForSize(productId, packSize);
            if (variant) {
              const item = {
                id: variant.id,
                quantity: 1
              };
              const sellingPlan = getSellingPlanForVariant(variant);
              if (sellingPlan) {
                item.selling_plan = sellingPlan;
              }
              items.push(item);
            }
          }
        }

        // Clear cart first, then add items, then redirect to checkout
        try {
          // Clear existing cart
          await fetch('/cart/clear.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          // Add items to cart
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items })
          });

          if (!response.ok) {
            const error = await response.json();
            console.error('Cart add error:', error);
            alert('Sorry, there was an error. Please try again.');
            return;
          }

          // Redirect to checkout
          window.location.href = '/checkout';
        } catch (error) {
          console.error('Checkout error:', error);
          alert('Sorry, there was an error. Please try again.');
        }
      },

      // Image gallery
      nextImage() {
        this.currentImageIndex = (this.currentImageIndex + 1) % this.currentImages.length;
      },

      prevImage() {
        this.currentImageIndex = (this.currentImageIndex - 1 + this.currentImages.length) % this.currentImages.length;
      },

      selectImage(index) {
        this.currentImageIndex = index;
      },

      touchStart(event) {
        this.touchStartX = event.changedTouches[0].screenX;
      },

      touchEnd(event) {
        this.touchEndX = event.changedTouches[0].screenX;
        this.handleSwipe();
      },

      handleSwipe() {
        const diff = this.touchStartX - this.touchEndX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            this.nextImage();
          } else {
            this.prevImage();
          }
        }
      }
    };
  }
</script>

{% schema %}
{
  "name": "Shop Purchase Flow",
  "tag": "section",
  "class": "shopify-section--shop-purchase-flow",
  "settings": [
    {
      "type": "header",
      "content": "Header Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Overnight Gut Oats"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Delicious overnight oats. Just add milk."
    },
    {
      "type": "text",
      "id": "reviews_text",
      "label": "Reviews text",
      "default": "5.0 from 200+ reviews"
    },
    {
      "type": "image_picker",
      "id": "rating_image",
      "label": "Rating stars image",
      "info": "Upload a custom stars image (e.g., pink stars)"
    },
    {
      "type": "header",
      "content": "Gallery"
    },
    {
      "type": "paragraph",
      "content": "Add gallery images using the blocks below"
    },
    {
      "type": "header",
      "content": "Product Benefits"
    },
    {
      "type": "text",
      "id": "benefit_1",
      "label": "Benefit 1",
      "default": "1+ billion probiotics per serving"
    },
    {
      "type": "image_picker",
      "id": "benefit_1_icon",
      "label": "Benefit 1 icon"
    },
    {
      "type": "text",
      "id": "benefit_2",
      "label": "Benefit 2",
      "default": "No artificial ingredients or added sugars"
    },
    {
      "type": "image_picker",
      "id": "benefit_2_icon",
      "label": "Benefit 2 icon"
    },
    {
      "type": "text",
      "id": "benefit_3",
      "label": "Benefit 3",
      "default": "Supports healthy digestion"
    },
    {
      "type": "image_picker",
      "id": "benefit_3_icon",
      "label": "Benefit 3 icon"
    },
    {
      "type": "header",
      "content": "Testimonial"
    },
    {
      "type": "text",
      "id": "testimonial_quote",
      "label": "Quote",
      "default": "Finally healthy oats that taste amazing!"
    },
    {
      "type": "text",
      "id": "testimonial_author",
      "label": "Author",
      "default": "Sarah T."
    },
    {
      "type": "header",
      "content": "Flavor Selection"
    },
    {
      "type": "text",
      "id": "flavors_title",
      "label": "Flavors section title",
      "default": "Pick your flavors"
    },
    {
      "type": "text",
      "id": "size_title",
      "label": "Size section title",
      "default": "Choose your size"
    },
    {
      "type": "header",
      "content": "Best Seller Badge"
    },
    {
      "type": "text",
      "id": "bestseller_badge_text",
      "label": "Badge text",
      "default": "BEST SELLER"
    },
    {
      "type": "color",
      "id": "bestseller_badge_bg",
      "label": "Badge background color",
      "default": "#fbbf24"
    },
    {
      "type": "color",
      "id": "bestseller_badge_text_color",
      "label": "Badge text color",
      "default": "#000000"
    },
    {
      "type": "image_picker",
      "id": "bestseller_badge_icon",
      "label": "Badge icon",
      "info": "Small image displayed left of badge text"
    },
    {
      "type": "header",
      "content": "Box Size Images"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_9",
      "label": "9-pack image",
      "info": "Stacked product image for 9-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_18",
      "label": "18-pack image",
      "info": "Stacked product image for 18-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_27",
      "label": "27-pack image",
      "info": "Stacked product image for 27-pack option"
    },
    {
      "type": "header",
      "content": "Subscription"
    },
    {
      "type": "image_picker",
      "id": "sub_tick_icon",
      "label": "Tick icon",
      "info": "Custom checkmark icon for benefit list"
    },
    {
      "type": "text",
      "id": "sub_benefit_1",
      "label": "Benefit 1",
      "default": "Pause or cancel anytime"
    },
    {
      "type": "text",
      "id": "sub_benefit_2",
      "label": "Benefit 2",
      "default": "Change your flavours"
    },
    {
      "type": "text",
      "id": "sub_benefit_3",
      "label": "Benefit 3",
      "default": "Save 20% on future orders"
    },
    {
      "type": "header",
      "content": "Subscription Benefit Cards"
    },
    {
      "type": "image_picker",
      "id": "sub_benefit_card_1",
      "label": "20% OFF card image",
      "info": "Image for the '20% OFF ALWAYS' benefit card"
    },
    {
      "type": "image_picker",
      "id": "sub_benefit_card_2_unlocked",
      "label": "Free Delivery - Unlocked",
      "info": "Image shown when free shipping is unlocked (order ≥ £40)"
    },
    {
      "type": "image_picker",
      "id": "sub_benefit_card_2_locked",
      "label": "Free Delivery - Locked",
      "info": "Pre-blurred image shown when free shipping is locked (order < £40)"
    },
    {
      "type": "header",
      "content": "Checkout Button"
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "Checkout button text",
      "default": "BUY NOW"
    },
    {
      "type": "header",
      "content": "Selected State Styling"
    },
    {
      "type": "color",
      "id": "selected_background",
      "label": "Selected background",
      "default": "#D8F7FF"
    },
    {
      "type": "color",
      "id": "selected_border",
      "label": "Selected border",
      "default": "#6CDFFF"
    },
    {
      "type": "color",
      "id": "selected_text",
      "label": "Selected text color",
      "default": "#000000",
      "info": "Text color for selected options"
    },
  ],
  "blocks": [
    {
      "type": "flavor_option",
      "name": "Flavor Option",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "checkbox",
          "id": "is_bundle",
          "label": "Bundle option (mutually exclusive)",
          "default": false,
          "info": "When selected, deselects all other options. Use for mixed/variety packs."
        },
        {
          "type": "image_picker",
          "id": "card_image",
          "label": "Card image",
          "info": "Product image displayed on the card"
        },
        {
          "type": "image_picker",
          "id": "card_background",
          "label": "Card background",
          "info": "Full-bleed background image (optional)"
        },
        {
          "type": "text",
          "id": "name_override",
          "label": "Display name",
          "info": "Overrides product title on the card"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Subtitle",
          "info": "Text below the name (e.g., 'All 3' for mixed box)"
        },
        {
          "type": "checkbox",
          "id": "show_badge",
          "label": "Show badge",
          "default": false
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "info": "Shown when this option's tab is active"
        },
        {
          "type": "header",
          "content": "Pill Styling"
        },
        {
          "type": "color",
          "id": "pill_selected_bg",
          "label": "Selected background",
          "default": "#3C1B04"
        },
        {
          "type": "color",
          "id": "pill_selected_text",
          "label": "Selected text",
          "default": "#FFFFFF"
        },
        {
          "type": "color",
          "id": "pill_selected_border",
          "label": "Selected border",
          "default": "#3C1B04"
        },
        {
          "type": "header",
          "content": "Testimonial"
        },
        {
          "type": "text",
          "id": "testimonial_quote",
          "label": "Quote"
        },
        {
          "type": "text",
          "id": "testimonial_author",
          "label": "Author"
        }
      ]
    },
    {
      "type": "gallery_image",
      "name": "Gallery Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt",
          "label": "Alt text",
          "default": "Product image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shop Purchase Flow",
      "blocks": [
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": true,
            "name_override": "THE CULT MIX",
            "subtitle": "All 3",
            "show_badge": true,
            "description": "All 3 flavors in one box — can't decide? This is the one for you."
          }
        },
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": false,
            "name_override": "CACAO",
            "description": "Rich chocolate oats for a satisfying start."
          }
        },
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": false,
            "name_override": "STRAWBERRY",
            "description": "Sweet strawberry goji for a fruity morning."
          }
        },
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": false,
            "name_override": "CINNAMON",
            "description": "Warming cinnamon spice for cozy mornings."
          }
        }
      ]
    }
  ]
}
{% endschema %}
