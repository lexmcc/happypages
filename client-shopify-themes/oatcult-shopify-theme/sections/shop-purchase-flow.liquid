{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
SHOP PURCHASE FLOW
----------------------------------------------------------------------------------------------------------------------

CRO-optimized product purchase page with:
- Flavor-first selection (IKEA/endowment effect)
- Adaptive size options based on flavor count
- Subscription-first design with 20% savings
- Direct-to-checkout (no cart)

{%- endcomment -%}

<style>
  [x-cloak] { display: none !important; }

  .shop-purchase-flow {
    /* Local variables - map to theme variables for consistency */
    --spf-text-color: rgb(var(--text-primary));
    --spf-text-muted: rgb(var(--text-primary) / 0.6);
    --spf-text-subtle: rgb(var(--text-primary) / 0.4);
    --spf-background: rgb(var(--background-primary));
    --spf-border-color: rgb(var(--text-primary) / 0.12);
    --spf-accent: rgb(var(--accent));
    --spf-success: rgb(var(--success-text));
    --spf-star-color: rgb(var(--star-color));

    /* === NEW DESIGN TOKENS === */
    /* Pink palette */
    --color-pink-dark: #F05E87;
    --color-pink-light: #FFBED6;
    --color-pink-border: #B45B7E;
    /* Neutral palette */
    --color-cream: #F0E9DE;
    --color-border-light: #CDCDCD;
    --color-chevron: #361A05;
    --color-locked-overlay: rgba(54, 26, 5, 0.9);
    --color-locked-border: #361A05;
    /* CTA */
    --color-cta-yellow: #FFE500;
    --color-cta-yellow-hover: #E8C300;

    /* Card gradients */
    --gradient-unselected: linear-gradient(to bottom, #FFFFFF 0%, #F0E9DE 100%);
    --gradient-selected: linear-gradient(to bottom, #F05E87 0%, #FFBED6 100%);
    --gradient-sub-section: linear-gradient(to bottom right, #FFBED6 0%, #F05E87 100%);

    /* Z-index scale */
    --z-base: 1;
    --z-card-hover: 5;
    --z-dropdown: 10;
    --z-sticky: 100;

    /* Semantic colors for badges/CTA - keep brand-specific */
    --spf-cta-background: #93c5fd;
    --spf-cta-hover: #60a5fa;
    --spf-badge-popular: #fbbf24;
    --spf-badge-success: #22c55e;
    --spf-badge-hot: #ff6b35;
    --spf-badge-featured: #ec4899;

    /* Selector box styling - using new gradient system */
    --spf-selector-bg: var(--color-cream);
    --spf-selector-border: var(--color-border-light);
    --spf-selector-selected-bg: {{ section.settings.selected_background | default: '#FFBED6' }};
    --spf-selector-selected-border: {{ section.settings.selected_border | default: '#B45B7E' }};
    --spf-selector-selected-text: {{ section.settings.selected_text | default: '#000000' }};
    --spf-selector-radius: 8px;

    --spf-subscribe-selected: #fef3c7;
    --spf-subscribe-border: #f59e0b;
    --spf-savings-color: var(--color-pink-dark);

    /* Transitions (respecting reduced motion) */
    --transition-fast: 0.1s ease;
    --transition-normal: 0.15s ease-out;

    padding: var(--spacing-8) var(--spacing-5);
    font-family: var(--text-font-family);
    background-color: #FFF7EE;
    overflow: hidden;  /* Prevents horizontal scroll on mobile */
  }

  @media screen and (min-width: 1000px) {
    .shop-purchase-flow {
      overflow: visible;  /* Allow sticky to work on desktop */
    }
  }

  /* Reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .shop-purchase-flow {
      --transition-fast: 0s;
      --transition-normal: 0s;
    }

    .shop-purchase-flow *,
    .shop-purchase-flow *::before,
    .shop-purchase-flow *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Tabular numbers for prices */
  .shop-purchase-flow [class*="price"],
  .shop-purchase-flow [class*="savings"],
  .shop-purchase-flow [class*="per-pack"] {
    font-variant-numeric: tabular-nums;
  }

  /* Focus ring styles for accessibility */
  .shop-purchase-flow :focus-visible {
    outline: 2px solid var(--color-pink-dark);
    outline-offset: 2px;
  }

  /* Remove outline on mouse focus */
  .shop-purchase-flow :focus:not(:focus-visible) {
    outline: none;
  }

  .shop-purchase-flow__container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-8);
  }

  @media screen and (min-width: 1000px) {
    .shop-purchase-flow__container {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto 1fr;
      gap: var(--spacing-12);
      align-items: start;
    }

    .shop-purchase__header {
      grid-column: 1 / -1;
      grid-row: 1;
    }

    .flavor-grid-column {
      grid-column: 1;
      grid-row: 2;
      align-self: start;
    }

    .shop-purchase {
      grid-column: 2;
      grid-row: 2;
      position: sticky;
      top: calc(var(--sticky-area-height) + 20px);
      height: fit-content;
      align-self: start;
    }
  }

  /* ============================================
     FLAVOR GRID (2×2 Card Layout)
     ============================================ */
  .flavor-grid-column {
    min-width: 0;
  }

  .flavor-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .flavor-grid__card {
    position: relative;
    aspect-ratio: 3 / 4;
    border-radius: 12px;
    border: 2px solid var(--color-border-light);
    background: var(--gradient-unselected);
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    flex-direction: column;
    overflow: visible;
  }

  .flavor-grid__card--has-bg {
    background-image: var(--card-bg-image, none), var(--gradient-unselected);
    background-size: cover, auto;
    background-position: center, center;
    background-repeat: no-repeat, no-repeat;
  }

  .flavor-grid__card--selected {
    background: var(--gradient-selected);
    border-color: var(--color-pink-border);
  }

  .flavor-grid__card--has-bg.flavor-grid__card--selected {
    background-image: var(--card-bg-image, none), var(--gradient-selected);
    background-size: cover, auto;
    background-position: center, center;
    background-repeat: no-repeat, no-repeat;
  }

  .flavor-grid__card--selected:hover {
    border-color: var(--color-pink-border);
  }

  .flavor-grid__badge {
    position: absolute;
    top: -10px;
    left: 16px;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }

  .flavor-grid__badge-icon {
    width: 12px;
    height: 12px;
    object-fit: contain;
  }

  .flavor-grid__info {
    position: absolute;
    top: 13px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid var(--color-border-light);
    background: rgba(255, 255, 255, 0.85);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: var(--spf-text-muted);
    z-index: 2;
    transition: background var(--transition-normal);
  }

  .flavor-grid__info:hover {
    background: white;
    color: var(--spf-text-color);
  }

  .flavor-grid__body {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: var(--spacing-3);
    padding-bottom: 0;
    min-height: 0;
  }

  .flavor-grid__name {
    font-size: var(--text-sm);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--spf-text-color);
    line-height: 1.2;
    padding-top: 10px;
    padding-right: 32px; /* space for info icon */
  }

  .flavor-grid__image {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-2);
    min-height: 0;
  }

  .flavor-grid__image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  /* When card has background image, hide the image wrapper */
  .flavor-grid__card--has-bg .flavor-grid__image {
    display: none;
  }

  .flavor-grid__card--has-bg .flavor-grid__body {
    flex: 1;
    justify-content: flex-start;
  }

  .flavor-grid__choose {
    display: block;
    width: calc(100% - var(--spacing-3) * 2);
    margin: 0 var(--spacing-3) var(--spacing-3);
    padding: 8px 16px;
    border-radius: 9999px;
    border: 1px solid var(--color-pink-border);
    background: var(--color-pink-dark);
    color: white;
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s ease;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .flavor-grid__choose:hover {
    opacity: 0.9;
  }

  .flavor-grid__card--selected .flavor-grid__choose {
    background: var(--color-cream);
    color: var(--spf-text-color);
    border-color: var(--color-border-light);
  }

  /* Mobile: slightly smaller cards */
  @media screen and (max-width: 767px) {
    .flavor-grid {
      gap: 8px;
    }

    .flavor-grid__name {
      font-size: 11px;
    }

    .flavor-grid__choose {
      font-size: 11px;
      padding: 6px 12px;
      min-height: 32px;
    }
  }

  /* ============================================
     INFO DRAWER
     ============================================ */
  .flavor-drawer__gallery {
    margin-bottom: var(--spacing-4);
  }

  .flavor-drawer__images {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    gap: 8px;
    border-radius: 12px;
  }

  .flavor-drawer__images::-webkit-scrollbar {
    display: none;
  }

  .flavor-drawer__image {
    flex-shrink: 0;
    width: 100%;
    scroll-snap-align: start;
  }

  .flavor-drawer__image img {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 12px;
  }

  .flavor-drawer__dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 12px 0;
  }

  .flavor-drawer__dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ccc;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: background 0.15s ease;
  }

  .flavor-drawer__dot--active {
    background: var(--color-pink-dark);
  }

  .flavor-drawer__description {
    font-size: var(--text-base);
    line-height: 1.6;
    color: var(--spf-text-color);
    margin-bottom: var(--spacing-4);
  }

  .flavor-drawer__quote {
    margin-bottom: var(--spacing-6);
  }

  .flavor-drawer__quote blockquote {
    background: rgba(240, 94, 135, 0.08);
    padding: var(--spacing-4);
    border-radius: var(--spf-selector-radius);
    font-size: var(--text-sm);
    font-style: italic;
    color: var(--spf-text-color);
    margin: 0;
    line-height: 1.5;
  }

  .flavor-drawer__quote blockquote::before {
    content: '\201C';
    font-size: 2rem;
    line-height: 0;
    vertical-align: -0.5em;
    color: var(--color-pink-dark);
    margin-right: 4px;
  }

  .flavor-drawer__author {
    display: block;
    text-align: right;
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
    margin-top: var(--spacing-2);
  }

  .flavor-drawer__cta {
    width: 100%;
    padding: var(--spacing-4);
    border-radius: 9999px;
    border: 2px solid var(--color-pink-border);
    background: var(--color-pink-dark);
    color: white;
    font-size: var(--text-base);
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.25s ease;
    margin-top: var(--spacing-4);
  }

  .flavor-drawer__cta:hover {
    opacity: 0.9;
  }

  .flavor-drawer__cta--remove {
    background: var(--color-cream);
    color: var(--spf-text-color);
    border-color: var(--color-border-light);
  }

  /* Benefits badges */
  .shop-gallery__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-2) 0;
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .shop-gallery__benefit-icon {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shop-gallery__benefit-icon img {
    width: 24px;
    height: 24px;
    object-fit: contain;
  }

  /* Benefits in purchase column (shown on both desktop and mobile) */
  .shop-purchase__benefits {
    display: block;
    margin-top: var(--spacing-4);
  }

  /* ============================================
     PURCHASE COLUMN
     ============================================ */
  .shop-purchase {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
    min-width: 0;  /* Prevent grid blowout */
  }

  .shop-purchase__header {
    text-align: left;
  }

  .shop-purchase__title {
    font-size: var(--text-h2);
    font-weight: 700;
    margin: 0 0 var(--spacing-2) 0;
    color: var(--spf-text-color);
    font-family: var(--heading-font-family);
    letter-spacing: var(--heading-letter-spacing);
  }

  .shop-purchase__subtitle {
    font-size: var(--text-base);
    color: var(--spf-text-color);
    margin: 0 0 var(--spacing-3) 0;
  }

  .shop-purchase__rating {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .shop-purchase__stars {
    color: var(--spf-star-color);
    letter-spacing: 2px;
  }

  .shop-purchase__stars-image {
    height: 20px;
    width: auto;
  }

  .shop-purchase__divider {
    display: none;
  }

  .shop-purchase__section-title {
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--spf-text-muted);
    margin: 0 0 var(--spacing-3) 0;
  }

  /* ============================================
     FLAVOR SELECTION
     ============================================ */
  .flavor-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .flavor-option {
    padding: var(--spacing-4) var(--spacing-5);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .flavor-option:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .flavor-option--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .flavor-option--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-option--selected .flavor-option__name,
  .flavor-option--selected .flavor-option__description,
  .flavor-option--selected .flavor-option__flavor-list {
    color: var(--spf-text-color);
  }

  .flavor-option--selected .flavor-option__toggle {
    border-color: var(--spf-selector-border);
    color: var(--spf-text-color);
  }

  /* Featured badge styling */
  .flavor-option__badge--featured {
    position: absolute;
    top: -10px;
    right: 16px;
    background: var(--spf-badge-featured);
    color: white;
  }

  .flavor-option--has-badge {
    position: relative;
  }

  /* Dropdown variant for Pick Your Own */
  .flavor-option--dropdown {
    padding: 0;
    overflow: hidden;
  }

  .flavor-option--dropdown .flavor-option__header {
    padding: var(--spacing-4) var(--spacing-5);
    cursor: pointer;
  }

  .flavor-option__toggle {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-2) var(--spacing-3);
    border: 1px solid var(--spf-border-color);
    border-radius: var(--rounded);
    background: transparent;
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
    color: var(--spf-text-color);
  }

  .flavor-option__toggle:hover {
    background: rgb(var(--text-primary) / 0.05);
  }

  .flavor-option__arrow {
    transition: transform 0.2s ease;
    width: 16px;
    height: 16px;
  }

  .flavor-option--expanded .flavor-option__arrow {
    transform: rotate(180deg);
  }

  .flavor-option__content {
    background: white;
    border-top: 1px solid var(--spf-border-color);
    overflow: hidden;
  }

  .flavor-option__content-inner {
    padding: var(--spacing-4);
  }

  /* Flavor list text for Mixed Box */
  .flavor-option__flavor-list {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: var(--spacing-1);
    margin-bottom: 0;
  }

  /* Mixed Box with image variant */
  .flavor-option--mixed {
    display: flex;
    align-items: center;
    padding: 0;
    overflow: hidden;
  }

  .flavor-option__image {
    flex-shrink: 0;
    width: 70px;
    height: 70px;
    margin: 8px;
  }

  .flavor-option__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  .flavor-option__text {
    flex: 1;
    padding: var(--spacing-4) var(--spacing-5);
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* When no image, keep normal padding */
  .flavor-option--mixed:not(:has(.flavor-option__image)) {
    padding: var(--spacing-4) var(--spacing-5);
  }

  .flavor-option__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .flavor-option__left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .flavor-option__radio {
    display: none;
  }

  .flavor-option__emoji {
    font-size: 1.25rem;
  }

  .flavor-option__name {
    font-weight: 600;
    font-size: var(--text-base);
    color: var(--spf-text-color);
  }

  .flavor-option__badge {
    font-size: var(--text-xs);
    padding: 2px var(--spacing-2);
    border-radius: var(--rounded-xs);
    background: var(--spf-badge-popular);
    color: var(--spf-text-color);
    font-weight: 600;
  }

  .flavor-option__description {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: var(--spacing-2);
    padding-left: 32px;
  }

  /* Pick Your Own nested options */
  .flavor-option__nested {
    margin-top: var(--spacing-4);
    padding: var(--spacing-3);
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded);
    opacity: 0.5;
    pointer-events: none;
    transition: opacity var(--transition-normal);
  }

  .flavor-option--selected .flavor-option__nested {
    opacity: 1;
    pointer-events: auto;
  }

  .flavor-checkbox {
    display: flex;
    align-items: center;
    padding: var(--spacing-3);
    border-bottom: 1px solid var(--spf-border-color);
    cursor: pointer;
    transition: background var(--transition-normal);
    border-radius: var(--rounded);
  }

  .flavor-checkbox:last-child {
    border-bottom: none;
  }

  .flavor-checkbox:hover {
    background: rgb(var(--text-primary) / 0.03);
  }

  .flavor-checkbox--checked {
    background: rgb(var(--accent) / 0.05);
  }

  .flavor-checkbox__box {
    width: 20px;
    height: 20px;
    border-radius: var(--rounded-xs);
    border: 2px solid rgb(var(--text-primary) / 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-right: var(--spacing-3);
    transition: all var(--transition-normal);
  }

  .flavor-checkbox--checked .flavor-checkbox__box {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .flavor-checkbox__check {
    color: rgb(var(--background-primary));
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .flavor-checkbox--checked .flavor-checkbox__check {
    opacity: 1;
  }

  .flavor-checkbox__emoji {
    font-size: 1.25rem;
    margin-right: var(--spacing-3);
  }

  .flavor-checkbox__info {
    flex: 1;
  }

  .flavor-checkbox__name {
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .flavor-checkbox__desc {
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
    margin-top: 2px;
  }

  .flavor-checkbox__badge {
    font-size: var(--text-xs);
    padding: 2px 6px;
    border-radius: var(--rounded-xs);
    background: var(--spf-badge-hot);
    color: white;
    font-weight: 600;
    margin-left: auto;
  }

  .flavor-checkbox--disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  /* ============================================
     FLAVOR CARDS (Card-based selectors)
     ============================================ */
  .flavor-cards {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .flavor-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    padding: 0;
    border: 2px solid var(--spf-selector-border);
    border-radius: var(--spf-selector-radius);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .flavor-card:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .flavor-card--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .flavor-card--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-card--disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  .flavor-card__image {
    width: 70px;
    height: 70px;
    margin: 8px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .flavor-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  .flavor-card__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--spf-selector-selected-border) 0%, color-mix(in srgb, var(--spf-selector-selected-border) 70%, white) 100%);
    color: white;
    font-size: 1.5rem;
  }

  .flavor-card__name {
    flex: 1;
    font-weight: 700;
    font-size: var(--text-base);
    text-transform: uppercase;
    color: var(--spf-text-color);
  }

  .flavor-card__checkbox {
    width: 24px;
    height: 24px;
    margin-right: 16px;
    border-radius: 6px;
    border: 2px solid var(--spf-selector-border);
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--transition-normal);
  }

  .flavor-card__checkbox svg {
    width: 14px;
    height: 14px;
    stroke: white;
    stroke-width: 3;
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .flavor-card--selected .flavor-card__checkbox {
    background: var(--spf-selector-selected-border);
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-card--selected .flavor-card__checkbox svg {
    opacity: 1;
  }

  .flavor-card:hover:not(.flavor-card--selected) .flavor-card__checkbox {
    border-color: rgb(var(--text-primary) / 0.3);
  }

  /* Info text below flavor cards */
  .flavor-option__info {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    margin-top: var(--spacing-3);
    padding: var(--spacing-2) var(--spacing-3);
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded);
  }

  .flavor-option__info svg {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    opacity: 0.6;
  }

  /* ============================================
     SIZE CARDS
     ============================================ */
  .size-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-3);
  }

  .size-card {
    position: relative;
    padding: var(--spacing-4) var(--spacing-3);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .size-card:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .size-card--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .size-card--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .size-card:active {
    transform: scale(0.98);
  }

  .size-card__badge {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    padding: 2px var(--spacing-2);
    border-radius: var(--rounded-xs);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
  }

  /* Badge colors now set via inline styles from section settings */

  .size-card__label {
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--spf-text-muted);
    margin-bottom: var(--spacing-2);
  }

  .size-card__packs {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .size-card__duration {
    font-size: var(--text-xs);
    color: var(--spf-text-subtle);
    margin-bottom: var(--spacing-3);
  }

  .size-card__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .size-card__per-pack {
    font-size: var(--text-xs);
    color: var(--spf-text-subtle);
    margin-top: 4px;
  }

  /* Size cards mobile overrides */
  @media screen and (max-width: 767px) {
    .size-card {
      padding: var(--spacing-3) var(--spacing-2);
    }

    .size-card__label {
      font-size: 10px;
    }

    .size-card__packs {
      font-size: var(--text-base);
    }

    .size-card__price {
      font-size: 1rem;
    }

    .size-card__per-pack {
      font-size: 10px;
    }
  }

  /* ============================================
     SUBSCRIPTION TOGGLE
     ============================================ */
  .sub-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .sub-option {
    padding: var(--spacing-4) var(--spacing-5);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .sub-option:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .sub-option--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .sub-option--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  /* Subscribe option styling when selected */
  .sub-option--subscribe.sub-option--selected .sub-option__radio {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .sub-option__per-pack {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__per-pack-label {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    font-weight: 400;
  }

  .sub-option__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sub-option__left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .sub-option__radio {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid rgb(var(--text-primary) / 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--transition-normal);
  }

  .sub-option--selected .sub-option__radio {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .sub-option__radio::after {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgb(var(--background-primary));
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .sub-option--selected .sub-option__radio::after {
    opacity: 1;
  }

  .sub-option__title {
    font-weight: 600;
    font-size: var(--text-base);
    color: var(--spf-text-color);
  }

  .sub-option__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__benefits {
    margin-top: var(--spacing-3);
    padding-left: 32px;
  }

  .sub-option__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .sub-option__benefit-icon {
    color: var(--spf-success);
    flex-shrink: 0;
  }

  .sub-option__savings {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--spf-savings-color);
    margin-top: auto;
  }

  /* Subscribe section redesign - two column layout */
  .sub-option__layout {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-4);
  }

  .sub-option__left-col {
    flex: 1;
  }

  .sub-option__right-col {
    text-align: right;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }

  .sub-option__title-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    margin-bottom: var(--spacing-2);
  }

  .sub-option__per-pack {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__per-box {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: 2px;
  }

  .sub-option__benefits {
    margin-top: var(--spacing-2);
    padding-left: 0;
  }

  .sub-option__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .sub-option__benefit img {
    width: 16px;
    height: 16px;
    object-fit: contain;
  }

  /* Subscribe cards mobile overrides */
  @media screen and (max-width: 767px) {
    .sub-option {
      padding: var(--spacing-3) var(--spacing-4);
    }

    .sub-option__title {
      font-size: var(--text-sm);
    }

    .sub-option__benefit {
      font-size: var(--text-xs);
    }

    .sub-option__per-pack {
      font-size: 1.1rem;
    }

    .sub-option__per-box,
    .sub-option__savings {
      font-size: var(--text-xs);
    }
  }

  /* ============================================
     CTA BUTTON
     ============================================ */
  .cta-button {
    width: 100%;
    padding: var(--spacing-5) var(--spacing-6);
    border-radius: 60px;
    background: #FED700;
    color: var(--spf-text-color);
    font-size: var(--text-base);
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
    border: 1px solid #E0C426;
    text-transform: uppercase;
  }

  .cta-button:hover {
    background: #E8C300;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(254, 215, 0, 0.4);
  }

  .cta-button:active {
    transform: translateY(0);
  }

  .cta-button:disabled {
    background: rgb(var(--text-primary) / 0.2);
    color: var(--spf-text-muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .cta-button__summary {
    font-size: var(--text-sm);
    font-weight: 400;
    opacity: 0.8;
    margin-top: 4px;
    text-transform: none;
  }

  /* ============================================
     TRUST BADGES
     ============================================ */
  .trust-badges {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: var(--spacing-4);
    padding: var(--spacing-4) 0;
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
  }

  .trust-badge {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .trust-badge__icon {
    font-size: var(--text-sm);
  }

  /* ============================================
     TESTIMONIAL
     ============================================ */
  .testimonial {
    padding: var(--spacing-4);
    text-align: center;
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded-lg);
  }

  .testimonial__quote {
    font-size: var(--text-sm);
    font-style: italic;
    color: var(--spf-text-color);
    margin: 0 0 var(--spacing-2) 0;
  }

  .testimonial__author {
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
    margin: 0;
  }

  .testimonial__verified {
    color: var(--spf-success);
  }

  /* ============================================
     MOBILE STICKY CTA
     ============================================ */
  .sticky-cta {
    display: none;
  }

  @media screen and (max-width: 999px) {
    .sticky-cta {
      display: block;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--spacing-3) var(--spacing-4);
      padding-bottom: calc(var(--spacing-3) + env(safe-area-inset-bottom));
      background: rgb(var(--background-primary));
      border-top: 1px solid var(--spf-border-color);
      box-shadow: 0 -4px 12px rgb(var(--text-primary) / 0.08);
      z-index: 100;
    }

    .sticky-cta .cta-button {
      padding: var(--spacing-4);
    }

    /* Add padding to bottom of purchase column to prevent content being hidden by sticky CTA */
    .shop-purchase {
      padding-bottom: 100px;
    }
  }

  /* ============================================
     ERROR STATE
     ============================================ */
  .flavor-error {
    color: rgb(var(--error-text));
    font-size: var(--text-sm);
    padding: var(--spacing-2) var(--spacing-3);
    background: rgb(var(--error-background));
    border-radius: var(--rounded);
    margin-top: var(--spacing-2);
  }

  /* (Flavor tabs + description + carousel removed — replaced by 2×2 grid + drawer) */

  /* (Flavor carousel CSS removed — replaced by 2×2 grid above) */

  /* ============================================
     BOX SIZE CARDS (New Design)
     ============================================ */
  .size-cards--redesign {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .size-card--redesign {
    position: relative;
    padding: var(--spacing-3);
    border-radius: var(--spf-selector-radius);
    border: 1px solid var(--color-border-light);
    background: var(--gradient-unselected);
    text-align: left;
    cursor: pointer;
    transition: transform var(--transition-normal), border-color var(--transition-normal), background var(--transition-normal);
    min-height: 44px;
  }

  .size-card--redesign.size-card--selected {
    background: var(--gradient-selected);
    border-color: var(--color-pink-border);
  }

  /* Keep text black when selected (no white override) */

  .size-card--redesign.size-card--selected .size-card__compare-price {
    color: rgba(0, 0, 0, 0.5);
  }

  .size-card--redesign .size-card__badge {
    position: absolute;
    top: 8px;
    right: 8px;
    left: auto;
    transform: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    white-space: nowrap;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .size-card--redesign .size-card__badge-icon {
    width: 12px;
    height: 12px;
    object-fit: contain;
  }

  .size-card--redesign .size-card__packs {
    font-weight: 700;
    font-size: var(--text-sm);
    text-transform: uppercase;
    margin-bottom: var(--spacing-2);
  }

  .size-card--redesign .size-card__image {
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--spacing-4);
  }

  .size-card--redesign .size-card__image img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
  }

  .size-card--redesign .size-card__prices {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 6px;
    margin-bottom: 2px;
  }

  .size-card--redesign .size-card__price {
    font-weight: 700;
    font-size: 1rem;
  }

  .size-card--redesign .size-card__compare-price {
    font-size: 0.85rem;
    color: #999;
    text-decoration: line-through;
  }

  .size-card--redesign .size-card__per-pack {
    display: block;
    background: #e5e5e5;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: var(--text-sm);
    color: #666;
    text-align: center;
    width: fit-content;
    margin: var(--spacing-1) auto 0;
  }

  .size-card--redesign.size-card--selected .size-card__per-pack {
    background: #6CDFFF;
    color: #1a1a1a;
  }

  .size-card--redesign .size-card__selected-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    color: #ff584d;
    margin-top: var(--spacing-2);
    letter-spacing: 0.5px;
    text-align: center;
  }

  @media screen and (max-width: 999px) {
    .size-cards--redesign {
      gap: 8px;
    }

    .size-card--redesign {
      padding: var(--spacing-2);
    }

    .size-card--redesign .size-card__image {
      height: 70px;
    }

    .size-card--redesign .size-card__packs {
      font-size: var(--text-sm);
    }

    .size-card--redesign .size-card__price {
      font-size: 0.9rem;
    }

    .size-card--redesign .size-card__compare-price {
      font-size: 0.75rem;
    }

    .size-card--redesign .size-card__badge {
      font-size: 10px;
      padding: 4px 8px;
      top: 8px;
      right: 8px;
    }

    .size-card--redesign .size-card__badge-icon {
      width: 12px;
      height: 12px;
    }

    .size-card--redesign .size-card__per-pack {
      font-size: 12px;
      padding: 3px 10px;
    }

    .size-card--redesign .size-card__packs .packs-suffix {
      display: none;
    }
  }

  /* ============================================
     SUB & SAVE SECTION (New Design)
     ============================================ */
  .sub-section {
    border-radius: var(--spf-selector-radius);
    border: 1px solid var(--color-border-light);
    overflow: hidden;
    transition: opacity var(--transition-normal), filter var(--transition-normal);
  }

  .sub-section--active {
    background: var(--gradient-sub-section);
    border-color: var(--color-pink-border);
  }

  .sub-section--inactive {
    opacity: 0.5;
    filter: grayscale(0.5);
  }

  .sub-section__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-4);
    cursor: pointer;
  }

  .sub-section__title-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
  }

  .sub-section__title {
    font-size: var(--text-base);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--spf-text-color);
  }

  .sub-section--active .sub-section__title {
    color: #361A05;
  }

  .sub-section__subtitle {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
  }

  .sub-section--active .sub-section__subtitle {
    color: #361A05;
    opacity: 0.9;
  }

  .sub-section__pricing {
    text-align: right;
  }

  .sub-section__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-section--active .sub-section__price {
    color: #361A05;
  }

  .sub-section__per-pack {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
  }

  .sub-section--active .sub-section__per-pack {
    background: #6CDFFF;
    color: #361A05;
    padding: 4px 12px;
    border-radius: 20px;
    opacity: 1;
  }

  /* iOS-style toggle */
  .sub-toggle {
    position: relative;
    width: 52px;
    height: 32px;
    background: var(--color-border-light);
    border-radius: 16px;
    cursor: pointer;
    transition: background var(--transition-normal);
    flex-shrink: 0;
  }

  .sub-toggle--active {
    background: var(--color-pink-dark);
  }

  .sub-toggle__circle {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 28px;
    height: 28px;
    background: white;
    border-radius: 50%;
    transition: transform var(--transition-normal);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .sub-toggle--active .sub-toggle__circle {
    transform: translateX(20px);
  }

  /* Benefit cards */
  .sub-section__benefits {
    display: flex;
    gap: 12px;
    padding: 0 var(--spacing-4) var(--spacing-4);
  }

  .sub-benefit-card {
    flex: 1;
    max-width: 150px;
    border-radius: var(--spf-selector-radius);
    overflow: hidden;
    position: relative;
  }

  .sub-benefit-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .sub-benefit-card--unlocked {
    background: #FFFFFF;
    border: 1px solid #B45B7E;
  }

  .sub-benefit-card--locked {
    position: relative;
  }

  .sub-benefit-card--locked::after {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--color-locked-overlay);
    border: 1px solid var(--color-locked-border);
    border-radius: var(--spf-selector-radius);
  }

  .sub-benefit-card__lock-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
  }

  /* 20% OFF Always card variant */
  .sub-benefit-card--discount {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-3);
    padding-top: var(--spacing-5);
  }

  .sub-benefit-card--discount img {
    width: auto;
    height: auto;
    max-width: 70%;
    max-height: 75px;
    object-fit: contain;
  }

  .sub-benefit-card__banner {
    position: absolute;
    top: 6px;
    right: 6px;
    padding: 3px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
    /* background and color set via inline styles */
  }

  .sub-benefit-card__label {
    margin-top: var(--spacing-2);
    font-weight: 700;
    font-size: 12px;
    text-align: center;
    color: var(--spf-text-dark);
  }

  /* Free Delivery card variant */
  .sub-benefit-card--delivery {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-3);
    padding-top: var(--spacing-5);
  }

  .sub-benefit-card--delivery img {
    width: auto;
    height: auto;
    max-width: 70%;
    max-height: 75px;
    object-fit: contain;
  }

  /* Locked state overlay */
  .sub-benefit-card__locked-content {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-3);
    padding-top: var(--spacing-5);
    width: 100%;
    height: 100%;
  }

  .sub-benefit-card__locked-content img {
    width: auto;
    height: auto;
    max-width: 70%;
    max-height: 75px;
    object-fit: contain;
  }

  .sub-benefit-card__locked-overlay {
    position: absolute;
    bottom: var(--spacing-3);
    left: 0;
    right: 0;
    z-index: 1; /* appear above ::after overlay */
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    color: white;
    font-weight: 700;
    font-size: 10px;
    text-transform: uppercase;
  }

  .sub-benefit-card__locked-overlay span:last-child {
    font-size: 12px;
  }

  /* Unlocked content wrapper */
  .sub-benefit-card__unlocked-content {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sub-benefit-card__unlocked-content img {
    width: auto;
    height: auto;
    max-width: 70%;
    max-height: 75px;
    object-fit: contain;
  }

  .sub-benefit-card__placeholder {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-pink-border);
  }

  /* Benefit list */
  .sub-section__list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2) var(--spacing-4);
    padding: var(--spacing-4);
    margin: 0 var(--spacing-4) var(--spacing-4);
    background: #FFFFFF;
    border: 1px solid #B45B7E;
    border-radius: var(--spf-selector-radius);
  }

  .sub-section__list-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .sub-section--active .sub-section__list-item {
    color: var(--spf-text-color);
  }

  .sub-section__list-item img {
    width: 24px;
    height: 24px;
    object-fit: contain;
  }

  .sub-section__list-item svg {
    width: 24px;
    height: 24px;
  }

  /* Frequency dropdown */
  .sub-section__frequency {
    padding: 0 var(--spacing-4) var(--spacing-4);
  }

  .frequency-dropdown {
    width: 100%;
    padding: var(--spacing-3) var(--spacing-4);
    border: 1px solid var(--color-border-light);
    border-radius: var(--spf-selector-radius);
    background: white;
    font-size: var(--text-sm);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--spf-text-color);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23361A05' stroke-width='2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
    min-height: 44px;
  }

  /* Savings callout - positioned pill */
  .sub-section__savings-wrapper {
    position: relative;
    padding: 0 var(--spacing-4) var(--spacing-14);
  }

  .sub-section__savings {
    display: inline-block;
    float: right;
    padding: var(--spacing-2) var(--spacing-4);
    border-radius: 20px;
    font-size: var(--text-sm);
    font-weight: 700;
    background: #361A05;
    color: #6CDFFF;
  }

  /* ============================================
     ONE-TIME PURCHASE OPTION
     ============================================ */
  .onetime-option {
    display: none;
    padding: var(--spacing-4);
    border-radius: var(--spf-selector-radius);
    border: 1px solid var(--color-border-light);
    background: var(--gradient-unselected);
    cursor: pointer;
    transition: border-color var(--transition-normal);
    justify-content: space-between;
    align-items: center;
    min-height: 44px;
  }

  .onetime-option:hover {
    border-color: var(--spf-text-color);
  }

  .onetime-option--selected {
    background: var(--gradient-selected);
    border-color: var(--color-pink-border);
  }

  .onetime-option__title {
    font-weight: 600;
    color: var(--spf-text-color);
  }

  .onetime-option--selected .onetime-option__title {
    color: white;
  }

  .onetime-option__price {
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .onetime-option--selected .onetime-option__price {
    color: white;
  }

  /* ============================================
     CTA BUTTON (Updated Yellow)
     ============================================ */
  .cta-button--yellow {
    background: var(--color-cta-yellow);
    border-color: var(--color-cta-yellow-hover);
  }

  .cta-button--yellow:hover {
    background: var(--color-cta-yellow-hover);
    box-shadow: 0 4px 12px rgba(255, 229, 0, 0.4);
  }

  /* ============================================
     SUBSCRIBE SECTION - MOBILE
     ============================================ */
  @media screen and (max-width: 999px) {
    .desktop-cta {
      display: none;
    }

    /* Header: toggle + title + price on row 1, subtitle on row 2 */
    .sub-section__header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      grid-template-rows: auto auto;
      gap: var(--spacing-2) var(--spacing-3);
      align-items: center;
    }

    .sub-section__title-row {
      display: contents;
    }

    .sub-toggle {
      grid-row: 1;
      grid-column: 1;
    }

    .sub-section__title-row > div:last-child {
      display: contents;
    }

    .sub-section__title {
      grid-row: 1;
      grid-column: 2;
      align-self: center;
    }

    .sub-section__subtitle {
      grid-row: 2;
      grid-column: 1 / -1;
      padding-top: var(--spacing-2);
      text-align: left;
    }

    .sub-section__pricing {
      grid-row: 1;
      grid-column: 3;
    }

    .sub-section__benefits {
      flex-wrap: wrap;
      gap: 8px;
    }

    .sub-benefit-card {
      flex: 1 1 calc(50% - 4px);
      min-width: 100px;
    }

    /* Benefits list: keep flex wrap on mobile */
    .sub-section__list {
      gap: var(--spacing-2) var(--spacing-3);
    }

    .onetime-option {
      flex-wrap: wrap;
      gap: var(--spacing-2);
    }
  }

  /* ============================================
     MOBILE LAYOUT
     Header appears first (natural document order),
     then gallery, then purchase flow
     ============================================ */
  @media screen and (max-width: 999px) {
    /* Divider is already hidden by default (.shop-purchase__divider { display: none; }) */
  }
</style>

<div
  class="shop-purchase-flow"
  x-data="shopPurchaseFlow()"
  x-init="init()"
>
  <div class="shop-purchase-flow__container">
    <!-- HEADER (moved outside shop-purchase for mobile reordering) -->
    <div class="shop-purchase__header">
      <h1 class="shop-purchase__title">{{ section.settings.title }}</h1>
      <p class="shop-purchase__subtitle">{{ section.settings.subtitle }}</p>
      <div class="shop-purchase__rating">
        {%- if section.settings.rating_image != blank -%}
          <img class="shop-purchase__stars-image" src="{{ section.settings.rating_image | image_url: width: 200 }}" alt="5 star rating" height="20">
        {%- else -%}
          <span class="shop-purchase__stars">★★★★★</span>
        {%- endif -%}
        <span>{{ section.settings.reviews_text }}</span>
      </div>

      <!-- Benefits -->
      <div class="shop-purchase__benefits">
        <div class="shop-gallery__benefit">
          {%- if section.settings.benefit_1_icon != blank -%}
            <span class="shop-gallery__benefit-icon">
              <img src="{{ section.settings.benefit_1_icon | image_url: width: 48 }}" alt="" width="24" height="24">
            </span>
          {%- endif -%}
          <span>{{ section.settings.benefit_1 }}</span>
        </div>
        <div class="shop-gallery__benefit">
          {%- if section.settings.benefit_2_icon != blank -%}
            <span class="shop-gallery__benefit-icon">
              <img src="{{ section.settings.benefit_2_icon | image_url: width: 48 }}" alt="" width="24" height="24">
            </span>
          {%- endif -%}
          <span>{{ section.settings.benefit_2 }}</span>
        </div>
        <div class="shop-gallery__benefit">
          {%- if section.settings.benefit_3_icon != blank -%}
            <span class="shop-gallery__benefit-icon">
              <img src="{{ section.settings.benefit_3_icon | image_url: width: 48 }}" alt="" width="24" height="24">
            </span>
          {%- endif -%}
          <span>{{ section.settings.benefit_3 }}</span>
        </div>
      </div>
    </div>

    <!-- FLAVOR GRID COLUMN (Left) -->
    <div class="flavor-grid-column">
      <p class="shop-purchase__section-title">{{ section.settings.flavors_title | default: 'Choose your cults' }}</p>
      {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
      <div class="flavor-grid" role="listbox" aria-label="Flavor options">
        {%- if flavor_blocks.size > 0 -%}
          {%- for block in flavor_blocks -%}
            {%- assign block_product = block.settings.product -%}
            {%- if block_product != blank -%}
              {%- assign display_name = block.settings.name_override | default: block_product.title | remove: 'Overnight Gut Oats |' | strip | upcase -%}
              {%- assign card_bg = block.settings.card_background -%}
              {%- assign card_image = block.settings.card_image -%}
              {%- assign is_bundle = block.settings.is_bundle -%}
              <div
                class="flavor-grid__card{% if card_bg != blank %} flavor-grid__card--has-bg{% endif %}"
                :class="{
                  'flavor-grid__card--selected': {% if is_bundle %}selectedBundle === {{ block_product.id }}{% else %}selectedFlavors.includes({{ block_product.id }}){% endif %}
                }"
                {%- if card_bg != blank %}
                style="--card-bg-image: url('{{ card_bg | image_url: width: 600 }}')"
                {%- endif %}
                {{ block.shopify_attributes }}
              >
                {%- comment -%} Badge (optional, half-off top edge) {%- endcomment -%}
                {%- if block.settings.show_badge and section.settings.bestseller_badge_text != blank -%}
                  <span
                    class="flavor-grid__badge"
                    style="background: {{ section.settings.bestseller_badge_bg | default: '#fbbf24' }}; color: {{ section.settings.bestseller_badge_text_color | default: '#000000' }};"
                  >
                    {%- if section.settings.bestseller_badge_icon != blank -%}
                      <img class="flavor-grid__badge-icon" src="{{ section.settings.bestseller_badge_icon | image_url: width: 24 }}" alt="">
                    {%- endif -%}
                    {{ section.settings.bestseller_badge_text }}
                  </span>
                {%- endif -%}

                {%- comment -%} Info icon (opens drawer) {%- endcomment -%}
                <button
                  class="flavor-grid__info"
                  @click.stop="openDrawer({{ block_product.id }}, {{ is_bundle }})"
                  aria-label="More info about {{ display_name }}"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                </button>

                {%- comment -%} Card body (tap opens drawer) {%- endcomment -%}
                <div class="flavor-grid__body" @click="openDrawer({{ block_product.id }}, {{ is_bundle }})">
                  <div class="flavor-grid__name">{{ display_name }}</div>
                  <div class="flavor-grid__image">
                    {%- if card_image != blank -%}
                      <img src="{{ card_image | image_url: width: 400 }}" alt="{{ display_name }}" loading="lazy">
                    {%- elsif block_product.featured_image != blank -%}
                      <img src="{{ block_product.featured_image | image_url: width: 400 }}" alt="{{ display_name }}" loading="lazy">
                    {%- endif -%}
                  </div>
                </div>

                {%- comment -%} Choose/Chosen button (tap selects) {%- endcomment -%}
                <button
                  class="flavor-grid__choose"
                  @click.stop="selectOption({{ block_product.id }}, {{ is_bundle }}, $event)"
                  role="option"
                  :aria-selected="{% if is_bundle %}selectedBundle === {{ block_product.id }}{% else %}selectedFlavors.includes({{ block_product.id }}){% endif %}"
                >
                  <span x-text="{% if is_bundle %}selectedBundle === {{ block_product.id }}{% else %}selectedFlavors.includes({{ block_product.id }}){% endif %} ? 'Chosen' : 'Choose'"></span>
                </button>
              </div>
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      </div>

      <!-- Error message -->
      <div class="flavor-error" x-show="selectedBundle === null && selectedFlavors.length === 0" x-cloak>
        Please select at least one flavor
      </div>
    </div>

    <!-- PURCHASE COLUMN (Right, sticky on desktop) -->
    <div class="shop-purchase">

      <!-- SIZE CARDS (New Design) -->
      <div>
        <p class="shop-purchase__section-title">{{ section.settings.size_title | default: 'Choose your box size' }}</p>
        <div class="size-cards size-cards--redesign">
          <template x-for="size in availableSizes" :key="size.id">
            <div
              class="size-card size-card--redesign"
              :class="{ 'size-card--selected': selectedSize === size.id }"
              @click="selectedSize = size.id"
              @keydown.enter="selectedSize = size.id"
              @keydown.space.prevent="selectedSize = size.id"
              tabindex="0"
              role="option"
              :aria-selected="selectedSize === size.id"
            >
              <!-- Pack label at top-left -->
              <div class="size-card__packs">
                <span x-text="size.packsLabel.split(' ')[0]"></span><span class="packs-suffix"> <span x-text="size.packsLabel.split(' ')[1]"></span></span>
              </div>
              <!-- Badge positioned absolute top-right -->
              <template x-if="size.badge">
                <div class="size-card__badge" :style="size.badgeStyle">
                  <template x-if="size.badgeType === 'popular'">
                    <span>
                      {%- if section.settings.popular_badge_icon != blank -%}
                        <img src="{{ section.settings.popular_badge_icon | image_url: width: 24 }}" alt="" class="size-card__badge-icon">
                      {%- endif -%}
                    </span>
                  </template>
                  <template x-if="size.badgeType === 'freeShip'">
                    <span>
                      {%- if section.settings.free_ship_badge_icon != blank -%}
                        <img src="{{ section.settings.free_ship_badge_icon | image_url: width: 24 }}" alt="" class="size-card__badge-icon">
                      {%- endif -%}
                    </span>
                  </template>
                  <span x-text="size.badge"></span>
                </div>
              </template>
              <!-- Image centered -->
              <div class="size-card__image">
                <template x-if="size.id === 9">
                  <div>
                    {%- if section.settings.size_card_image_9 != blank -%}
                      <img src="{{ section.settings.size_card_image_9 | image_url: width: 200 }}" alt="9 pack" loading="lazy">
                    {%- endif -%}
                  </div>
                </template>
                <template x-if="size.id === 18">
                  <div>
                    {%- if section.settings.size_card_image_18 != blank -%}
                      <img src="{{ section.settings.size_card_image_18 | image_url: width: 200 }}" alt="18 pack" loading="lazy">
                    {%- endif -%}
                  </div>
                </template>
                <template x-if="size.id === 27">
                  <div>
                    {%- if section.settings.size_card_image_27 != blank -%}
                      <img src="{{ section.settings.size_card_image_27 | image_url: width: 200 }}" alt="27 pack" loading="lazy">
                    {%- endif -%}
                  </div>
                </template>
              </div>
              <div class="size-card__prices">
                <span class="size-card__price" x-text="formatPrice(getSizePrice(size.id))"></span>
                <span class="size-card__compare-price" x-show="getSizeComparePrice(size.id) > 0" x-text="formatPrice(getSizeComparePrice(size.id))"></span>
              </div>
              <div class="size-card__per-pack">
                <span x-text="formatPrice(getSizePrice(size.id) / (size.id * effectiveFlavorCount))"></span><span class="per-pack-suffix">/pack</span>
              </div>
              <div class="size-card__selected-label" x-show="selectedSize === size.id">Selected</div>
            </div>
          </template>
        </div>
      </div>

      <hr class="shop-purchase__divider">

      <!-- SUB & SAVE SECTION (New Design) -->
      <div class="sub-section-wrapper" style="display: flex; flex-direction: column; gap: var(--spacing-3);">
        <!-- Sub & Save Section with Toggle -->
        <div
          class="sub-section"
          :class="{
            'sub-section--active': subscribe,
            'sub-section--inactive': !subscribe
          }"
        >
          <div class="sub-section__header" @click="subscribe = !subscribe">
            <div class="sub-section__title-row">
              <div
                class="sub-toggle"
                :class="{ 'sub-toggle--active': subscribe }"
                role="switch"
                :aria-checked="subscribe"
                tabindex="0"
                @keydown.enter="subscribe = !subscribe"
                @keydown.space.prevent="subscribe = !subscribe"
              >
                <div class="sub-toggle__circle"></div>
              </div>
              <div>
                <div class="sub-section__title">SUB & SAVE</div>
                <div class="sub-section__subtitle">Join the Cult and get rewarded for life</div>
              </div>
            </div>
            <div class="sub-section__pricing">
              <div class="sub-section__price" x-text="formatPrice(getTotalPrice(true))"></div>
              <div class="sub-section__per-pack" x-text="getPerPackPrice(true) + '/pack'"></div>
            </div>
          </div>

          <!-- Benefit Cards -->
          <div class="sub-section__benefits" x-show="subscribe" x-collapse>
            <!-- 20% OFF Always Card -->
            <div class="sub-benefit-card sub-benefit-card--unlocked sub-benefit-card--discount">
              {%- if section.settings.sub_benefit_badge_text != blank -%}
                <div class="sub-benefit-card__banner" style="background: {{ section.settings.sub_benefit_badge_bg | default: '#ff6b35' }}; color: {{ section.settings.sub_benefit_badge_text_color | default: '#ffffff' }};">
                  {{ section.settings.sub_benefit_badge_text }}
                </div>
              {%- endif -%}
              {%- if section.settings.sub_benefit_card_1 != blank -%}
                <img src="{{ section.settings.sub_benefit_card_1 | image_url: width: 400 }}" alt="20% OFF ALWAYS" loading="lazy">
              {%- else -%}
                <div class="sub-benefit-card__placeholder">20%</div>
              {%- endif -%}
              <div class="sub-benefit-card__label">20% OFF ALWAYS</div>
            </div>

            <!-- Free Delivery Card (Locked/Unlocked) -->
            <div
              class="sub-benefit-card"
              :class="{ 'sub-benefit-card--locked': !isFreeShippingUnlocked(), 'sub-benefit-card--unlocked sub-benefit-card--delivery': isFreeShippingUnlocked() }"
            >
              <!-- Locked State: image with overlay text -->
              <template x-if="!isFreeShippingUnlocked()">
                <div class="sub-benefit-card__locked-content">
                  {%- if section.settings.sub_benefit_card_2_locked != blank -%}
                    <img src="{{ section.settings.sub_benefit_card_2_locked | image_url: width: 400 }}" alt="FREE DELIVERY - LOCKED" loading="lazy">
                  {%- else -%}
                    <div class="sub-benefit-card__locked-fallback"></div>
                  {%- endif -%}
                  <div class="sub-benefit-card__locked-overlay">
                    <span>27 PACKS UNLOCKS</span>
                    <span>FREE DELIVERY</span>
                  </div>
                </div>
              </template>

              <!-- Unlocked State: image directly in card (matches discount card) -->
              <template x-if="isFreeShippingUnlocked()">
                {%- if section.settings.sub_benefit_card_2_unlocked != blank -%}
                  <img src="{{ section.settings.sub_benefit_card_2_unlocked | image_url: width: 400 }}" alt="FREE DELIVERY UNLOCKED" loading="lazy">
                {%- else -%}
                  <div class="sub-benefit-card__placeholder">🚚</div>
                {%- endif -%}
              </template>

              <!-- Label (only shows when unlocked) -->
              <div class="sub-benefit-card__label" x-show="isFreeShippingUnlocked()">FREE DELIVERY</div>
            </div>
          </div>

          <!-- Benefit List -->
          <div class="sub-section__list" x-show="subscribe" x-collapse>
            <div class="sub-section__list-item">
              {%- if section.settings.sub_tick_icon != blank -%}
                <img src="{{ section.settings.sub_tick_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              {%- else -%}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              {%- endif -%}
              <span>{{ section.settings.sub_benefit_1 | default: 'Pause or cancel anytime' }}</span>
            </div>
            <div class="sub-section__list-item">
              {%- if section.settings.sub_tick_icon != blank -%}
                <img src="{{ section.settings.sub_tick_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              {%- else -%}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              {%- endif -%}
              <span>{{ section.settings.sub_benefit_2 | default: 'Change your flavours' }}</span>
            </div>
            <div class="sub-section__list-item">
              {%- if section.settings.sub_tick_icon != blank -%}
                <img src="{{ section.settings.sub_tick_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              {%- else -%}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              {%- endif -%}
              <span>{{ section.settings.sub_benefit_3 | default: 'Save 20% on future orders' }}</span>
            </div>
          </div>

          <!-- Frequency Dropdown -->
          <div class="sub-section__frequency" x-show="subscribe" x-collapse>
            <select
              class="frequency-dropdown"
              x-model="selectedFrequency"
              aria-label="Delivery frequency"
            >
              <template x-for="plan in sellingPlans" :key="plan.id">
                <option :value="plan.id" x-text="plan.name"></option>
              </template>
            </select>
          </div>

          <!-- Savings Callout -->
          <div class="sub-section__savings-wrapper" x-show="subscribe" x-collapse>
            <div class="sub-section__savings">
              YOU'RE SAVING <span x-text="formatPrice(getSavings())"></span>
            </div>
          </div>
        </div>

        <!-- One-time Purchase Option -->
        <div
          class="onetime-option"
          :class="{ 'onetime-option--selected': !subscribe }"
          @click="subscribe = false"
          @keydown.enter="subscribe = false"
          @keydown.space.prevent="subscribe = false"
          tabindex="0"
          role="option"
          :aria-selected="!subscribe"
        >
          <span class="onetime-option__title">One-time purchase</span>
          <span class="onetime-option__price" x-text="formatPrice(getTotalPrice(false))"></span>
        </div>
      </div>

      <!-- CTA Button (Desktop) -->
      <div class="desktop-cta">
        <button
          class="cta-button cta-button--yellow"
          @click="checkout()"
          :disabled="!canCheckout"
        >
          {{ section.settings.cta_button_text | default: 'BUY NOW' }} - <span x-text="formatPrice(getTotalPrice(subscribe))"></span>
        </button>
      </div>

      <!-- Trust Badges -->
      <div class="trust-badges">
        <span class="trust-badge">
          <span class="trust-badge__icon">🔒</span>
          <span>Secure checkout</span>
        </span>
      </div>

      <!-- Testimonial -->
      <div class="testimonial">
        <p class="testimonial__quote">"{{ section.settings.testimonial_quote }}"</p>
        <p class="testimonial__author">— {{ section.settings.testimonial_author }} <span class="testimonial__verified">✓ Verified subscriber</span></p>
      </div>
    </div>
  </div>

  <!-- INFO DRAWER (single drawer, content swapped via Alpine) -->
  <x-drawer id="flavor-info-drawer" class="drawer drawer--lg">
    <span class="h5" slot="header" x-text="drawerFlavorName"></span>

    <!-- Gallery -->
    <div class="flavor-drawer__gallery" x-show="drawerImages.length > 0">
      <div class="flavor-drawer__images" x-ref="drawerGallery">
        <template x-for="(img, i) in drawerImages" :key="'dimg-'+i">
          <div class="flavor-drawer__image">
            <img :src="img.src" :alt="img.alt" loading="lazy">
          </div>
        </template>
      </div>
      <div class="flavor-drawer__dots" x-show="drawerImages.length > 1">
        <template x-for="(img, i) in drawerImages" :key="'ddot-'+i">
          <button
            class="flavor-drawer__dot"
            :class="{ 'flavor-drawer__dot--active': drawerImageIndex === i }"
            @click="scrollDrawerTo(i)"
          ></button>
        </template>
      </div>
    </div>

    <!-- Description -->
    <div class="flavor-drawer__description" x-text="drawerDescription"></div>

    <!-- Testimonial -->
    <div class="flavor-drawer__quote" x-show="drawerQuote">
      <blockquote>
        <p x-text="drawerQuote"></p>
      </blockquote>
      <span class="flavor-drawer__author" x-text="drawerAuthor + ', verified buyer'"></span>
    </div>

  </x-drawer>

  <!-- Mobile Sticky CTA -->
  <div class="sticky-cta" x-cloak x-show="stickyCtaVisible"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="transform translate-y-full opacity-0"
    x-transition:enter-end="transform translate-y-0 opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="transform translate-y-0 opacity-100"
    x-transition:leave-end="transform translate-y-full opacity-0">
    <button
      class="cta-button cta-button--yellow"
      @click="checkout()"
      :disabled="!canCheckout"
    >
      {{ section.settings.cta_button_text | default: 'BUY NOW' }} - <span x-text="formatPrice(getTotalPrice(subscribe))"></span>
    </button>
  </div>
</div>

<script>
  function shopPurchaseFlow() {
    // Badge configuration from section settings
    const badgeConfig = {
      popular: {
        text: {{ section.settings.popular_badge_text | default: 'POPULAR' | json }},
        bg: {{ section.settings.popular_badge_bg | default: '#fbbf24' | json }},
        color: {{ section.settings.popular_badge_text_color | default: '#000000' | json }}
      },
      freeShip: {
        text: {{ section.settings.free_ship_badge_text | default: 'FREE' | json }},
        bg: {{ section.settings.free_ship_badge_bg | default: '#22c55e' | json }},
        color: {{ section.settings.free_ship_badge_text_color | default: '#ffffff' | json }}
      }
    };

    return {
      // Product data (populated from Liquid)
      // Merge products from collection and flavor blocks
      products: {
        {%- assign products_first = true -%}
        {%- assign included_product_ids = '' -%}
        {%- comment -%} First, add products from collection {%- endcomment -%}
        {%- for product in collections['breakfast'].products limit: 4 -%}
          {%- unless included_product_ids contains product.id -%}
            {%- unless products_first -%},{%- endunless -%}
            {%- assign products_first = false -%}
            {%- if included_product_ids != '' -%}{%- assign included_product_ids = included_product_ids | append: ',' -%}{%- endif -%}
            {%- assign included_product_ids = included_product_ids | append: product.id -%}
            {{ product.id }}: {
              id: {{ product.id }},
              title: {{ product.title | json }},
              handle: {{ product.handle | json }},
              isMixed: {% if product.title contains 'Mixed' %}true{% else %}false{% endif %},
              images: [
                {%- for image in product.images -%}
                  {
                    id: {{ image.id }},
                    src: {{ image.src | image_url: width: 800 | json }},
                    thumb: {{ image.src | image_url: width: 150 | json }},
                    alt: {{ image.alt | default: product.title | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              variants: {
                {%- for variant in product.variants -%}
                  {{ variant.id }}: {
                    id: {{ variant.id }},
                    title: {{ variant.title | json }},
                    price: {{ variant.price }},
                    compareAtPrice: {{ variant.compare_at_price | default: 0 }},
                    packs: {{ variant.title | remove: 'Pack' | remove: ' ' | times: 1 }},
                    sellingPlanId: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.selling_plan.id }}{% else %}null{% endif %},
                    discountPercent: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.price_adjustments.first.value | default: 0 }}{% else %}0{% endif %}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              }
            }
          {%- endunless -%}
        {%- endfor -%}
        {%- comment -%} Add products from flavor blocks that aren't already included {%- endcomment -%}
        {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
        {%- for block in flavor_blocks -%}
          {%- assign flavor_product = block.settings.product -%}
          {%- if flavor_product != blank -%}
            {%- unless included_product_ids contains flavor_product.id -%}
              {%- unless products_first -%},{%- endunless -%}
              {%- assign products_first = false -%}
              {%- if included_product_ids != '' -%}{%- assign included_product_ids = included_product_ids | append: ',' -%}{%- endif -%}
              {%- assign included_product_ids = included_product_ids | append: flavor_product.id -%}
              {{ flavor_product.id }}: {
                id: {{ flavor_product.id }},
                title: {{ flavor_product.title | json }},
                handle: {{ flavor_product.handle | json }},
                isMixed: {% if flavor_product.title contains 'Mixed' %}true{% else %}false{% endif %},
                images: [
                  {%- for image in flavor_product.images -%}
                    {
                      id: {{ image.id }},
                      src: {{ image.src | image_url: width: 800 | json }},
                      thumb: {{ image.src | image_url: width: 150 | json }},
                      alt: {{ image.alt | default: flavor_product.title | json }}
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                ],
                variants: {
                  {%- for variant in flavor_product.variants -%}
                    {{ variant.id }}: {
                      id: {{ variant.id }},
                      title: {{ variant.title | json }},
                      price: {{ variant.price }},
                      compareAtPrice: {{ variant.compare_at_price | default: 0 }},
                      packs: {{ variant.title | remove: 'Pack' | remove: ' ' | times: 1 }},
                      sellingPlanId: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.selling_plan.id }}{% else %}null{% endif %},
                      discountPercent: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.price_adjustments.first.value | default: 0 }}{% else %}0{% endif %}
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                }
              }
            {%- endunless -%}
          {%- endif -%}
        {%- endfor -%}
      },

      // State
      selectedBundle: null, // Product ID of selected bundle, or null
      selectedFlavors: [], // Array of selected individual flavor IDs
      bundleProductIds: [
        {%- assign bundle_ids_first = true -%}
        {%- for block in flavor_blocks -%}
          {%- if block.settings.is_bundle and block.settings.product != blank -%}
            {%- unless bundle_ids_first -%},{%- endunless -%}
            {%- assign bundle_ids_first = false -%}
            {{ block.settings.product.id }}
          {%- endif -%}
        {%- endfor -%}
        {%- comment -%}Fallback: include mixed box from collection if no bundle blocks{%- endcomment -%}
        {%- if bundle_ids_first -%}
          {%- for product in collections['breakfast'].products limit: 4 -%}
            {%- if product.title contains 'Mixed' -%}
              {{ product.id }}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      ],
      selectedSize: 18, // 9, 18, or 27 packs
      subscribe: true,
      discountPercent: 20, // Default, will be set from first variant with selling plan
      pickOwnExpanded: false, // Manual toggle for Pick Your Own dropdown
      stickyCtaVisible: false, // Mobile sticky CTA visibility (shown after scrolling to sub-section)
      selectedFrequency: null, // Selling plan ID (default to 4-week plan)

      // Drawer state
      drawerProductId: null,
      drawerIsBundle: false,
      drawerFlavorName: '',
      drawerDescription: '',
      drawerQuote: '',
      drawerAuthor: '',
      drawerImages: [],
      drawerImageIndex: 0,

      // Flavor data with descriptions and testimonials (from Liquid)
      flavorData: {
        {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
        {%- assign flavor_data_first = true -%}
        {%- for block in flavor_blocks -%}
          {%- assign flavor_product = block.settings.product -%}
          {%- if flavor_product != blank -%}
            {%- unless flavor_data_first -%},{%- endunless -%}
            {%- assign flavor_data_first = false -%}
            {{ flavor_product.id }}: {
              displayName: {{ block.settings.name_override | default: flavor_product.title | remove: 'Overnight Gut Oats |' | strip | upcase | json }},
              description: {{ block.settings.description | default: flavor_product.description | strip_html | truncate: 300 | json }},
              testimonialQuote: {{ block.settings.testimonial_quote | default: '' | json }},
              testimonialAuthor: {{ block.settings.testimonial_author | default: 'Customer' | json }}
            }
          {%- endif -%}
        {%- endfor -%}
        {%- if flavor_blocks.size == 0 -%}
          {%- assign fallback_first = true -%}
          {%- for product in collections['breakfast'].products limit: 4 -%}
            {%- unless product.title contains 'Mixed' -%}
              {%- unless fallback_first -%},{%- endunless -%}
              {%- assign fallback_first = false -%}
              {{ product.id }}: {
                description: {{ product.description | strip_html | truncate: 300 | json }},
                testimonialQuote: "",
                testimonialAuthor: "Customer"
              }
            {%- endunless -%}
          {%- endfor -%}
        {%- endif -%}
      },

      // Selling plans (from Liquid)
      sellingPlans: [
        {%- for product in collections['breakfast'].products limit: 1 -%}
          {%- for variant in product.variants limit: 1 -%}
            {%- for allocation in variant.selling_plan_allocations -%}
              {
                id: {{ allocation.selling_plan.id }},
                name: {{ allocation.selling_plan.name | json }}
              }{% unless forloop.last %},{% endunless %}
            {%- endfor -%}
          {%- endfor -%}
        {%- endfor -%}
      ],

      // Computed
      get mixedBoxProduct() {
        return Object.values(this.products).find(p => p.isMixed);
      },

      get individualProducts() {
        return Object.values(this.products).filter(p => !p.isMixed);
      },

      get effectiveFlavorCount() {
        if (this.selectedBundle !== null) return 1;
        return Math.max(1, this.selectedFlavors.length);
      },

      get availableSizes() {
        const count = this.effectiveFlavorCount;

        if (count === 1) {
          return [
            { id: 9, label: 'Starter', packsLabel: '9 PACK', duration: '~1 week', perPack: '2.00', badge: '', badgeType: '', badgeStyle: '' },
            { id: 18, label: 'Popular', packsLabel: '18 PACK', duration: '~2 weeks', perPack: '2.00', badge: badgeConfig.popular.text, badgeType: 'popular', badgeStyle: `background: ${badgeConfig.popular.bg}; color: ${badgeConfig.popular.color};` },
            { id: 27, label: 'Best Value', packsLabel: '27 PACK', duration: '~3 weeks', perPack: '2.00', badge: badgeConfig.freeShip.text, badgeType: 'freeShip', badgeStyle: `background: ${badgeConfig.freeShip.bg}; color: ${badgeConfig.freeShip.color};` }
          ];
        } else if (count === 2) {
          return [
            { id: 9, label: '9 Each', packsLabel: '18 TOTAL', duration: '9 per flavor', perPack: '2.00', badge: '', badgeType: '', badgeStyle: '' },
            { id: 18, label: '18 Each', packsLabel: '36 TOTAL', duration: '18 per flavor', perPack: '2.00', badge: badgeConfig.freeShip.text, badgeType: 'freeShip', badgeStyle: `background: ${badgeConfig.freeShip.bg}; color: ${badgeConfig.freeShip.color};` }
          ];
        } else {
          // 3 flavors
          return [
            { id: 9, label: '9 Each', packsLabel: '27 TOTAL', duration: '9 per flavor', perPack: '2.00', badge: '', badgeType: '', badgeStyle: '' },
            { id: 18, label: '18 Each', packsLabel: '54 TOTAL', duration: '18 per flavor', perPack: '2.00', badge: badgeConfig.freeShip.text, badgeType: 'freeShip', badgeStyle: `background: ${badgeConfig.freeShip.bg}; color: ${badgeConfig.freeShip.color};` }
          ];
        }
      },

      get canCheckout() {
        if (this.selectedBundle !== null) return true;
        return this.selectedFlavors.length > 0;
      },

      // Methods
      init() {
        // Get discount percent from first variant with a selling plan
        for (const product of Object.values(this.products)) {
          for (const variant of Object.values(product.variants)) {
            if (variant.discountPercent > 0) {
              this.discountPercent = variant.discountPercent;
              break;
            }
          }
          if (this.discountPercent !== 20) break;
        }

        // Set default frequency (prefer 4 weeks, or first available)
        if (this.sellingPlans.length > 0) {
          // Look for a 4-week plan
          const fourWeekPlan = this.sellingPlans.find(p =>
            p.name.toLowerCase().includes('4 week') ||
            p.name.toLowerCase().includes('every 4')
          );
          this.selectedFrequency = fourWeekPlan ? fourWeekPlan.id : this.sellingPlans[0].id;
        }

        // Ensure selected size is valid for current flavor count
        this.$watch('effectiveFlavorCount', (count) => {
          const validSizes = this.availableSizes.map(s => s.id);
          if (!validSizes.includes(this.selectedSize)) {
            this.selectedSize = validSizes[0];
          }
        });

        // Auto-select first bundle if no flavors selected (prevent empty state)
        this.$watch('selectedFlavors', (flavors) => {
          if (this.selectedBundle === null && flavors.length === 0) {
            // Small delay to allow for intentional deselection
            setTimeout(() => {
              if (this.selectedBundle === null && this.selectedFlavors.length === 0) {
                // Select first bundle
                if (this.bundleProductIds.length > 0) {
                  this.selectedBundle = this.bundleProductIds[0];
                }
              }
            }, 100);
          }
        });

        // Set default selection to first bundle
        if (this.bundleProductIds.length > 0) {
          this.selectedBundle = this.bundleProductIds[0];
        }

        // Show sticky CTA when sub-section is 50% visible (mobile only)
        if (window.innerWidth <= 999) {
          const subSection = document.querySelector('.sub-section');
          if (subSection) {
            const observer = new IntersectionObserver((entries) => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  this.stickyCtaVisible = true;
                  observer.disconnect(); // Once shown, stays visible
                }
              });
            }, { threshold: 0.5 });
            observer.observe(subSection);
          }

        }

        // Keep drawer inside Alpine scope so reactive bindings survive show/hide
        const drawer = document.getElementById('flavor-info-drawer');
        if (drawer) {
          Object.defineProperty(drawer, 'shouldAppendToBody', { get: () => false });
        }
      },

      // Open the info drawer for a flavor
      openDrawer(productId, isBundle) {
        this.drawerProductId = productId;
        this.drawerIsBundle = isBundle;

        const product = this.products[productId];
        if (!product) return;

        // Populate drawer content
        const data = this.flavorData[productId];
        this.drawerFlavorName = (data && data.displayName) || product.title.replace('Overnight Gut Oats |', '').trim().toUpperCase();
        this.drawerDescription = this.getFlavorDescription(productId);

        const testimonial = this.getFlavorTestimonial(productId);
        this.drawerQuote = testimonial.quote;
        this.drawerAuthor = testimonial.author;

        // Populate gallery from product images
        this.drawerImages = product.images.map((img, i) => ({
          src: img.src,
          alt: img.alt,
          id: i
        }));
        this.drawerImageIndex = 0;

        // Open the drawer
        const drawer = document.getElementById('flavor-info-drawer');
        if (drawer && drawer.show) {
          drawer.show();
        }

        // Sync carousel dots with manual scroll/swipe
        this.$nextTick(() => {
          const gallery = this.$refs.drawerGallery;
          if (gallery && !gallery._dotObserver) {
            gallery._dotObserver = new IntersectionObserver((entries) => {
              for (const entry of entries) {
                if (entry.isIntersecting) {
                  const images = gallery.querySelectorAll('.flavor-drawer__image');
                  const idx = Array.from(images).indexOf(entry.target);
                  if (idx >= 0) this.drawerImageIndex = idx;
                }
              }
            }, { root: gallery, threshold: 0.5 });

            this.$nextTick(() => {
              gallery.querySelectorAll('.flavor-drawer__image').forEach(img => {
                gallery._dotObserver.observe(img);
              });
            });
          } else if (gallery && gallery._dotObserver) {
            // Re-observe new images when drawer opens for a different product
            gallery._dotObserver.disconnect();
            this.$nextTick(() => {
              gallery.querySelectorAll('.flavor-drawer__image').forEach(img => {
                gallery._dotObserver.observe(img);
              });
            });
          }
        });
      },

      // Scroll drawer gallery to a specific image
      scrollDrawerTo(index) {
        this.drawerImageIndex = index;
        const gallery = this.$refs.drawerGallery;
        if (gallery) {
          const imageEl = gallery.querySelectorAll('.flavor-drawer__image')[index];
          if (imageEl) {
            gallery.scrollTo({ left: imageEl.offsetLeft, behavior: 'smooth' });
          }
        }
      },

      // Check if the flavor currently shown in the drawer is selected
      isDrawerFlavorSelected() {
        if (!this.drawerProductId) return false;
        if (this.drawerIsBundle) {
          return this.selectedBundle === this.drawerProductId;
        }
        return this.selectedFlavors.includes(this.drawerProductId);
      },

      // Toggle selection from within the drawer
      toggleFromDrawer() {
        if (!this.drawerProductId) return;
        this.selectOption(this.drawerProductId, this.drawerIsBundle);

        // Auto-close drawer on mobile after selecting
        if (window.innerWidth <= 999) {
          setTimeout(() => {
            const drawer = document.getElementById('flavor-info-drawer');
            if (drawer && drawer.hide) {
              drawer.hide();
            }
          }, 300);
        }
      },

      // Get flavor description from data (with fallback)
      getFlavorDescription(productId) {
        if (!productId) return '';
        const data = this.flavorData[productId];
        if (data && data.description) {
          return data.description;
        }
        // Fallback to product description
        const product = this.products[productId];
        return product ? product.title.replace('Overnight Gut Oats |', '').trim() + ' - delicious and nutritious.' : '';
      },

      // Get testimonial data for flavor
      getFlavorTestimonial(productId) {
        if (!productId) return { quote: '', author: '' };
        const data = this.flavorData[productId];
        if (data) {
          return {
            quote: data.testimonialQuote || '',
            author: data.testimonialAuthor || 'Customer'
          };
        }
        return { quote: '', author: 'Customer' };
      },

      // Check if free shipping is unlocked (£40 threshold)
      isFreeShippingUnlocked() {
        return this.getTotalPrice(this.subscribe) >= 4000; // £40 in pence
      },

      // Select a flavor option (handles both bundles and individual flavors)
      selectOption(productId, isBundle, event) {
        if (isBundle) {
          // Selecting a bundle clears individual selections
          this.selectedBundle = (this.selectedBundle === productId) ? null : productId;
          this.selectedFlavors = [];
        } else {
          // Selecting an individual flavor clears bundle selection
          this.selectedBundle = null;
          this.toggleFlavor(productId);
        }
        this.pickOwnExpanded = false;
      },

      // Legacy method for backwards compatibility
      selectMixedBox() {
        if (this.bundleProductIds.length > 0) {
          this.selectOption(this.bundleProductIds[0], true);
        }
      },

      selectPickMode() {
        this.selectedBundle = null;
      },

      toggleFlavor(productId) {
        // Clear bundle selection when toggling individual flavors
        if (this.selectedBundle !== null) {
          this.selectedBundle = null;
          this.selectedFlavors = [productId];
        } else {
          // Toggle the flavor in the array
          const index = this.selectedFlavors.indexOf(productId);
          if (index > -1) {
            this.selectedFlavors.splice(index, 1);
          } else if (this.selectedFlavors.length < 3) {
            this.selectedFlavors.push(productId);
          }
        }
      },

      getVariantForSize(productId, packSize) {
        const product = this.products[productId];
        if (!product) return null;
        return Object.values(product.variants).find(v => v.packs === packSize);
      },

      getPrice(packSize) {
        // Returns total price in pence for the given pack size
        // For bundle selections, returns bundle price
        // For multi-flavor selections, returns sum of all selected flavors
        if (this.selectedBundle !== null) {
          const variant = this.getVariantForSize(this.selectedBundle, packSize);
          return variant ? variant.price : 0;
        }

        // Sum up price for each selected flavor (or use one product for calculation if none selected)
        if (this.selectedFlavors.length === 0) {
          const product = this.individualProducts[0];
          const variant = this.getVariantForSize(product?.id, packSize);
          return variant ? variant.price : 0;
        }

        let total = 0;
        for (const productId of this.selectedFlavors) {
          const variant = this.getVariantForSize(productId, packSize);
          if (variant) {
            total += variant.price;
          }
        }
        return total;
      },

      getSizePrice(packSize) {
        // Returns price for size card display, applying subscription discount if active
        const basePrice = this.getPrice(packSize);
        if (this.subscribe) {
          return Math.round(basePrice * (1 - this.discountPercent / 100));
        }
        return basePrice;
      },

      getSizeComparePrice(packSize) {
        if (!this.subscribe) return 0;
        const oneOffPrice = this.getPrice(packSize);
        const subPrice = this.getSizePrice(packSize);
        return oneOffPrice > subPrice ? oneOffPrice : 0;
      },

      getTotalPrice(withSubscription) {
        const packSize = this.selectedSize;
        let total = this.getPrice(packSize);

        if (withSubscription) {
          total = Math.round(total * (1 - this.discountPercent / 100));
        }

        return total;
      },

      getSavings() {
        return this.getTotalPrice(false) - this.getTotalPrice(true);
      },

      getPerPackPrice(withSubscription) {
        const packSize = this.selectedSize;
        const flavorCount = this.selectedBundle !== null ? 1 : Math.max(1, this.selectedFlavors.length);
        const totalPacks = packSize * flavorCount;
        const totalPrice = this.getTotalPrice(withSubscription);
        const perPack = totalPrice / totalPacks;
        return '£' + (perPack / 100).toFixed(2);
      },

      formatPrice(pence) {
        return '£' + (pence / 100).toFixed(2);
      },

      getOrderSummary() {
        const packSize = this.selectedSize;

        if (this.selectedBundle !== null) {
          const product = this.products[this.selectedBundle];
          const name = product ? product.title.replace('Overnight Gut Oats |', '').trim() : 'Bundle';
          return `1× ${name} (${packSize} packs)`;
        } else if (this.selectedFlavors.length === 0) {
          return 'Select a flavor';
        } else if (this.selectedFlavors.length === 1) {
          const product = this.products[this.selectedFlavors[0]];
          const name = product.title.replace('Overnight Gut Oats |', '').trim();
          return `1× ${name} (${packSize} packs)`;
        } else {
          const names = this.selectedFlavors.map(id => {
            const product = this.products[id];
            return product.title.replace('Overnight Gut Oats |', '').trim().split(' ')[0];
          }).join(', ');
          return `${this.selectedFlavors.length}× ${packSize}-pack (${names})`;
        }
      },

      async checkout() {
        if (!this.canCheckout) return;

        const packSize = this.selectedSize;
        let items = [];

        // Use selected frequency or default selling plan
        const getSellingPlanForVariant = (variant) => {
          if (!this.subscribe) return null;
          // If a frequency is selected and matches an allocation, use it
          if (this.selectedFrequency) {
            return this.selectedFrequency;
          }
          // Fall back to default selling plan from variant
          return variant.sellingPlanId;
        };

        if (this.selectedBundle !== null) {
          const variant = this.getVariantForSize(this.selectedBundle, packSize);
          if (variant) {
            const item = {
              id: variant.id,
              quantity: 1
            };
            const sellingPlan = getSellingPlanForVariant(variant);
            if (sellingPlan) {
              item.selling_plan = sellingPlan;
            }
            items.push(item);
          }
        } else {
          for (const productId of this.selectedFlavors) {
            const variant = this.getVariantForSize(productId, packSize);
            if (variant) {
              const item = {
                id: variant.id,
                quantity: 1
              };
              const sellingPlan = getSellingPlanForVariant(variant);
              if (sellingPlan) {
                item.selling_plan = sellingPlan;
              }
              items.push(item);
            }
          }
        }

        // Clear cart first, then add items, then redirect to checkout
        try {
          // Clear existing cart
          await fetch('/cart/clear.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          // Add items to cart
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items })
          });

          if (!response.ok) {
            const error = await response.json();
            console.error('Cart add error:', error);
            alert('Sorry, there was an error. Please try again.');
            return;
          }

          // Redirect to checkout
          window.location.href = '/checkout';
        } catch (error) {
          console.error('Checkout error:', error);
          alert('Sorry, there was an error. Please try again.');
        }
      },

    };
  }
</script>

{% schema %}
{
  "name": "Shop Purchase Flow",
  "tag": "section",
  "class": "shopify-section--shop-purchase-flow",
  "settings": [
    {
      "type": "header",
      "content": "Header Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Overnight Gut Oats"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Delicious overnight oats. Just add milk."
    },
    {
      "type": "text",
      "id": "reviews_text",
      "label": "Reviews text",
      "default": "5.0 from 200+ reviews"
    },
    {
      "type": "image_picker",
      "id": "rating_image",
      "label": "Rating stars image",
      "info": "Upload a custom stars image (e.g., pink stars)"
    },
    {
      "type": "header",
      "content": "Product Benefits"
    },
    {
      "type": "text",
      "id": "benefit_1",
      "label": "Benefit 1",
      "default": "1+ billion probiotics per serving"
    },
    {
      "type": "image_picker",
      "id": "benefit_1_icon",
      "label": "Benefit 1 icon"
    },
    {
      "type": "text",
      "id": "benefit_2",
      "label": "Benefit 2",
      "default": "No artificial ingredients or added sugars"
    },
    {
      "type": "image_picker",
      "id": "benefit_2_icon",
      "label": "Benefit 2 icon"
    },
    {
      "type": "text",
      "id": "benefit_3",
      "label": "Benefit 3",
      "default": "Supports healthy digestion"
    },
    {
      "type": "image_picker",
      "id": "benefit_3_icon",
      "label": "Benefit 3 icon"
    },
    {
      "type": "header",
      "content": "Testimonial"
    },
    {
      "type": "text",
      "id": "testimonial_quote",
      "label": "Quote",
      "default": "Finally healthy oats that taste amazing!"
    },
    {
      "type": "text",
      "id": "testimonial_author",
      "label": "Author",
      "default": "Sarah T."
    },
    {
      "type": "header",
      "content": "Flavor Selection"
    },
    {
      "type": "text",
      "id": "flavors_title",
      "label": "Flavors section title",
      "default": "Pick your flavors"
    },
    {
      "type": "text",
      "id": "size_title",
      "label": "Size section title",
      "default": "Choose your size"
    },
    {
      "type": "header",
      "content": "Badge Configuration"
    },
    {
      "type": "paragraph",
      "content": "Bestseller Badge (Flavor Cards)"
    },
    {
      "type": "text",
      "id": "bestseller_badge_text",
      "label": "Bestseller badge text",
      "default": "BEST SELLER"
    },
    {
      "type": "color",
      "id": "bestseller_badge_bg",
      "label": "Bestseller badge background",
      "default": "#fbbf24"
    },
    {
      "type": "color",
      "id": "bestseller_badge_text_color",
      "label": "Bestseller badge text color",
      "default": "#000000"
    },
    {
      "type": "image_picker",
      "id": "bestseller_badge_icon",
      "label": "Bestseller badge icon",
      "info": "Small image displayed left of badge text"
    },
    {
      "type": "paragraph",
      "content": "Popular Badge (Size Cards)"
    },
    {
      "type": "text",
      "id": "popular_badge_text",
      "label": "Popular badge text",
      "default": "POPULAR"
    },
    {
      "type": "color",
      "id": "popular_badge_bg",
      "label": "Popular badge background",
      "default": "#fbbf24"
    },
    {
      "type": "color",
      "id": "popular_badge_text_color",
      "label": "Popular badge text color",
      "default": "#000000"
    },
    {
      "type": "image_picker",
      "id": "popular_badge_icon",
      "label": "Popular badge icon",
      "info": "Star icon for Popular badge"
    },
    {
      "type": "paragraph",
      "content": "Free Shipping Badge (Size Cards)"
    },
    {
      "type": "text",
      "id": "free_ship_badge_text",
      "label": "Free shipping badge text",
      "default": "FREE"
    },
    {
      "type": "color",
      "id": "free_ship_badge_bg",
      "label": "Free shipping badge background",
      "default": "#22c55e"
    },
    {
      "type": "color",
      "id": "free_ship_badge_text_color",
      "label": "Free shipping badge text color",
      "default": "#ffffff"
    },
    {
      "type": "image_picker",
      "id": "free_ship_badge_icon",
      "label": "Free shipping badge icon",
      "info": "Truck icon for free shipping badge"
    },
    {
      "type": "paragraph",
      "content": "Subscription Benefit Card Banner"
    },
    {
      "type": "text",
      "id": "sub_benefit_badge_text",
      "label": "Subscription banner text",
      "default": "ALL ORDERS"
    },
    {
      "type": "color",
      "id": "sub_benefit_badge_bg",
      "label": "Subscription banner background",
      "default": "#ff6b35"
    },
    {
      "type": "color",
      "id": "sub_benefit_badge_text_color",
      "label": "Subscription banner text color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Box Size Images"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_9",
      "label": "9-pack image",
      "info": "Stacked product image for 9-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_18",
      "label": "18-pack image",
      "info": "Stacked product image for 18-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_27",
      "label": "27-pack image",
      "info": "Stacked product image for 27-pack option"
    },
    {
      "type": "header",
      "content": "Subscription"
    },
    {
      "type": "image_picker",
      "id": "sub_tick_icon",
      "label": "Tick icon",
      "info": "Custom checkmark icon for benefit list"
    },
    {
      "type": "text",
      "id": "sub_benefit_1",
      "label": "Benefit 1",
      "default": "Pause or cancel anytime"
    },
    {
      "type": "text",
      "id": "sub_benefit_2",
      "label": "Benefit 2",
      "default": "Change your flavours"
    },
    {
      "type": "text",
      "id": "sub_benefit_3",
      "label": "Benefit 3",
      "default": "Save 20% on future orders"
    },
    {
      "type": "header",
      "content": "Subscription Benefit Cards"
    },
    {
      "type": "image_picker",
      "id": "sub_benefit_card_1",
      "label": "20% OFF card image",
      "info": "Image for the '20% OFF ALWAYS' benefit card"
    },
    {
      "type": "image_picker",
      "id": "sub_benefit_card_2_unlocked",
      "label": "Free Delivery - Unlocked",
      "info": "Image shown when free shipping is unlocked (order ≥ £40)"
    },
    {
      "type": "image_picker",
      "id": "sub_benefit_card_2_locked",
      "label": "Free Delivery - Locked",
      "info": "Pre-blurred image shown when free shipping is locked (order < £40)"
    },
    {
      "type": "header",
      "content": "Checkout Button"
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "Checkout button text",
      "default": "BUY NOW"
    },
    {
      "type": "header",
      "content": "Selected State Styling"
    },
    {
      "type": "color",
      "id": "selected_background",
      "label": "Selected background",
      "default": "#D8F7FF"
    },
    {
      "type": "color",
      "id": "selected_border",
      "label": "Selected border",
      "default": "#6CDFFF"
    },
    {
      "type": "color",
      "id": "selected_text",
      "label": "Selected text color",
      "default": "#000000",
      "info": "Text color for selected options"
    },
  ],
  "blocks": [
    {
      "type": "flavor_option",
      "name": "Flavor Option",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "checkbox",
          "id": "is_bundle",
          "label": "Bundle option (mutually exclusive)",
          "default": false,
          "info": "When selected, deselects all other options. Use for mixed/variety packs."
        },
        {
          "type": "image_picker",
          "id": "card_image",
          "label": "Card image",
          "info": "Product image displayed on the card"
        },
        {
          "type": "image_picker",
          "id": "card_background",
          "label": "Card background",
          "info": "Full-bleed background image (optional)"
        },
        {
          "type": "text",
          "id": "name_override",
          "label": "Display name",
          "info": "Overrides product title on the card"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Subtitle",
          "info": "Text below the name (e.g., 'All 3' for mixed box)"
        },
        {
          "type": "checkbox",
          "id": "show_badge",
          "label": "Show badge",
          "default": false
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "info": "Shown when this option's tab is active"
        },
        {
          "type": "header",
          "content": "Pill Styling"
        },
        {
          "type": "color",
          "id": "pill_selected_bg",
          "label": "Selected background",
          "default": "#3C1B04"
        },
        {
          "type": "color",
          "id": "pill_selected_text",
          "label": "Selected text",
          "default": "#FFFFFF"
        },
        {
          "type": "color",
          "id": "pill_selected_border",
          "label": "Selected border",
          "default": "#3C1B04"
        },
        {
          "type": "header",
          "content": "Testimonial"
        },
        {
          "type": "text",
          "id": "testimonial_quote",
          "label": "Quote"
        },
        {
          "type": "text",
          "id": "testimonial_author",
          "label": "Author"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shop Purchase Flow",
      "blocks": [
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": true,
            "name_override": "THE CULT MIX",
            "subtitle": "All 3",
            "show_badge": true,
            "description": "All 3 flavors in one box — can't decide? This is the one for you."
          }
        },
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": false,
            "name_override": "CACAO",
            "description": "Rich chocolate oats for a satisfying start."
          }
        },
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": false,
            "name_override": "STRAWBERRY",
            "description": "Sweet strawberry goji for a fruity morning."
          }
        },
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": false,
            "name_override": "CINNAMON",
            "description": "Warming cinnamon spice for cozy mornings."
          }
        }
      ]
    }
  ]
}
{% endschema %}
