{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
SHOP PURCHASE FLOW V3 (merged)
----------------------------------------------------------------------------------------------------------------------

V3 merges v1 size cards + v2 qty picker into a unified layout:
- Left column: hero image carousel (sticky on desktop)
- Right column: flavor carousel + read-only size cards + sub & save + CTA
- Qty picker maps to correct variant sizes (1→9-pack, 2→18-pack, 3→27-pack)
- Direct-to-checkout (no cart)

{%- endcomment -%}

<style>
  [x-cloak] { display: none !important; }

  .shop-purchase-flow {
    /* Local variables - map to theme variables for consistency */
    --spf-text-color: #3C1B01;
    --spf-text-muted: rgba(60, 27, 1, 0.6);
    --spf-text-subtle: rgba(60, 27, 1, 0.4);
    --spf-background: rgb(var(--background-primary));
    --spf-border-color: rgb(var(--text-primary) / 0.12);
    --spf-accent: rgb(var(--accent));
    --spf-success: rgb(var(--success-text));
    --spf-star-color: rgb(var(--star-color));

    /* === NEW DESIGN TOKENS === */
    /* Pink palette */
    --color-pink-dark: #F05E87;
    --color-pink-light: #FFBED6;
    --color-pink-border: #B45B7E;
    /* Neutral palette */
    --color-cream: #F0E9DE;
    --color-border-light: #CDCDCD;
    --color-chevron: #361A05;
    --color-locked-overlay: rgba(54, 26, 5, 0.9);
    --color-locked-border: #361A05;
    /* CTA */
    --color-cta-yellow: #FFE500;
    --color-cta-yellow-hover: #E8C300;

    /* Card gradients */
    --gradient-unselected: linear-gradient(to bottom, #FFFFFF 0%, #F0E9DE 100%);
    --gradient-selected: linear-gradient(to bottom, #F05E87 0%, #FFBED6 100%);
    --gradient-sub-section: linear-gradient(to bottom right, #FFBED6 0%, #F05E87 100%);

    /* Z-index scale */
    --z-base: 1;
    --z-card-hover: 5;
    --z-dropdown: 10;
    --z-sticky: 100;

    /* Semantic colors for badges/CTA - keep brand-specific */
    --spf-cta-background: #93c5fd;
    --spf-cta-hover: #60a5fa;
    --spf-badge-popular: #fbbf24;
    --spf-badge-success: #22c55e;
    --spf-badge-hot: #ff6b35;
    --spf-badge-featured: #ec4899;

    /* Selector box styling - using new gradient system */
    --spf-selector-bg: var(--color-cream);
    --spf-selector-border: var(--color-border-light);
    --spf-selector-selected-bg: {{ section.settings.selected_background | default: '#FFBED6' }};
    --spf-selector-selected-border: {{ section.settings.selected_border | default: '#B45B7E' }};
    --spf-selector-selected-text: {{ section.settings.selected_text | default: '#000000' }};
    --spf-selector-radius: 8px;

    --spf-subscribe-selected: #fef3c7;
    --spf-subscribe-border: #f59e0b;
    --spf-savings-color: var(--color-pink-dark);

    /* Transitions (respecting reduced motion) */
    --transition-fast: 0.1s ease;
    --transition-normal: 0.15s ease-out;

    padding: var(--spacing-8) var(--spacing-5);
    font-family: var(--text-font-family);
    background-color: #FFF7EE;
    overflow: hidden;  /* Prevents horizontal scroll on mobile */
  }

  @media screen and (min-width: 1000px) {
    .shop-purchase-flow {
      overflow: visible;  /* Allow sticky to work on desktop */
    }
  }

  /* Reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .shop-purchase-flow {
      --transition-fast: 0s;
      --transition-normal: 0s;
    }

    .shop-purchase-flow *,
    .shop-purchase-flow *::before,
    .shop-purchase-flow *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Tabular numbers for prices */
  .shop-purchase-flow [class*="price"],
  .shop-purchase-flow [class*="savings"],
  .shop-purchase-flow [class*="per-pack"] {
    font-variant-numeric: tabular-nums;
  }

  /* Focus ring styles for accessibility */
  .shop-purchase-flow :focus-visible {
    outline: 2px solid var(--color-pink-dark);
    outline-offset: 2px;
  }

  /* Remove outline on mouse focus */
  .shop-purchase-flow :focus:not(:focus-visible) {
    outline: none;
  }

  .shop-purchase-flow__container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-8);
  }

  .hero-gallery-column {
    min-width: 0;
  }

  @media screen and (min-width: 1000px) {
    .shop-purchase-flow__container {
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-12);
      align-items: start;
    }

    .hero-gallery-column {
      position: sticky;
      top: calc(var(--sticky-area-height) + 20px);
      height: fit-content;
      align-self: start;
    }

    .shop-purchase {
      align-self: start;
    }

    #flavor-info-drawer {
      width: min(calc(50vw - 1.5rem), 600px);
      margin-left: max(0px, calc(50vw - 600px));
    }

    .hero-gallery__thumb {
      width: 80px;
      height: 80px;
    }
  }

  /* ============================================
     HERO GALLERY
     ============================================ */
  .hero-gallery__track {
    display: grid;
    grid: auto / auto-flow 100%;
    border-radius: 12px;
    background: var(--color-cream);
  }

  .hero-gallery__slide {
    aspect-ratio: 1;
    overflow: hidden;
    scroll-snap-stop: normal;
  }

  .hero-gallery__slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 12px;
  }

  .hero-gallery__thumbs {
    display: flex;
    gap: 8px;
    padding: var(--spacing-3) 0;
    overflow-x: auto;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }

  .hero-gallery__thumbs::-webkit-scrollbar {
    display: none;
  }

  .hero-gallery__thumb {
    flex-shrink: 0;
    width: 64px;
    height: 64px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    padding: 0;
    background: var(--color-cream);
    transition: border-color 200ms ease, opacity 200ms ease;
    opacity: 0.6;
  }

  .hero-gallery__thumb--active {
    border-color: #3C1B01;
    opacity: 1;
  }

  .hero-gallery__thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* ============================================
     FLAVOR CAROUSEL WRAPPER (desktop arrows)
     ============================================ */
  .flavor-carousel-wrapper {
    position: relative;
    margin-bottom: var(--spacing-4);
  }

  .flavor-carousel__arrow {
    display: none;
  }

  /* ============================================
     FLAVOR GRID
     ============================================ */
  .flavor-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .flavor-grid__card {
    position: relative;
    border-radius: 12px;
    border: 1px solid rgba(60, 27, 1, 0.5);
    background: #FFFFFF;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    flex-direction: column;
    overflow: visible;
    min-height: 240px;
  }

  .flavor-grid__card--has-bg {
    background-image: var(--card-bg-image, none), linear-gradient(#FFFFFF, #FFFFFF);
    background-size: cover, auto;
    background-position: center, center;
    background-repeat: no-repeat, no-repeat;
  }

  .flavor-grid__card--selected {
    background: #ED6B93;
    border-color: rgba(60, 27, 1, 1);
  }

  .flavor-grid__card--has-bg.flavor-grid__card--selected {
    background-image: var(--card-bg-image, none), linear-gradient(#ED6B93, #ED6B93);
    background-size: cover, auto;
    background-position: center, center;
    background-repeat: no-repeat, no-repeat;
  }

  .flavor-grid__card--selected:hover {
    border-color: rgba(60, 27, 1, 1);
  }

  .flavor-grid__badge {
    position: absolute;
    top: -10px;
    left: 16px;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }

  .flavor-grid__badge-icon {
    width: 12px;
    height: 12px;
    object-fit: contain;
  }

  .flavor-grid__info {
    position: absolute;
    top: 13px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid var(--color-border-light);
    background: rgba(255, 255, 255, 0.85);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    font-style: italic;
    font-family: Georgia, 'Times New Roman', serif;
    font-weight: 600;
    color: var(--color-border-light);
    z-index: 2;
    transition: background var(--transition-normal);
  }

  .flavor-grid__info:hover {
    background: white;
    color: var(--spf-text-muted);
  }

  .flavor-grid__body {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: var(--spacing-3);
    padding-bottom: 0;
    min-height: 0;
  }

  .flavor-grid__name {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--spf-text-color);
    line-height: 1.2;
    padding-top: 10px;
    padding-right: 32px; /* space for info icon */
  }

  .flavor-grid__subtitle {
    font-size: 12px;
    font-weight: 600;
    color: var(--spf-text-muted);
    letter-spacing: 0.05em;
    line-height: 1;
    margin-top: 2px;
  }

  .flavor-grid__image {
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-2);
    min-height: 0;
  }

  .flavor-grid__image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  /* When card has background image, hide the image wrapper */
  .flavor-grid__card--has-bg .flavor-grid__image {
    display: none;
  }

  .flavor-grid__card--has-bg .flavor-grid__body {
    flex: 1;
    justify-content: flex-start;
  }

  /* ============================================
     QTY PICKER (replaces Choose/Chosen button)
     ============================================ */
  .qty-picker {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    width: calc(100% - var(--spacing-3) * 2);
    margin: 0 var(--spacing-3) var(--spacing-3);
    height: 44px;
    border-radius: 9999px;
    background: var(--color-cream);
    border: 1px solid rgba(60, 27, 1, 0.5);
    overflow: hidden;
  }

  .qty-picker__btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 100%;
    border: none;
    background: transparent;
    cursor: pointer;
    color: rgba(60, 27, 1, 1);
    transition: background 0.15s ease;
  }

  .qty-picker__btn:hover:not(:disabled) {
    background: rgba(240, 94, 135, 0.1);
  }

  .qty-picker__btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .qty-picker__btn svg {
    width: 18px;
    height: 18px;
  }

  .qty-picker__count {
    flex: 1;
    text-align: center;
    font-size: var(--text-lg);
    font-weight: 700;
    color: rgba(60, 27, 1, 1);
    font-variant-numeric: tabular-nums;
    min-width: 32px;
  }

  .flavor-grid__card--selected .qty-picker {
    background: white;
    border-color: rgba(60, 27, 1, 1);
  }

  .qty-picker--empty {
    background: #ED6B93;
    border-color: rgba(60, 27, 1, 0.5);
  }

  .qty-picker__add {
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
    color: white;
    font-weight: 700;
    font-size: 13px;
    text-transform: uppercase;
    text-align: center;
    cursor: pointer;
    letter-spacing: 0.03em;
  }

  /* Mobile: slightly smaller cards */
  @media screen and (max-width: 767px) {
    .flavor-grid {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .flavor-grid__card {
      min-height: 200px;
    }

    .flavor-grid__name {
      font-size: var(--text-sm);
    }

    .qty-picker {
      height: 36px;
      font-size: 11px;
    }

    .qty-picker__btn {
      width: 36px;
    }

    .qty-picker__btn svg {
      width: 16px;
      height: 16px;
    }

    .qty-picker__count {
      font-size: var(--text-base);
    }
  }

  /* ============================================
     INFO DRAWER
     ============================================ */
  .flavor-drawer__gallery {
    margin-bottom: var(--spacing-4);
  }

  .flavor-drawer__images {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    gap: 8px;
    border-radius: 12px;
  }

  .flavor-drawer__images::-webkit-scrollbar {
    display: none;
  }

  .flavor-drawer__image {
    flex-shrink: 0;
    width: 100%;
    scroll-snap-align: start;
  }

  .flavor-drawer__image img {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 12px;
  }

  .flavor-drawer__dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 12px 0;
  }

  .flavor-drawer__dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ccc;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: background 0.15s ease;
  }

  .flavor-drawer__dot--active {
    background: var(--color-pink-dark);
  }

  .flavor-drawer__description {
    font-size: var(--text-base);
    line-height: 1.6;
    color: var(--spf-text-color);
    margin-bottom: var(--spacing-4);
  }

  .flavor-drawer__quote {
    margin-bottom: var(--spacing-6);
  }

  .flavor-drawer__quote blockquote {
    background: #F4E7DB;
    padding: var(--spacing-4);
    border-radius: var(--spf-selector-radius);
    font-size: var(--text-sm);
    font-style: italic;
    color: var(--spf-text-color);
    margin: 0;
    line-height: 1.5;
  }

  .flavor-drawer__author {
    display: block;
    text-align: right;
    font-size: var(--text-xs);
    color: #3C1B01;
    margin-top: var(--spacing-2);
  }

  .flavor-drawer__cta {
    width: 100%;
    padding: var(--spacing-4);
    border-radius: 9999px;
    border: 2px solid var(--color-pink-border);
    background: var(--color-pink-dark);
    color: white;
    font-size: var(--text-base);
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.25s ease;
    margin-top: var(--spacing-4);
  }

  .flavor-drawer__cta:hover {
    opacity: 0.9;
  }

  .flavor-drawer__cta--remove {
    background: var(--color-cream);
    color: var(--spf-text-color);
    border-color: var(--color-border-light);
  }

  /* ============================================
     PURCHASE COLUMN
     ============================================ */
  .shop-purchase {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
    min-width: 0;  /* Prevent grid blowout */
  }

  .shop-purchase__title {
    font-size: var(--text-h2);
    font-weight: 700;
    margin: 0 0 var(--spacing-2) 0;
    color: var(--spf-text-color);
    font-family: var(--heading-font-family);
    letter-spacing: var(--heading-letter-spacing);
  }

  .shop-purchase__subtitle {
    font-size: var(--text-base);
    color: var(--spf-text-color);
    margin: 0 0 var(--spacing-3) 0;
  }

  .shop-purchase__rating {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .shop-purchase__stars {
    color: var(--spf-star-color);
    letter-spacing: 2px;
  }

  .shop-purchase__stars-image {
    height: 20px;
    width: auto;
  }

  .shop-purchase__divider {
    display: none;
  }

  .shop-purchase__section-title {
    font-size: var(--text-xs);
    font-weight: 600;
    letter-spacing: 0.05em;
    color: var(--spf-text-muted);
    margin: 0 0 var(--spacing-3) 0;
  }

  /* ============================================
     FLAVOR SELECTION
     ============================================ */
  .flavor-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .flavor-option {
    padding: var(--spacing-4) var(--spacing-5);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .flavor-option:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .flavor-option--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .flavor-option--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-option--selected .flavor-option__name,
  .flavor-option--selected .flavor-option__description,
  .flavor-option--selected .flavor-option__flavor-list {
    color: var(--spf-text-color);
  }

  .flavor-option--selected .flavor-option__toggle {
    border-color: var(--spf-selector-border);
    color: var(--spf-text-color);
  }

  /* Featured badge styling */
  .flavor-option__badge--featured {
    position: absolute;
    top: -10px;
    right: 16px;
    background: var(--spf-badge-featured);
    color: white;
  }

  .flavor-option--has-badge {
    position: relative;
  }

  /* Dropdown variant for Pick Your Own */
  .flavor-option--dropdown {
    padding: 0;
    overflow: hidden;
  }

  .flavor-option--dropdown .flavor-option__header {
    padding: var(--spacing-4) var(--spacing-5);
    cursor: pointer;
  }

  .flavor-option__toggle {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-2) var(--spacing-3);
    border: 1px solid var(--spf-border-color);
    border-radius: var(--rounded);
    background: transparent;
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
    color: var(--spf-text-color);
  }

  .flavor-option__toggle:hover {
    background: rgb(var(--text-primary) / 0.05);
  }

  .flavor-option__arrow {
    transition: transform 0.2s ease;
    width: 16px;
    height: 16px;
  }

  .flavor-option--expanded .flavor-option__arrow {
    transform: rotate(180deg);
  }

  .flavor-option__content {
    background: white;
    border-top: 1px solid var(--spf-border-color);
    overflow: hidden;
  }

  .flavor-option__content-inner {
    padding: var(--spacing-4);
  }

  /* Flavor list text for Mixed Box */
  .flavor-option__flavor-list {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: var(--spacing-1);
    margin-bottom: 0;
  }

  /* Mixed Box with image variant */
  .flavor-option--mixed {
    display: flex;
    align-items: center;
    padding: 0;
    overflow: hidden;
  }

  .flavor-option__image {
    flex-shrink: 0;
    width: 70px;
    height: 70px;
    margin: 8px;
  }

  .flavor-option__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  .flavor-option__text {
    flex: 1;
    padding: var(--spacing-4) var(--spacing-5);
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* When no image, keep normal padding */
  .flavor-option--mixed:not(:has(.flavor-option__image)) {
    padding: var(--spacing-4) var(--spacing-5);
  }

  .flavor-option__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .flavor-option__left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .flavor-option__radio {
    display: none;
  }

  .flavor-option__emoji {
    font-size: 1.25rem;
  }

  .flavor-option__name {
    font-weight: 600;
    font-size: var(--text-base);
    color: var(--spf-text-color);
  }

  .flavor-option__badge {
    font-size: var(--text-xs);
    padding: 2px var(--spacing-2);
    border-radius: var(--rounded-xs);
    background: var(--spf-badge-popular);
    color: var(--spf-text-color);
    font-weight: 600;
  }

  .flavor-option__description {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: var(--spacing-2);
    padding-left: 32px;
  }

  /* Pick Your Own nested options */
  .flavor-option__nested {
    margin-top: var(--spacing-4);
    padding: var(--spacing-3);
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded);
    opacity: 0.5;
    pointer-events: none;
    transition: opacity var(--transition-normal);
  }

  .flavor-option--selected .flavor-option__nested {
    opacity: 1;
    pointer-events: auto;
  }

  .flavor-checkbox {
    display: flex;
    align-items: center;
    padding: var(--spacing-3);
    border-bottom: 1px solid var(--spf-border-color);
    cursor: pointer;
    transition: background var(--transition-normal);
    border-radius: var(--rounded);
  }

  .flavor-checkbox:last-child {
    border-bottom: none;
  }

  .flavor-checkbox:hover {
    background: rgb(var(--text-primary) / 0.03);
  }

  .flavor-checkbox--checked {
    background: rgb(var(--accent) / 0.05);
  }

  .flavor-checkbox__box {
    width: 20px;
    height: 20px;
    border-radius: var(--rounded-xs);
    border: 2px solid rgb(var(--text-primary) / 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-right: var(--spacing-3);
    transition: all var(--transition-normal);
  }

  .flavor-checkbox--checked .flavor-checkbox__box {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .flavor-checkbox__check {
    color: rgb(var(--background-primary));
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .flavor-checkbox--checked .flavor-checkbox__check {
    opacity: 1;
  }

  .flavor-checkbox__emoji {
    font-size: 1.25rem;
    margin-right: var(--spacing-3);
  }

  .flavor-checkbox__info {
    flex: 1;
  }

  .flavor-checkbox__name {
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .flavor-checkbox__desc {
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
    margin-top: 2px;
  }

  .flavor-checkbox__badge {
    font-size: var(--text-xs);
    padding: 2px 6px;
    border-radius: var(--rounded-xs);
    background: var(--spf-badge-hot);
    color: white;
    font-weight: 600;
    margin-left: auto;
  }

  .flavor-checkbox--disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  /* ============================================
     FLAVOR CARDS (Card-based selectors)
     ============================================ */
  .flavor-cards {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .flavor-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    padding: 0;
    border: 2px solid var(--spf-selector-border);
    border-radius: var(--spf-selector-radius);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .flavor-card:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .flavor-card--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .flavor-card--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-card--disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  .flavor-card__image {
    width: 70px;
    height: 70px;
    margin: 8px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .flavor-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  .flavor-card__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--spf-selector-selected-border) 0%, color-mix(in srgb, var(--spf-selector-selected-border) 70%, white) 100%);
    color: white;
    font-size: 1.5rem;
  }

  .flavor-card__name {
    flex: 1;
    font-weight: 700;
    font-size: var(--text-base);
    text-transform: uppercase;
    color: var(--spf-text-color);
  }

  .flavor-card__checkbox {
    width: 24px;
    height: 24px;
    margin-right: 16px;
    border-radius: 6px;
    border: 2px solid var(--spf-selector-border);
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--transition-normal);
  }

  .flavor-card__checkbox svg {
    width: 14px;
    height: 14px;
    stroke: white;
    stroke-width: 3;
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .flavor-card--selected .flavor-card__checkbox {
    background: var(--spf-selector-selected-border);
    border-color: var(--spf-selector-selected-border);
  }

  .flavor-card--selected .flavor-card__checkbox svg {
    opacity: 1;
  }

  .flavor-card:hover:not(.flavor-card--selected) .flavor-card__checkbox {
    border-color: rgb(var(--text-primary) / 0.3);
  }

  /* Info text below flavor cards */
  .flavor-option__info {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    margin-top: var(--spacing-3);
    padding: var(--spacing-2) var(--spacing-3);
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    background: rgb(var(--text-primary) / 0.03);
    border-radius: var(--rounded);
  }

  .flavor-option__info svg {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    opacity: 0.6;
  }

  /* ============================================
     BASKET BADGE (reused in mobile sticky)
     ============================================ */
  .basket-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: background 0.35s ease, border-color 0.35s ease, color 0.35s ease, transform 0.25s ease;
  }

  .basket-badge--unlocked {
    transform: scale(1.08);
    animation: badge-pop 0.4s ease;
  }

  @keyframes badge-pop {
    0%   { transform: scale(1); }
    50%  { transform: scale(1.15); }
    100% { transform: scale(1.08); }
  }

  .basket-badge__icon {
    width: 12px;
    height: 12px;
    object-fit: contain;
  }

  /* ============================================
     SIZE CARDS (read-only, transplanted from v1)
     ============================================ */
  .size-selection-wrapper {
    margin-bottom: var(--spacing-4);
  }

  .size-progress-row {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 6px;
  }

  .size-progress {
    height: 12px;
    background: #D4F5FF;
    border: 1.5px solid #ACDBE7;
    border-radius: 6px;
    margin-bottom: 12px;
    overflow: hidden;
  }

  .size-progress__fill {
    height: 100%;
    background: #ACDBE7;
    border-radius: 6px;
    transition: width 300ms ease;
  }

  .size-cards-viewport {
    --size-gap: 12px;
    overflow: hidden;
    position: relative;
  }

  .size-cards--redesign {
    display: flex;
    gap: var(--size-gap);
    transition: transform 300ms ease;
    width: 100%;
  }

  .size-card--redesign {
    flex: 0 0 calc((100% - 2 * var(--size-gap)) / 3);
    position: relative;
    padding: var(--spacing-3);
    border-radius: var(--spf-selector-radius);
    border: none;
    background: #FFFFFF;
    color: #3C1B01;
    text-align: left;
    transition: border-color var(--transition-normal), background var(--transition-normal);
    min-height: 44px;
  }

  .size-card--redesign.size-card--selected {
    background: #ACDBE7;
    border: 1px solid #3C1B01;
  }

  .size-card--redesign.size-card--selected .size-card__compare-price {
    color: rgba(60, 27, 1, 0.5);
  }

  .size-card--redesign .size-card__packs {
    font-weight: 700;
    font-size: var(--text-sm);
    margin-bottom: var(--spacing-2);
  }

  .size-card--redesign .size-card__image {
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--spacing-4);
  }

  .size-card--redesign .size-card__image img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
  }

  .size-card--redesign .size-card__prices {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 6px;
    margin-bottom: 2px;
  }

  .size-card--redesign .size-card__price {
    font-weight: 700;
    font-size: 1rem;
  }

  .size-card--redesign .size-card__compare-price {
    font-size: 0.85rem;
    color: rgba(60, 27, 1, 0.5);
    text-decoration: line-through;
  }

  .size-card--redesign .size-card__per-pack {
    display: block;
    background: #e5e5e5;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: var(--text-sm);
    color: rgba(60, 27, 1, 0.6);
    text-align: center;
    width: fit-content;
    margin: var(--spacing-1) auto 0;
  }

  .size-card--redesign.size-card--selected .size-card__per-pack {
    background: #3C1B01;
    color: #ACDBE7;
  }


  @media screen and (max-width: 999px) {
    .size-progress-row,
    .size-progress {
      display: none;
    }

    .size-cards-viewport {
      --size-gap: 8px;
    }

    .size-card--redesign {
      padding: var(--spacing-2);
    }

    .size-card--redesign .size-card__image {
      height: 70px;
    }

    .size-card--redesign .size-card__packs {
      font-size: var(--text-sm);
    }

    .size-card--redesign .size-card__price {
      font-size: 0.9rem;
    }

    .size-card--redesign .size-card__compare-price {
      font-size: 0.75rem;
    }

    .size-card--redesign .size-card__per-pack {
      font-size: 12px;
      padding: 3px 10px;
    }

    .size-card--redesign .size-card__packs .packs-suffix {
      display: none;
    }
  }

  /* ============================================
     SUBSCRIPTION TOGGLE
     ============================================ */
  .sub-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .sub-option {
    padding: var(--spacing-4) var(--spacing-5);
    border-radius: var(--spf-selector-radius);
    border: 2px solid var(--spf-selector-border);
    background: var(--spf-selector-bg);
    cursor: pointer;
    transition: all var(--transition-normal);
  }

  .sub-option:hover {
    border-color: rgb(var(--text-primary) / 0.25);
  }

  .sub-option--selected {
    border-color: var(--spf-selector-selected-border);
    background: var(--spf-selector-selected-bg);
  }

  .sub-option--selected:hover {
    border-color: var(--spf-selector-selected-border);
  }

  /* Subscribe option styling when selected */
  .sub-option--subscribe.sub-option--selected .sub-option__radio {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .sub-option__per-pack {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__per-pack-label {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    font-weight: 400;
  }

  .sub-option__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sub-option__left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .sub-option__radio {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid rgb(var(--text-primary) / 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--transition-normal);
  }

  .sub-option--selected .sub-option__radio {
    border-color: var(--spf-text-color);
    background: var(--spf-text-color);
  }

  .sub-option__radio::after {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgb(var(--background-primary));
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .sub-option--selected .sub-option__radio::after {
    opacity: 1;
  }

  .sub-option__title {
    font-weight: 600;
    font-size: var(--text-base);
    color: var(--spf-text-color);
  }

  .sub-option__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__benefits {
    margin-top: var(--spacing-3);
    padding-left: 32px;
  }

  .sub-option__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .sub-option__benefit-icon {
    color: var(--spf-success);
    flex-shrink: 0;
  }

  .sub-option__savings {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--spf-savings-color);
    margin-top: auto;
  }

  /* Subscribe section redesign - two column layout */
  .sub-option__layout {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-4);
  }

  .sub-option__left-col {
    flex: 1;
  }

  .sub-option__right-col {
    text-align: right;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }

  .sub-option__title-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    margin-bottom: var(--spacing-2);
  }

  .sub-option__per-pack {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-option__per-box {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
    margin-top: 2px;
  }

  .sub-option__benefits {
    margin-top: var(--spacing-2);
    padding-left: 0;
  }

  .sub-option__benefit {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
    margin-bottom: 4px;
  }

  .sub-option__benefit img {
    width: 16px;
    height: 16px;
    object-fit: contain;
  }

  /* Subscribe cards mobile overrides */
  @media screen and (max-width: 767px) {
    .sub-option {
      padding: var(--spacing-3) var(--spacing-4);
    }

    .sub-option__title {
      font-size: var(--text-sm);
    }

    .sub-option__benefit {
      font-size: var(--text-xs);
    }

    .sub-option__per-pack {
      font-size: 1.1rem;
    }

    .sub-option__per-box,
    .sub-option__savings {
      font-size: var(--text-xs);
    }
  }

  /* ============================================
     CTA BUTTON
     ============================================ */
  .cta-button {
    width: 100%;
    padding: var(--spacing-5) var(--spacing-6);
    border-radius: 60px;
    background: #FED700;
    color: var(--spf-text-color);
    font-size: var(--text-base);
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
    border: 1px solid #E0C426;
  }

  .cta-button:hover {
    background: #E8C300;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(254, 215, 0, 0.4);
  }

  .cta-button:active {
    transform: translateY(0);
  }

  .cta-button:disabled {
    background: rgb(var(--text-primary) / 0.2);
    color: var(--spf-text-muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .cta-button__summary {
    font-size: var(--text-sm);
    font-weight: 400;
    opacity: 0.8;
    margin-top: 4px;
    text-transform: none;
  }

  /* ============================================
     TRUST BADGES
     ============================================ */
  .trust-badges {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: var(--spacing-4);
    padding: var(--spacing-4) 0;
    font-size: var(--text-xs);
    color: var(--spf-text-muted);
  }

  .trust-badge {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .trust-badge__icon {
    font-size: var(--text-sm);
  }


  /* ============================================
     MOBILE STICKY CTA
     ============================================ */
  .sticky-cta {
    display: none;
  }

  @media screen and (max-width: 999px) {
    .sticky-cta {
      display: block;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--spacing-3) var(--spacing-4);
      padding-bottom: calc(var(--spacing-3) + env(safe-area-inset-bottom));
      background: #FFF7EE;
      border-top: 1px solid #3C1B01;
      box-shadow: 0 -4px 12px rgb(var(--text-primary) / 0.08);
      z-index: 100;
    }

    .sticky-cta .cta-button {
      padding: var(--spacing-4);
    }

    /* Add padding to bottom of purchase column to prevent content being hidden by sticky CTA */
    .shop-purchase {
      padding-bottom: 100px;
    }
  }

  /* ============================================
     MOBILE STICKY CTA — BASKET VARIANT
     ============================================ */
  .sticky-cta--basket {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 8px 16px;
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
  }

  /* Heading row: title + pill + badge */
  .sticky-cta__heading-row {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .sticky-cta__title {
    font-size: var(--text-sm);
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: #3C1B01;
  }

  .sticky-cta__sub-pill {
    font-size: var(--text-xs);
    font-weight: 500;
    color: #ACDBE7;
    background: #3C1B01;
    padding: 3px 10px;
    border-radius: 12px;
    white-space: nowrap;
  }

  .sticky-cta__heading-row .basket-badge {
    margin-left: auto;
  }

  /* Progress bar — full-width, matches inline bar style */
  .sticky-cta__progress {
    height: 12px;
    background: #D4F5FF;
    border: 1.5px solid #ACDBE7;
    border-radius: 6px;
    overflow: hidden;
  }

  .sticky-cta__progress-fill {
    height: 100%;
    background: #ACDBE7;
    border-radius: 6px;
    transition: width 300ms ease;
  }

  /* Size pills row */
  .sticky-cta__sizes {
    display: none; /* hidden for A/B test — was: flex */
    gap: 6px;
  }

  .sticky-cta__size-pill {
    flex: 1;
    text-align: center;
    padding: 6px 0;
    font-size: var(--text-xs);
    font-weight: 500;
    color: #3C1B01;
    border: none;
    background: #fff;
    border-radius: 8px;
  }

  .sticky-cta__size-pill--active {
    background: #ACDBE7;
    border: 1px solid #3C1B01;
    color: #3C1B01;
    font-weight: 600;
  }

  /* Compact badge variant for sticky CTA */
  .basket-badge--compact {
    font-size: 9px;
    padding: 3px 6px;
    white-space: nowrap;
  }

  /* ============================================
     ERROR STATE
     ============================================ */
  .flavor-error {
    color: rgb(var(--error-text));
    font-size: var(--text-sm);
    padding: var(--spacing-2) var(--spacing-3);
    background: rgb(var(--error-background));
    border-radius: var(--rounded);
    margin-top: var(--spacing-2);
  }

  /* ============================================
     SUB & SAVE SECTION (New Design)
     ============================================ */
  .sub-section {
    border-radius: var(--spf-selector-radius);
    border: 1px solid var(--color-border-light);
    overflow: hidden;
    transition: opacity var(--transition-normal), filter var(--transition-normal);
    color: #3C1B01;
  }

  .sub-section--active {
    background: #F4E7DB;
    border-color: #3C1B01;
  }

  .sub-section--inactive {
    opacity: 0.5;
    filter: grayscale(0.5);
  }

  .sub-section__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-4);
    cursor: pointer;
  }

  .sub-section__title-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
  }

  .sub-section__title {
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-section--active .sub-section__title {
    color: #3C1B01;
  }

  .sub-section__subtitle {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
  }

  .sub-section--active .sub-section__subtitle {
    color: #3C1B01;
    opacity: 0.9;
  }

  .sub-section__pricing {
    text-align: right;
  }

  .sub-section__price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .sub-section--active .sub-section__price {
    color: #3C1B01;
  }

  .sub-section__per-pack {
    font-size: var(--text-sm);
    color: var(--spf-text-muted);
  }

  .sub-section--active .sub-section__per-pack {
    background: #ACDBE7;
    color: #3C1B01;
    padding: 4px 12px;
    border-radius: 20px;
    opacity: 1;
  }

  /* iOS-style toggle */
  .sub-toggle {
    position: relative;
    width: 52px;
    height: 32px;
    background: var(--color-border-light);
    border: 1px solid transparent;
    border-radius: 16px;
    cursor: pointer;
    transition: background var(--transition-normal);
    flex-shrink: 0;
  }

  .sub-toggle--active {
    background: #fff;
    border: 1px solid #3C1B01;
  }

  .sub-toggle__circle {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 26px;
    height: 26px;
    background: #F4E7DB;
    border: 1px solid #3C1B01;
    border-radius: 50%;
    transition: transform var(--transition-normal);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .sub-toggle--active .sub-toggle__circle {
    transform: translateX(20px);
  }

  /* Benefit cards */
  .sub-section__benefits {
    display: none;
    gap: 12px;
    padding: 0 var(--spacing-4) var(--spacing-4);
  }

  .sub-benefit-card {
    flex: 1;
    max-width: 150px;
    border-radius: var(--spf-selector-radius);
    overflow: hidden;
    position: relative;
  }

  .sub-benefit-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .sub-benefit-card--unlocked {
    background: #FFFFFF;
    border: 1px solid #B45B7E;
  }

  .sub-benefit-card--locked {
    position: relative;
  }

  .sub-benefit-card--locked::after {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--color-locked-overlay);
    border: 1px solid var(--color-locked-border);
    border-radius: var(--spf-selector-radius);
  }

  .sub-benefit-card__lock-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
  }

  /* 20% OFF Always card variant */
  .sub-benefit-card--discount {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-3);
    padding-top: var(--spacing-5);
  }

  .sub-benefit-card--discount img {
    width: auto;
    height: auto;
    max-width: 70%;
    max-height: 75px;
    object-fit: contain;
  }

  .sub-benefit-card__banner {
    position: absolute;
    top: 6px;
    right: 6px;
    padding: 3px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
    /* background and color set via inline styles */
  }

  .sub-benefit-card__label {
    margin-top: var(--spacing-2);
    font-weight: 700;
    font-size: 12px;
    text-align: center;
    color: #3C1B01;
  }

  /* Free Delivery card variant */
  .sub-benefit-card--delivery {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-3);
    padding-top: var(--spacing-5);
  }

  .sub-benefit-card--delivery img {
    width: auto;
    height: auto;
    max-width: 70%;
    max-height: 75px;
    object-fit: contain;
  }

  /* Locked state overlay */
  .sub-benefit-card__locked-content {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-3);
    padding-top: var(--spacing-5);
    width: 100%;
    height: 100%;
  }

  .sub-benefit-card__locked-content img {
    width: auto;
    height: auto;
    max-width: 70%;
    max-height: 75px;
    object-fit: contain;
  }

  .sub-benefit-card__locked-overlay {
    position: absolute;
    bottom: var(--spacing-3);
    left: 0;
    right: 0;
    z-index: 1; /* appear above ::after overlay */
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    color: white;
    font-weight: 700;
    font-size: 10px;
    text-transform: uppercase;
  }

  .sub-benefit-card__locked-overlay span:last-child {
    font-size: 12px;
  }

  /* Unlocked content wrapper */
  .sub-benefit-card__unlocked-content {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sub-benefit-card__unlocked-content img {
    width: auto;
    height: auto;
    max-width: 70%;
    max-height: 75px;
    object-fit: contain;
  }

  .sub-benefit-card__placeholder {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-pink-border);
  }

  /* Benefit list */
  .sub-section__list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2) var(--spacing-4);
    padding: var(--spacing-4);
    margin: 0 var(--spacing-4) var(--spacing-4);
    background: #FFFFFF;
    border: 1px solid #3C1B01;
    border-radius: var(--spf-selector-radius);
  }

  .sub-section__list-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--text-sm);
    color: var(--spf-text-color);
  }

  .sub-section--active .sub-section__list-item {
    color: var(--spf-text-color);
  }

  .sub-section__list-item img {
    width: 24px;
    height: 24px;
    object-fit: contain;
  }

  .sub-section__list-item svg {
    width: 24px;
    height: 24px;
  }

  /* Frequency dropdown */
  .sub-section__frequency {
    padding: 0 var(--spacing-4) var(--spacing-4);
  }

  .frequency-dropdown {
    width: 100%;
    padding: var(--spacing-3) var(--spacing-4);
    border: 1px solid #3C1B01;
    border-radius: var(--spf-selector-radius);
    background: white;
    font-size: var(--text-sm);
    font-weight: 700;
    text-transform: none;
    color: var(--spf-text-color);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23361A05' stroke-width='2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
    min-height: 44px;
  }

  /* Savings callout - positioned pill */
  .sub-section__savings-wrapper {
    position: relative;
    padding: 0 var(--spacing-4) var(--spacing-14);
  }

  .sub-section__savings {
    display: inline-block;
    float: right;
    padding: var(--spacing-2) var(--spacing-4);
    border-radius: 20px;
    font-size: var(--text-sm);
    font-weight: 700;
    background: #ACDBE7;
    color: #3C1B01;
  }

  /* ============================================
     ONE-TIME PURCHASE OPTION
     ============================================ */
  .onetime-option {
    display: none;
    padding: var(--spacing-4);
    border-radius: var(--spf-selector-radius);
    border: 1px solid var(--color-border-light);
    background: var(--gradient-unselected);
    cursor: pointer;
    transition: border-color var(--transition-normal);
    justify-content: space-between;
    align-items: center;
    min-height: 44px;
  }

  .onetime-option:hover {
    border-color: var(--spf-text-color);
  }

  .onetime-option--selected {
    background: var(--gradient-selected);
    border-color: var(--color-pink-border);
  }

  .onetime-option__title {
    font-weight: 600;
    color: var(--spf-text-color);
  }

  .onetime-option--selected .onetime-option__title {
    color: white;
  }

  .onetime-option__price {
    font-weight: 700;
    color: var(--spf-text-color);
  }

  .onetime-option--selected .onetime-option__price {
    color: white;
  }

  /* ============================================
     CTA BUTTON (Updated Yellow)
     ============================================ */
  .cta-button--yellow {
    background: var(--color-cta-yellow);
    border-color: var(--color-cta-yellow-hover);
  }

  .cta-button--yellow:hover {
    background: var(--color-cta-yellow-hover);
    box-shadow: 0 4px 12px rgba(255, 229, 0, 0.4);
  }

  /* ============================================
     SUBSCRIBE SECTION - MOBILE
     ============================================ */
  @media screen and (max-width: 999px) {
    .desktop-cta {
      display: none;
    }

    .trust-badges {
      display: none;
    }

    /* Header: toggle + title + price on row 1, subtitle on row 2 */
    .sub-section__header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      grid-template-rows: auto auto;
      gap: var(--spacing-2) var(--spacing-3);
      align-items: start;
    }

    .sub-section__title-row {
      display: contents;
    }

    .sub-toggle {
      grid-row: 1;
      grid-column: 1;
    }

    .sub-section__title-row > div:last-child {
      display: contents;
    }

    .sub-section__title {
      grid-row: 1;
      grid-column: 2;
    }

    .sub-section__subtitle {
      grid-row: 2;
      grid-column: 1 / -1;
      padding-top: var(--spacing-2);
      text-align: left;
    }

    .sub-section__pricing {
      grid-row: 1;
      grid-column: 3;
    }

    .sub-section__benefits {
      flex-wrap: wrap;
      gap: 8px;
    }

    .sub-benefit-card {
      flex: 1 1 calc(50% - 4px);
      min-width: 100px;
    }

    /* Benefits list: keep flex wrap on mobile */
    .sub-section__list {
      gap: var(--spacing-2) var(--spacing-3);
    }

    .onetime-option {
      flex-wrap: wrap;
      gap: var(--spacing-2);
    }
  }

  /* ============================================
     REDUCED MOTION — NEW COMPONENTS
     ============================================ */
  @media (prefers-reduced-motion: reduce) {
    .sticky-cta__progress-fill,
    .size-progress__fill {
      transition: none;
    }
  }
</style>

<div
  class="shop-purchase-flow"
  x-data="shopPurchaseFlowV3()"
  x-init="init()"
  data-section-id="{{ section.id }}"
>
  <div class="shop-purchase-flow__container">
    <!-- HERO GALLERY COLUMN (Left, sticky on desktop) -->
    <div class="hero-gallery-column">
      <div class="hero-gallery">
        <div class="hero-gallery__track scroll-area" x-ref="heroTrack">
          {%- for i in (1..8) -%}
            {%- assign hero_key = 'hero_image_' | append: i -%}
            {%- assign hero_img = section.settings[hero_key] -%}
            {%- if hero_img != blank -%}
              <div class="hero-gallery__slide snap-start">
                <img src="{{ hero_img | image_url: width: 800 }}" alt="{{ section.settings.title }}" loading="lazy">
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
        <div class="hero-gallery__thumbs">
          {%- for i in (1..8) -%}
            {%- assign hero_key = 'hero_image_' | append: i -%}
            {%- assign hero_img = section.settings[hero_key] -%}
            {%- if hero_img != blank -%}
              <button
                class="hero-gallery__thumb"
                :class="{ 'hero-gallery__thumb--active': heroImageIndex === {{ forloop.index0 }} }"
                @click="scrollHeroTo({{ forloop.index0 }})"
                aria-label="View image {{ forloop.index }}"
              >
                <img
                  src="{{ hero_img | image_url: width: 200 }}"
                  alt="{{ section.settings.title }} - image {{ forloop.index }}"
                  loading="lazy"
                  width="200"
                  height="200"
                >
              </button>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    </div>

    <!-- PURCHASE COLUMN (Right) -->
    <div class="shop-purchase">

      <!-- Title / Subtitle / Rating -->
      <div class="shop-purchase__header-text">
        <h1 class="shop-purchase__title">{{ section.settings.title }}</h1>
        <p class="shop-purchase__subtitle">{{ section.settings.subtitle }}</p>
        <div class="shop-purchase__rating">
          {%- if section.settings.rating_image != blank -%}
            <img class="shop-purchase__stars-image" src="{{ section.settings.rating_image | image_url: width: 200 }}" alt="5 star rating" height="20">
          {%- else -%}
            <span class="shop-purchase__stars">★★★★★</span>
          {%- endif -%}
          <span>{{ section.settings.reviews_text }}</span>
        </div>
      </div>

      <!-- FLAVOR CAROUSEL -->
      <p class="shop-purchase__section-title">{{ section.settings.flavors_title | default: 'Choose your cults' }}</p>
      {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
      <div class="flavor-carousel-wrapper">
        <button class="flavor-carousel__arrow flavor-carousel__arrow--prev" @click="scrollFlavors(-1)" aria-label="Scroll flavors left">&lsaquo;</button>
        <div class="flavor-grid" x-ref="flavorTrack" role="listbox" aria-label="Flavor options">
          {%- if flavor_blocks.size > 0 -%}
            {%- for block in flavor_blocks -%}
              {%- assign block_product = block.settings.product -%}
              {%- if block_product != blank -%}
                {%- assign display_name = block.settings.name_override | default: block_product.title | remove: 'Overnight Gut Oats |' | strip -%}
                {%- assign card_bg = block.settings.card_background -%}
                {%- assign card_image = block.settings.card_image -%}
                <div
                  class="flavor-grid__card{% if card_bg != blank %} flavor-grid__card--has-bg{% endif %}"
                  :class="{
                    'flavor-grid__card--selected': getQty({{ block_product.id }}) > 0
                  }"
                  {%- if card_bg != blank %}
                  style="--card-bg-image: url('{{ card_bg | image_url: width: 600 }}')"
                  {%- endif %}
                  {{ block.shopify_attributes }}
                >
                  {%- comment -%} Badge (optional, half-off top edge) {%- endcomment -%}
                  {%- if block.settings.show_badge and section.settings.bestseller_badge_text != blank -%}
                    <span
                      class="flavor-grid__badge"
                      style="background: {{ section.settings.bestseller_badge_bg | default: '#fbbf24' }}; color: {{ section.settings.bestseller_badge_text_color | default: '#000000' }};"
                    >
                      {%- if section.settings.bestseller_badge_icon != blank -%}
                        <img class="flavor-grid__badge-icon" src="{{ section.settings.bestseller_badge_icon | image_url: width: 24 }}" alt="">
                      {%- endif -%}
                      {{ section.settings.bestseller_badge_text }}
                    </span>
                  {%- endif -%}

                  {%- comment -%} Info icon (opens drawer) {%- endcomment -%}
                  <button
                    class="flavor-grid__info"
                    @click.stop="openDrawer({{ block_product.id }})"
                    aria-label="More info about {{ display_name }}"
                  >
i
                  </button>

                  {%- comment -%} Card body (tap opens drawer) {%- endcomment -%}
                  <div class="flavor-grid__body" @click="openDrawer({{ block_product.id }})">
                    <div class="flavor-grid__name">{{ display_name }}</div>
                    <div class="flavor-grid__subtitle">9 pack</div>
                    <div class="flavor-grid__image">
                      {%- if card_image != blank -%}
                        <img src="{{ card_image | image_url: width: 400 }}" alt="{{ display_name }}" loading="lazy">
                      {%- elsif block_product.featured_image != blank -%}
                        <img src="{{ block_product.featured_image | image_url: width: 400 }}" alt="{{ display_name }}" loading="lazy">
                      {%- endif -%}
                    </div>
                  </div>

                  {%- comment -%} Qty Picker {%- endcomment -%}
                  <div class="qty-picker" :class="{ 'qty-picker--empty': getQty({{ block_product.id }}) === 0 }">
                    <button
                      class="qty-picker__add"
                      x-show="getQty({{ block_product.id }}) === 0"
                      @click.stop="incrementQty({{ block_product.id }})"
                      aria-label="Add {{ display_name }}"
                    >Choose</button>
                    <template x-if="getQty({{ block_product.id }}) > 0">
                      <div style="display:flex;align-items:center;width:100%;height:100%;">
                        <button
                          class="qty-picker__btn qty-picker__btn--minus"
                          @click.stop="decrementQty({{ block_product.id }})"
                          :disabled="getQty({{ block_product.id }}) === 0"
                          aria-label="Decrease quantity of {{ display_name }}"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                        <span class="qty-picker__count" x-text="getQty({{ block_product.id }})"></span>
                        <button
                          class="qty-picker__btn qty-picker__btn--plus"
                          @click.stop="incrementQty({{ block_product.id }})"
                          aria-label="Increase quantity of {{ display_name }}"
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                      </div>
                    </template>
                  </div>
                </div>
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        </div>
        <button class="flavor-carousel__arrow flavor-carousel__arrow--next" @click="scrollFlavors(1)" aria-label="Scroll flavors right">&rsaquo;</button>
      </div>

      <!-- SIZE INDICATOR (read-only) -->
      <div class="size-selection-wrapper">
        <p class="shop-purchase__section-title">{{ section.settings.size_title | default: 'Your box size' }}</p>

        <!-- Free delivery progress bar + badge -->
        <div class="size-progress-row">
          <div class="basket-badge"
            :class="{ 'basket-badge--unlocked': freeDelivery }"
            :style="freeDelivery
              ? 'background: {{ section.settings.free_ship_badge_bg | default: '#22c55e' }}; color: {{ section.settings.free_ship_badge_text_color | default: '#ffffff' }};'
              : 'background: transparent; border: 1.5px solid {{ section.settings.free_ship_badge_bg | default: '#22c55e' }}; color: {{ section.settings.free_ship_badge_text_color | default: '#ffffff' }};'"
          >
            {%- if section.settings.free_ship_badge_icon != blank -%}
              <img src="{{ section.settings.free_ship_badge_icon | image_url: width: 24 }}" alt="" class="basket-badge__icon">
            {%- endif -%}
            <span>{{ section.settings.free_ship_badge_text | default: 'FREE' }}</span>
          </div>
        </div>
        <div class="size-progress">
          <div class="size-progress__fill" :style="'width: ' + deliveryProgress + '%'"></div>
        </div>

        <div class="size-cards-viewport">
          <div class="size-cards size-cards--redesign"
               :style="'transform: translateX(calc(-' + sizeViewportOffset + ' * (100% + var(--size-gap)) / 3))'">
            <template x-for="size in availableSizes" :key="size.id">
              <div class="size-card size-card--redesign"
                :class="{ 'size-card--selected': currentTier === size.id }"
              >
                <div class="size-card__packs">
                  <span x-text="size.packs + ' packs'"></span>
                </div>
                <div class="size-card__image">
                  <img x-show="sizeCardImages[size.id]"
                       :src="sizeCardImages[size.id]"
                       :alt="size.packs + ' pack'"
                       loading="lazy">
                </div>
                <div class="size-card__prices">
                  <span class="size-card__price" x-text="formatPrice(getSizePrice(size.id))"></span>
                </div>
                <div class="size-card__per-pack">
                  <span x-text="formatPrice(getSizePrice(size.id) / size.id)"></span><span>/pack</span>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- SUB & SAVE SECTION (Kept As-Is) -->
      <div class="sub-section-wrapper" style="display: flex; flex-direction: column; gap: var(--spacing-3);">
        <!-- Sub & Save Section with Toggle -->
        <div
          class="sub-section"
          :class="{
            'sub-section--active': subscribe,
            'sub-section--inactive': !subscribe
          }"
        >
          <div class="sub-section__header" @click="subscribe = !subscribe">
            <div class="sub-section__title-row">
              <div
                class="sub-toggle"
                :class="{ 'sub-toggle--active': subscribe }"
                role="switch"
                :aria-checked="subscribe"
                tabindex="0"
                @keydown.enter="subscribe = !subscribe"
                @keydown.space.prevent="subscribe = !subscribe"
              >
                <div class="sub-toggle__circle"></div>
              </div>
              <div>
                <div class="sub-section__title">Subscribe & save</div>
                <div class="sub-section__subtitle">Join the Cult and get rewarded for life</div>
              </div>
            </div>
            <div class="sub-section__pricing">
              <div class="sub-section__price" x-text="formatPrice(subscriptionPrice)"></div>
              <div class="sub-section__per-pack" x-text="perPackPrice + '/pack'"></div>
            </div>
          </div>

          <!-- Benefit List -->
          <div class="sub-section__list" x-show="subscribe" x-collapse>
            <div class="sub-section__list-item">
              {%- if section.settings.sub_tick_icon != blank -%}
                <img src="{{ section.settings.sub_tick_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              {%- else -%}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              {%- endif -%}
              <span>{{ section.settings.sub_benefit_1 | default: 'Pause or cancel anytime' }}</span>
            </div>
            <div class="sub-section__list-item">
              {%- if section.settings.sub_tick_icon != blank -%}
                <img src="{{ section.settings.sub_tick_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              {%- else -%}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              {%- endif -%}
              <span>{{ section.settings.sub_benefit_2 | default: 'Change your flavours' }}</span>
            </div>
            <div class="sub-section__list-item">
              {%- if section.settings.sub_tick_icon != blank -%}
                <img src="{{ section.settings.sub_tick_icon | image_url: width: 48 }}" alt="" width="24" height="24">
              {%- else -%}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              {%- endif -%}
              <span>{{ section.settings.sub_benefit_3 | default: 'Save 20% on future orders' }}</span>
            </div>
          </div>

          <!-- Frequency Dropdown -->
          <div class="sub-section__frequency" x-show="subscribe" x-collapse>
            <select
              class="frequency-dropdown"
              x-model="selectedFrequency"
              aria-label="Delivery frequency"
            >
              <template x-for="plan in sellingPlans" :key="plan.id">
                <option :value="plan.id" x-text="plan.name.charAt(0).toUpperCase() + plan.name.slice(1).toLowerCase()"></option>
              </template>
            </select>
          </div>

          <!-- Savings Callout -->
          <div class="sub-section__savings-wrapper" x-show="subscribe" x-collapse>
            <div class="sub-section__savings">
              You're saving <span x-text="formatPrice(savings)"></span>
            </div>
          </div>
        </div>

        <!-- One-time Purchase Option -->
        <div
          class="onetime-option"
          :class="{ 'onetime-option--selected': !subscribe }"
          @click="subscribe = false"
          @keydown.enter="subscribe = false"
          @keydown.space.prevent="subscribe = false"
          tabindex="0"
          role="option"
          :aria-selected="!subscribe"
        >
          <span class="onetime-option__title">One-time purchase</span>
          <span class="onetime-option__price" x-text="formatPrice(oneTimePrice)"></span>
        </div>
      </div>

      <!-- CTA Button (Desktop) -->
      <div class="desktop-cta">
        <button
          class="cta-button cta-button--yellow"
          @click="checkout()"
          :disabled="!hasItems"
        >
          {{ section.settings.cta_button_text | default: 'Buy now' }} - <span x-text="formatPrice(displayPrice)"></span>
        </button>
      </div>

      <!-- Trust Badges -->
      <div class="trust-badges">
        <span class="trust-badge">
          <span class="trust-badge__icon">🔒</span>
          <span>Secure checkout</span>
        </span>
      </div>

    </div>
  </div>

  <!-- INFO DRAWER (single drawer, content swapped via Alpine) -->
  <x-drawer id="flavor-info-drawer" class="drawer drawer--lg" open-from="left">
    <span class="h5" slot="header" x-text="drawerFlavorName"></span>

    <!-- Gallery -->
    <div class="flavor-drawer__gallery" x-show="drawerImages.length > 0">
      <div class="flavor-drawer__images" x-ref="drawerGallery">
        <template x-for="(img, i) in drawerImages" :key="'dimg-'+i">
          <div class="flavor-drawer__image">
            <img :src="img.src" :alt="img.alt" loading="lazy">
          </div>
        </template>
      </div>
      <div class="flavor-drawer__dots" x-show="drawerImages.length > 1">
        <template x-for="(img, i) in drawerImages" :key="'ddot-'+i">
          <button
            class="flavor-drawer__dot"
            :class="{ 'flavor-drawer__dot--active': drawerImageIndex === i }"
            @click="scrollDrawerTo(i)"
          ></button>
        </template>
      </div>
    </div>

    <!-- Description -->
    <div class="flavor-drawer__description" x-text="drawerDescription"></div>

    <!-- Testimonial -->
    <div class="flavor-drawer__quote" x-show="drawerQuote">
      <blockquote>
        <p x-text="drawerQuote"></p>
      </blockquote>
      <span class="flavor-drawer__author" x-text="drawerAuthor + ', verified buyer'"></span>
    </div>

    <!-- Drawer Qty Picker -->
    <div class="flavor-drawer__qty" x-show="drawerProductId">
      <div class="qty-picker qty-picker--lg">
        <button
          class="qty-picker__btn qty-picker__btn--minus"
          @click="decrementQty(drawerProductId)"
          :disabled="getQty(drawerProductId) === 0"
          aria-label="Decrease quantity"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <span class="qty-picker__count" x-text="getQty(drawerProductId)"></span>
        <button
          class="qty-picker__btn qty-picker__btn--plus"
          @click="incrementQty(drawerProductId)"
          aria-label="Increase quantity"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
    </div>

  </x-drawer>

  <!-- Mobile Sticky CTA -->
  <div class="sticky-cta sticky-cta--basket"
    x-show="stickyCtaVisible"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="transform translate-y-full opacity-0"
    x-transition:enter-end="transform translate-y-0 opacity-100">

    <!-- Row 1: "Your box" heading + FREE DELIVERY badge -->
    <div class="sticky-cta__heading-row">
      <span class="sticky-cta__title">Your box</span>
      <span class="sticky-cta__sub-pill"
        x-show="subscribe && savings > 0"
        x-transition:enter="transition ease-out duration-150"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-100"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95">
        subscribing &amp; saving <span x-text="formatPrice(savings)"></span>
      </span>
      <div class="basket-badge basket-badge--compact"
        :class="{ 'basket-badge--unlocked': freeDelivery }"
        :style="freeDelivery
          ? 'background: {{ section.settings.free_ship_badge_bg | default: '#22c55e' }}; color: {{ section.settings.free_ship_badge_text_color | default: '#ffffff' }};'
          : 'background: transparent; border: 1.5px solid {{ section.settings.free_ship_badge_bg | default: '#22c55e' }}; color: {{ section.settings.free_ship_badge_text_color | default: '#ffffff' }};'"
      >
        {%- if section.settings.free_ship_badge_icon != blank -%}
          <img src="{{ section.settings.free_ship_badge_icon | image_url: width: 24 }}" alt="" class="basket-badge__icon">
        {%- endif -%}
        <span>{{ section.settings.free_ship_badge_text | default: 'FREE DELIVERY' }}</span>
      </div>
    </div>

    <!-- Row 2: Full-width progress bar -->
    <div class="sticky-cta__progress">
      <div class="sticky-cta__progress-fill" :style="'width: ' + deliveryProgress + '%'"></div>
    </div>

    <!-- Row 3: Size tier pills (sliding 3-tier window, read-only) -->
    <div class="sticky-cta__sizes">
      <template x-for="size in stickySizes" :key="size.id">
        <div class="sticky-cta__size-pill"
          :class="{ 'sticky-cta__size-pill--active': currentTier === size.id }">
          <span x-text="size.packs + ' packs'"></span>
        </div>
      </template>
    </div>

    <!-- Row 4: CTA button -->
    <button
      class="cta-button cta-button--yellow"
      @click="checkout()"
      :disabled="!hasItems"
    >
      {{ section.settings.cta_button_text | default: 'Checkout' }} — <span x-text="formatPrice(displayPrice)"></span>
    </button>
  </div>
</div>

<script>
  function shopPurchaseFlowV3() {
    return {
      // Product data (populated from Liquid — same pattern as v1)
      products: {
        {%- assign products_first = true -%}
        {%- assign included_product_ids = '' -%}
        {%- comment -%} First, add products from collection {%- endcomment -%}
        {%- for product in collections['breakfast'].products limit: 4 -%}
          {%- unless included_product_ids contains product.id -%}
            {%- unless products_first -%},{%- endunless -%}
            {%- assign products_first = false -%}
            {%- if included_product_ids != '' -%}{%- assign included_product_ids = included_product_ids | append: ',' -%}{%- endif -%}
            {%- assign included_product_ids = included_product_ids | append: product.id -%}
            {{ product.id }}: {
              id: {{ product.id }},
              title: {{ product.title | json }},
              handle: {{ product.handle | json }},
              isMixed: {% if product.title contains 'Mixed' %}true{% else %}false{% endif %},
              images: [
                {%- for image in product.images -%}
                  {
                    id: {{ image.id }},
                    src: {{ image.src | image_url: width: 800 | json }},
                    thumb: {{ image.src | image_url: width: 150 | json }},
                    alt: {{ image.alt | default: product.title | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              variants: {
                {%- for variant in product.variants -%}
                  {{ variant.id }}: {
                    id: {{ variant.id }},
                    title: {{ variant.title | json }},
                    price: {{ variant.price }},
                    compareAtPrice: {{ variant.compare_at_price | default: 0 }},
                    packs: {{ variant.title | remove: 'Pack' | remove: ' ' | times: 1 }},
                    sellingPlanId: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.selling_plan.id }}{% else %}null{% endif %},
                    discountPercent: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.price_adjustments.first.value | default: 0 }}{% else %}0{% endif %}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              }
            }
          {%- endunless -%}
        {%- endfor -%}
        {%- comment -%} Add products from flavor blocks that aren't already included {%- endcomment -%}
        {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
        {%- for block in flavor_blocks -%}
          {%- assign flavor_product = block.settings.product -%}
          {%- if flavor_product != blank -%}
            {%- unless included_product_ids contains flavor_product.id -%}
              {%- unless products_first -%},{%- endunless -%}
              {%- assign products_first = false -%}
              {%- if included_product_ids != '' -%}{%- assign included_product_ids = included_product_ids | append: ',' -%}{%- endif -%}
              {%- assign included_product_ids = included_product_ids | append: flavor_product.id -%}
              {{ flavor_product.id }}: {
                id: {{ flavor_product.id }},
                title: {{ flavor_product.title | json }},
                handle: {{ flavor_product.handle | json }},
                isMixed: {% if flavor_product.title contains 'Mixed' %}true{% else %}false{% endif %},
                images: [
                  {%- for image in flavor_product.images -%}
                    {
                      id: {{ image.id }},
                      src: {{ image.src | image_url: width: 800 | json }},
                      thumb: {{ image.src | image_url: width: 150 | json }},
                      alt: {{ image.alt | default: flavor_product.title | json }}
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                ],
                variants: {
                  {%- for variant in flavor_product.variants -%}
                    {{ variant.id }}: {
                      id: {{ variant.id }},
                      title: {{ variant.title | json }},
                      price: {{ variant.price }},
                      compareAtPrice: {{ variant.compare_at_price | default: 0 }},
                      packs: {{ variant.title | remove: 'Pack' | remove: ' ' | times: 1 }},
                      sellingPlanId: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.selling_plan.id }}{% else %}null{% endif %},
                      discountPercent: {% if variant.selling_plan_allocations.size > 0 %}{{ variant.selling_plan_allocations.first.price_adjustments.first.value | default: 0 }}{% else %}0{% endif %}
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                }
              }
            {%- endunless -%}
          {%- endif -%}
        {%- endfor -%}
      },

      // Block order (product IDs in schema block order, for fixed slot positions)
      blockProductIds: [
        {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
        {%- assign block_ids_first = true -%}
        {%- for block in flavor_blocks -%}
          {%- if block.settings.product != blank -%}
            {%- unless block_ids_first -%},{%- endunless -%}
            {%- assign block_ids_first = false -%}
            {{ block.settings.product.id }}
          {%- endif -%}
        {%- endfor -%}
      ],

      // Block metadata (card_image and color per block, keyed by product ID)
      blockMeta: {
        {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
        {%- assign meta_first = true -%}
        {%- for block in flavor_blocks -%}
          {%- assign bp = block.settings.product -%}
          {%- if bp != blank -%}
            {%- unless meta_first -%},{%- endunless -%}
            {%- assign meta_first = false -%}
            {{ bp.id }}: {
              name: {{ block.settings.name_override | default: bp.title | remove: 'Overnight Gut Oats |' | strip | json }},
              image: {% if block.settings.card_image != blank %}{{ block.settings.card_image | image_url: width: 400 | json }}{% elsif block.settings.card_background != blank %}{{ block.settings.card_background | image_url: width: 400 | json }}{% elsif bp.featured_image != blank %}{{ bp.featured_image | image_url: width: 400 | json }}{% else %}null{% endif %}
            }
          {%- endif -%}
        {%- endfor -%}
      },

      // ── v2 State ──────────────────────────────────────────────
      quantities: {},           // { [productId]: 0 } — populated in init()
      subscribe: true,
      discountPercent: 20,
      selectedFrequency: null,  // selling plan ID
      stickyCtaVisible: false,
      freeDeliveryThreshold: 4000, // £40 in pence

      // Drawer state
      drawerProductId: null,
      drawerIsBundle: false,
      drawerFlavorName: '',
      drawerDescription: '',
      drawerQuote: '',
      drawerAuthor: '',
      drawerImages: [],
      drawerImageIndex: 0,

      // Hero gallery state
      heroImageIndex: 0,

      // Flavor data with descriptions and testimonials (from Liquid)
      flavorData: {
        {%- assign flavor_blocks = section.blocks | where: 'type', 'flavor_option' -%}
        {%- assign flavor_data_first = true -%}
        {%- for block in flavor_blocks -%}
          {%- assign flavor_product = block.settings.product -%}
          {%- if flavor_product != blank -%}
            {%- unless flavor_data_first -%},{%- endunless -%}
            {%- assign flavor_data_first = false -%}
            {{ flavor_product.id }}: {
              displayName: {{ block.settings.name_override | default: flavor_product.title | remove: 'Overnight Gut Oats |' | strip | json }},
              description: {{ block.settings.description | default: flavor_product.description | strip_html | truncate: 300 | json }},
              testimonialQuote: {{ block.settings.testimonial_quote | default: '' | json }},
              testimonialAuthor: {{ block.settings.testimonial_author | default: 'Customer' | json }}
            }
          {%- endif -%}
        {%- endfor -%}
        {%- if flavor_blocks.size == 0 -%}
          {%- assign fallback_first = true -%}
          {%- for product in collections['breakfast'].products limit: 4 -%}
            {%- unless product.title contains 'Mixed' -%}
              {%- unless fallback_first -%},{%- endunless -%}
              {%- assign fallback_first = false -%}
              {{ product.id }}: {
                description: {{ product.description | strip_html | truncate: 300 | json }},
                testimonialQuote: "",
                testimonialAuthor: "Customer"
              }
            {%- endunless -%}
          {%- endfor -%}
        {%- endif -%}
      },

      // Selling plans (from Liquid)
      sellingPlans: [
        {%- for product in collections['breakfast'].products limit: 1 -%}
          {%- for variant in product.variants limit: 1 -%}
            {%- for allocation in variant.selling_plan_allocations -%}
              {
                id: {{ allocation.selling_plan.id }},
                name: {{ allocation.selling_plan.name | json }}
              }{% unless forloop.last %},{% endunless %}
            {%- endfor -%}
          {%- endfor -%}
        {%- endfor -%}
      ],

      // ── Size card images (Liquid-interpolated) ──────────────────
      sizeCardImages: {
        {%- for i in (1..12) -%}
          {%- assign pack_size = i | times: 9 -%}
          {%- assign setting_key = 'size_card_image_' | append: pack_size -%}
          {%- if section.settings[setting_key] != blank -%}
            {{ pack_size }}: {{ section.settings[setting_key] | image_url: width: 200 | json }},
          {%- else -%}
            {{ pack_size }}: null,
          {%- endif -%}
        {%- endfor -%}
      },

      // ── Computed (getters) ────────────────────────────────────

      /** Sum of all quantity values (number of 9-packs) */
      get totalItems() {
        return Object.values(this.quantities).reduce((sum, q) => sum + q, 0);
      },

      /** Total individual packs (each qty unit = 9 packs) */
      get totalPacks() {
        return this.totalItems * 9;
      },

      /** Total price in pence — decomposes qty into valid variants (27, 18, 9) */
      get totalPrice() {
        let total = 0;
        for (const [productId, qty] of Object.entries(this.quantities)) {
          if (qty <= 0) continue;
          for (const { variant } of this.getVariantBreakdown(productId, qty)) {
            total += variant.price;
          }
        }
        return total;
      },

      /** Price with subscription discount applied if subscribing */
      get displayPrice() {
        if (this.subscribe) {
          return Math.round(this.totalPrice * (1 - this.discountPercent / 100));
        }
        return this.totalPrice;
      },

      /** One-time price (no discount) */
      get oneTimePrice() {
        return this.totalPrice;
      },

      /** Subscription price (with discount) */
      get subscriptionPrice() {
        return Math.round(this.totalPrice * (1 - this.discountPercent / 100));
      },

      /** Savings amount in pence */
      get savings() {
        return this.oneTimePrice - this.subscriptionPrice;
      },

      /** Whether free delivery threshold is met */
      get freeDelivery() {
        return this.displayPrice >= this.freeDeliveryThreshold;
      },

      /** Remaining pence until free delivery (0 if already met) */
      get deliveryRemaining() {
        return Math.max(0, this.freeDeliveryThreshold - this.displayPrice);
      },

      /** Delivery progress bar percentage (0-100) — pack-based, caps at 27 */
      get deliveryProgress() {
        if (this.totalPacks <= 0) return 0;
        return Math.min(100, (this.totalPacks / 27) * 100);
      },

      /** Whether any items are in the basket */
      get hasItems() {
        return this.totalItems > 0;
      },

      // ── Size card getters ──────────────────────────────────

      /** Read-only size tiers — 12 cards (9 through 108) */
      get availableSizes() {
        const sizes = [];
        for (let i = 1; i <= 12; i++) sizes.push({ id: i * 9, packs: i * 9 });
        return sizes;
      },

      /** Which tier is highlighted — largest tier ≤ totalPacks */
      get currentTier() {
        const packs = this.totalPacks;
        if (packs <= 0) return null;
        const tiers = this.availableSizes.map(s => s.id);
        let tier = null;
        for (const t of tiers) { if (packs >= t) tier = t; }
        return tier;
      },

      /** 3-tier sliding window for sticky CTA size pills */
      get stickySizes() {
        const all = this.availableSizes;
        const tier = this.currentTier;
        if (!tier) return all.slice(0, 3);
        const idx = all.findIndex(s => s.id === tier);
        const start = Math.max(0, Math.min(idx - 1, all.length - 3));
        return all.slice(start, start + 3);
      },

      /** Viewport slide offset — centers active tier in 3-card window */
      get sizeViewportOffset() {
        const tier = this.currentTier;
        if (tier === null) return 0;
        const tierIndex = Math.floor(tier / 9) - 1;
        return Math.max(0, Math.min(tierIndex - 1, 9));
      },

      /** Per-pack price string (e.g. "£2.00") based on current display price */
      get perPackPrice() {
        if (this.totalPacks <= 0) return '£0.00';
        return this.formatPrice(Math.round(this.displayPrice / this.totalPacks));
      },

      // ── Methods ───────────────────────────────────────────────

      init() {
        // Populate quantities from block product IDs (all start at 0)
        for (const productId of this.blockProductIds) {
          this.quantities[productId] = 0;
        }

        // Get discount percent from first variant with a selling plan
        for (const product of Object.values(this.products)) {
          for (const variant of Object.values(product.variants)) {
            if (variant.discountPercent > 0) {
              this.discountPercent = variant.discountPercent;
              break;
            }
          }
          if (this.discountPercent !== 20) break;
        }

        // Set default frequency (prefer 4 weeks, or first available)
        if (this.sellingPlans.length > 0) {
          const fourWeekPlan = this.sellingPlans.find(p =>
            p.name.toLowerCase().includes('4 week') ||
            p.name.toLowerCase().includes('every 4')
          );
          this.selectedFrequency = fourWeekPlan ? fourWeekPlan.id : this.sellingPlans[0].id;
        }

        // Show sticky CTA immediately on mobile (always visible from page load)
        if (window.innerWidth <= 999) {
          this.stickyCtaVisible = true;

        }

        // Keep drawer inside Alpine scope so reactive bindings survive show/hide
        const drawer = document.getElementById('flavor-info-drawer');
        if (drawer) {
          Object.defineProperty(drawer, 'shouldAppendToBody', { get: () => false });
        }

        // Init hero gallery dot observer
        this.$nextTick(() => this.initHeroObserver());

        this.$watch('heroImageIndex', (idx) => {
          const strip = this.$el.querySelector('.hero-gallery__thumbs');
          const thumb = strip?.children[idx];
          if (strip && thumb) {
            thumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
          }
        });

      },

      // ── Quantity methods ──────────────────────────────────────

      incrementQty(productId) {
        const current = this.quantities[productId] || 0;
        this.quantities[productId] = current + 1;
      },

      decrementQty(productId) {
        const current = this.quantities[productId] || 0;
        if (current > 0) {
          this.quantities[productId] = current - 1;
        }
      },

      getQty(productId) {
        return this.quantities[productId] || 0;
      },

      // ── Variant helpers ───────────────────────────────────────

      /** Find the variant for a specific pack size */
      getVariantForSize(productId, packSize) {
        const product = this.products[productId];
        if (!product) return null;
        return Object.values(product.variants).find(v => v.packs === packSize) || null;
      },

      /** Break qty (in 9-pack units) into valid variant sizes (27, 18, 9) */
      getVariantBreakdown(productId, qty) {
        const totalPacks = qty * 9;
        const items = [];
        let remaining = totalPacks;
        for (const size of [27, 18, 9]) {
          while (remaining >= size) {
            const variant = this.getVariantForSize(productId, size);
            if (variant) { items.push({ variant, size }); remaining -= size; }
            else break;
          }
        }
        return items;
      },

      /** Size card pricing — decomposes into valid variants for sizes > 27 */
      getSizePrice(packSize) {
        const firstProductId = this.blockProductIds[0];
        if (!firstProductId) return 0;
        let total = 0;
        let remaining = packSize;
        for (const size of [27, 18, 9]) {
          while (remaining >= size) {
            const variant = this.getVariantForSize(firstProductId, size);
            if (variant) { total += variant.price; remaining -= size; }
            else break;
          }
        }
        return this.subscribe ? Math.round(total * (1 - this.discountPercent / 100)) : total;
      },

      // ── Hero gallery ──────────────────────────────────────

      scrollHeroTo(index) {
        this.heroImageIndex = index;
        this._heroScrolling = true;
        const track = this.$refs.heroTrack;
        if (track) {
          const slide = track.querySelectorAll('.hero-gallery__slide')[index];
          if (slide) {
            track.scrollTo({ left: slide.offsetLeft, behavior: 'smooth' });
            clearTimeout(this._heroScrollTimer);
            this._heroScrollTimer = setTimeout(() => { this._heroScrolling = false; }, 600);
          }
        }
      },

      initHeroObserver() {
        const track = this.$refs.heroTrack;
        if (!track) return;
        const observer = new IntersectionObserver((entries) => {
          for (const entry of entries) {
            if (entry.isIntersecting) {
              const slides = track.querySelectorAll('.hero-gallery__slide');
              const idx = Array.from(slides).indexOf(entry.target);
              if (idx >= 0 && !this._heroScrolling) this.heroImageIndex = idx;
            }
          }
        }, { root: track, threshold: 0.5 });
        track.querySelectorAll('.hero-gallery__slide').forEach(s => observer.observe(s));
      },

      // ── Flavor carousel (desktop) ─────────────────────────

      scrollFlavors(direction) {
        const track = this.$refs.flavorTrack;
        if (!track) return;
        const cardWidth = track.querySelector('.flavor-grid__card')?.offsetWidth || 200;
        track.scrollBy({ left: direction * (cardWidth + 12), behavior: 'smooth' });
      },

      // ── Price formatting ──────────────────────────────────────

      formatPrice(pence) {
        return '£' + (pence / 100).toFixed(2);
      },

      // ── Drawer ────────────────────────────────────────────────

      openDrawer(productId, isBundle) {
        this.drawerProductId = productId;
        this.drawerIsBundle = isBundle;

        const product = this.products[productId];
        if (!product) return;

        const data = this.flavorData[productId];
        this.drawerFlavorName = (data && data.displayName) || product.title.replace('Overnight Gut Oats |', '').trim().toUpperCase();
        this.drawerDescription = this.getFlavorDescription(productId);

        const testimonial = this.getFlavorTestimonial(productId);
        this.drawerQuote = testimonial.quote;
        this.drawerAuthor = testimonial.author;

        this.drawerImages = product.images.map((img, i) => ({
          src: img.src,
          alt: img.alt,
          id: i
        }));
        this.drawerImageIndex = 0;

        const drawer = document.getElementById('flavor-info-drawer');
        if (drawer && drawer.show) {
          drawer.show();
        }

        // Sync carousel dots with manual scroll/swipe
        this.$nextTick(() => {
          const gallery = this.$refs.drawerGallery;
          if (gallery && !gallery._dotObserver) {
            gallery._dotObserver = new IntersectionObserver((entries) => {
              for (const entry of entries) {
                if (entry.isIntersecting) {
                  const images = gallery.querySelectorAll('.flavor-drawer__image');
                  const idx = Array.from(images).indexOf(entry.target);
                  if (idx >= 0) this.drawerImageIndex = idx;
                }
              }
            }, { root: gallery, threshold: 0.5 });

            this.$nextTick(() => {
              gallery.querySelectorAll('.flavor-drawer__image').forEach(img => {
                gallery._dotObserver.observe(img);
              });
            });
          } else if (gallery && gallery._dotObserver) {
            gallery._dotObserver.disconnect();
            this.$nextTick(() => {
              gallery.querySelectorAll('.flavor-drawer__image').forEach(img => {
                gallery._dotObserver.observe(img);
              });
            });
          }
        });
      },

      scrollDrawerTo(index) {
        this.drawerImageIndex = index;
        const gallery = this.$refs.drawerGallery;
        if (gallery) {
          const imageEl = gallery.querySelectorAll('.flavor-drawer__image')[index];
          if (imageEl) {
            gallery.scrollTo({ left: imageEl.offsetLeft, behavior: 'smooth' });
          }
        }
      },

      getFlavorDescription(productId) {
        if (!productId) return '';
        const data = this.flavorData[productId];
        if (data && data.description) {
          return data.description;
        }
        const product = this.products[productId];
        return product ? product.title.replace('Overnight Gut Oats |', '').trim() + ' - delicious and nutritious.' : '';
      },

      getFlavorTestimonial(productId) {
        if (!productId) return { quote: '', author: '' };
        const data = this.flavorData[productId];
        if (data) {
          return {
            quote: data.testimonialQuote || '',
            author: data.testimonialAuthor || 'Customer'
          };
        }
        return { quote: '', author: 'Customer' };
      },

      // ── Checkout ──────────────────────────────────────────────

      async checkout() {
        if (!this.hasItems) return;

        // Build items array from quantities
        const items = [];

        const getSellingPlan = (variant) => {
          if (!this.subscribe) return null;
          if (this.selectedFrequency) return this.selectedFrequency;
          return variant.sellingPlanId;
        };

        for (const [productId, qty] of Object.entries(this.quantities)) {
          if (qty <= 0) continue;
          for (const { variant } of this.getVariantBreakdown(productId, qty)) {
            const item = { id: variant.id, quantity: 1 };
            const sellingPlan = getSellingPlan(variant);
            if (sellingPlan) {
              item.selling_plan = sellingPlan;
            }
            items.push(item);
          }
        }

        if (items.length === 0) return;

        try {
          // Clear cart
          await fetch('/cart/clear.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          // Add items
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items })
          });

          if (!response.ok) {
            const error = await response.json();
            console.error('Cart add error:', error);
            alert('Sorry, there was an error. Please try again.');
            return;
          }

          // Redirect to checkout
          window.location.href = '/checkout';
        } catch (error) {
          console.error('Checkout error:', error);
          alert('Sorry, there was an error. Please try again.');
        }
      },

    };
  }
</script>

{% schema %}
{
  "name": "Shop Purchase Flow V3",
  "tag": "section",
  "class": "shopify-section--shop-purchase-flow-v3",
  "settings": [
    {
      "type": "header",
      "content": "Hero Gallery"
    },
    {
      "type": "image_picker",
      "id": "hero_image_1",
      "label": "Hero image 1"
    },
    {
      "type": "image_picker",
      "id": "hero_image_2",
      "label": "Hero image 2"
    },
    {
      "type": "image_picker",
      "id": "hero_image_3",
      "label": "Hero image 3"
    },
    {
      "type": "image_picker",
      "id": "hero_image_4",
      "label": "Hero image 4"
    },
    {
      "type": "image_picker",
      "id": "hero_image_5",
      "label": "Hero image 5"
    },
    {
      "type": "image_picker",
      "id": "hero_image_6",
      "label": "Hero image 6"
    },
    {
      "type": "image_picker",
      "id": "hero_image_7",
      "label": "Hero image 7"
    },
    {
      "type": "image_picker",
      "id": "hero_image_8",
      "label": "Hero image 8"
    },
    {
      "type": "header",
      "content": "Header Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Overnight Gut Oats"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Delicious overnight oats. Just add milk."
    },
    {
      "type": "text",
      "id": "reviews_text",
      "label": "Reviews text",
      "default": "5.0 from 200+ reviews"
    },
    {
      "type": "image_picker",
      "id": "rating_image",
      "label": "Rating stars image",
      "info": "Upload a custom stars image (e.g., pink stars)"
    },
    {
      "type": "header",
      "content": "Flavor Selection"
    },
    {
      "type": "text",
      "id": "flavors_title",
      "label": "Flavors section title",
      "default": "Pick your flavors"
    },
    {
      "type": "text",
      "id": "size_title",
      "label": "Size section title",
      "default": "Choose your size"
    },
    {
      "type": "header",
      "content": "Badge Configuration"
    },
    {
      "type": "paragraph",
      "content": "Bestseller Badge (Flavor Cards)"
    },
    {
      "type": "text",
      "id": "bestseller_badge_text",
      "label": "Bestseller badge text",
      "default": "Best seller"
    },
    {
      "type": "color",
      "id": "bestseller_badge_bg",
      "label": "Bestseller badge background",
      "default": "#fbbf24"
    },
    {
      "type": "color",
      "id": "bestseller_badge_text_color",
      "label": "Bestseller badge text color",
      "default": "#000000"
    },
    {
      "type": "image_picker",
      "id": "bestseller_badge_icon",
      "label": "Bestseller badge icon",
      "info": "Small image displayed left of badge text"
    },
    {
      "type": "paragraph",
      "content": "Popular Badge (Size Cards)"
    },
    {
      "type": "text",
      "id": "popular_badge_text",
      "label": "Popular badge text",
      "default": "Popular"
    },
    {
      "type": "color",
      "id": "popular_badge_bg",
      "label": "Popular badge background",
      "default": "#fbbf24"
    },
    {
      "type": "color",
      "id": "popular_badge_text_color",
      "label": "Popular badge text color",
      "default": "#000000"
    },
    {
      "type": "image_picker",
      "id": "popular_badge_icon",
      "label": "Popular badge icon",
      "info": "Star icon for Popular badge"
    },
    {
      "type": "paragraph",
      "content": "Free Shipping Badge (Basket)"
    },
    {
      "type": "text",
      "id": "free_ship_badge_text",
      "label": "Free shipping badge text",
      "default": "FREE"
    },
    {
      "type": "color",
      "id": "free_ship_badge_bg",
      "label": "Free shipping badge background",
      "default": "#22c55e"
    },
    {
      "type": "color",
      "id": "free_ship_badge_text_color",
      "label": "Free shipping badge text color",
      "default": "#ffffff"
    },
    {
      "type": "image_picker",
      "id": "free_ship_badge_icon",
      "label": "Free shipping badge icon",
      "info": "Truck icon for free shipping badge"
    },
    {
      "type": "paragraph",
      "content": "Subscription Benefit Card Banner"
    },
    {
      "type": "text",
      "id": "sub_benefit_badge_text",
      "label": "Subscription banner text",
      "default": "All orders"
    },
    {
      "type": "color",
      "id": "sub_benefit_badge_bg",
      "label": "Subscription banner background",
      "default": "#ff6b35"
    },
    {
      "type": "color",
      "id": "sub_benefit_badge_text_color",
      "label": "Subscription banner text color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Box Size Images"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_9",
      "label": "9-pack image",
      "info": "Stacked product image for 9-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_18",
      "label": "18-pack image",
      "info": "Stacked product image for 18-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_27",
      "label": "27-pack image",
      "info": "Stacked product image for 27-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_36",
      "label": "36-pack image",
      "info": "Stacked product image for 36-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_45",
      "label": "45-pack image",
      "info": "Stacked product image for 45-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_54",
      "label": "54-pack image",
      "info": "Stacked product image for 54-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_63",
      "label": "63-pack image",
      "info": "Stacked product image for 63-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_72",
      "label": "72-pack image",
      "info": "Stacked product image for 72-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_81",
      "label": "81-pack image",
      "info": "Stacked product image for 81-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_90",
      "label": "90-pack image",
      "info": "Stacked product image for 90-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_99",
      "label": "99-pack image",
      "info": "Stacked product image for 99-pack option"
    },
    {
      "type": "image_picker",
      "id": "size_card_image_108",
      "label": "108-pack image",
      "info": "Stacked product image for 108-pack option"
    },
    {
      "type": "header",
      "content": "Subscription"
    },
    {
      "type": "image_picker",
      "id": "sub_tick_icon",
      "label": "Tick icon",
      "info": "Custom checkmark icon for benefit list"
    },
    {
      "type": "text",
      "id": "sub_benefit_1",
      "label": "Benefit 1",
      "default": "Pause or cancel anytime"
    },
    {
      "type": "text",
      "id": "sub_benefit_2",
      "label": "Benefit 2",
      "default": "Change your flavours"
    },
    {
      "type": "text",
      "id": "sub_benefit_3",
      "label": "Benefit 3",
      "default": "Save 20% on future orders"
    },
    {
      "type": "header",
      "content": "Subscription Benefit Cards"
    },
    {
      "type": "image_picker",
      "id": "sub_benefit_card_1",
      "label": "20% OFF card image",
      "info": "Image for the '20% OFF ALWAYS' benefit card"
    },
    {
      "type": "image_picker",
      "id": "sub_benefit_card_2_unlocked",
      "label": "Free Delivery - Unlocked",
      "info": "Image shown when free shipping is unlocked (order ≥ £40)"
    },
    {
      "type": "image_picker",
      "id": "sub_benefit_card_2_locked",
      "label": "Free Delivery - Locked",
      "info": "Pre-blurred image shown when free shipping is locked (order < £40)"
    },
    {
      "type": "header",
      "content": "Checkout Button"
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "Checkout button text",
      "default": "Buy now"
    },
    {
      "type": "header",
      "content": "Selected State Styling"
    },
    {
      "type": "color",
      "id": "selected_background",
      "label": "Selected background",
      "default": "#D8F7FF"
    },
    {
      "type": "color",
      "id": "selected_border",
      "label": "Selected border",
      "default": "#6CDFFF"
    },
    {
      "type": "color",
      "id": "selected_text",
      "label": "Selected text color",
      "default": "#000000",
      "info": "Text color for selected options"
    },
  ],
  "blocks": [
    {
      "type": "flavor_option",
      "name": "Flavor Option",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "checkbox",
          "id": "is_bundle",
          "label": "Bundle option (mutually exclusive)",
          "default": false,
          "info": "When selected, deselects all other options. Use for mixed/variety packs."
        },
        {
          "type": "image_picker",
          "id": "card_image",
          "label": "Card image",
          "info": "Product image displayed on the card"
        },
        {
          "type": "image_picker",
          "id": "card_background",
          "label": "Card background",
          "info": "Full-bleed background image (optional)"
        },
        {
          "type": "text",
          "id": "name_override",
          "label": "Display name",
          "info": "Overrides product title on the card"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Subtitle",
          "info": "Text below the name (e.g., 'All 3' for mixed box)"
        },
        {
          "type": "checkbox",
          "id": "show_badge",
          "label": "Show badge",
          "default": false
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "info": "Shown when this option's tab is active"
        },
        {
          "type": "header",
          "content": "Pill Styling"
        },
        {
          "type": "color",
          "id": "pill_selected_bg",
          "label": "Selected background",
          "default": "#3C1B04"
        },
        {
          "type": "color",
          "id": "pill_selected_text",
          "label": "Selected text",
          "default": "#FFFFFF"
        },
        {
          "type": "color",
          "id": "pill_selected_border",
          "label": "Selected border",
          "default": "#3C1B04"
        },
        {
          "type": "header",
          "content": "Testimonial"
        },
        {
          "type": "text",
          "id": "testimonial_quote",
          "label": "Quote"
        },
        {
          "type": "text",
          "id": "testimonial_author",
          "label": "Author"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shop Purchase Flow",
      "blocks": [
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": true,
            "name_override": "The Cult Mix",
            "subtitle": "All 3",
            "show_badge": true,
            "description": "All 3 flavors in one box — can't decide? This is the one for you."
          }
        },
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": false,
            "name_override": "Cacao",
            "description": "Rich chocolate oats for a satisfying start."
          }
        },
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": false,
            "name_override": "Strawberry",
            "description": "Sweet strawberry goji for a fruity morning."
          }
        },
        {
          "type": "flavor_option",
          "settings": {
            "is_bundle": false,
            "name_override": "Cinnamon",
            "description": "Warming cinnamon spice for cozy mornings."
          }
        }
      ]
    }
  ]
}
{% endschema %}
